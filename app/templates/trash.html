{% extends "base.html" %}

{% block title %}–ö–æ—Ä–∑–∏–Ω–∞ - –ú–ù–¢ Generator{% endblock %}

{% block content %}
<!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± —É—Å–ø–µ—Ö–µ/–æ—à–∏–±–∫–∞—Ö -->
{% if success_message %}
<div class="alert alert-success alert-dismissible fade show" role="alert">
    <strong>‚úì –£—Å–ø–µ—à–Ω–æ!</strong> –ú–ù–¢ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}

{% if error_message %}
<div class="alert alert-danger alert-dismissible fade show" role="alert">
    <strong>‚úó –û—à–∏–±–∫–∞!</strong> {{ error_message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>üóëÔ∏è –ö–æ—Ä–∑–∏–Ω–∞</h1>
    <div>
        <a href="/mnt/list" class="btn btn-outline-secondary">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
    </div>
</div>

<div class="alert alert-warning">
    <strong>‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</strong> –ó–¥–µ—Å—å –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —É–¥–∞–ª–µ–Ω–Ω—ã–µ –ú–ù–¢. –û–Ω–∏ –±—É–¥—É—Ç –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ —É–¥–∞–ª–µ–Ω—ã —á–µ—Ä–µ–∑ 30 –¥–Ω–µ–π –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è.
    –ó–∞ —ç—Ç–æ –≤—Ä–µ–º—è –≤—ã –º–æ–∂–µ—Ç–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ª—é–±–æ–π –ú–ù–¢, –∏ –æ–Ω –±—É–¥–µ—Ç –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω –≤ Confluence (–µ—Å–ª–∏ –±—ã–ª –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω).
</div>

<!-- –ü–æ–∏—Å–∫ -->
<form method="get" action="/mnt/trash" class="mb-4">
    <div class="card mb-3">
        <div class="card-header">
            <h5 class="mb-0">–ü–æ–∏—Å–∫</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-8">
                    <label for="search" class="form-label">–ü–æ–∏—Å–∫</label>
                    <input type="text" 
                           class="form-control" 
                           id="search"
                           name="search" 
                           placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ, –ø—Ä–æ–µ–∫—Ç, –∞–≤—Ç–æ—Ä..." 
                           value="{{ search_query }}">
                </div>
                
                <div class="col-md-2">
                    <label for="sort_by" class="form-label">–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ</label>
                    <select class="form-select" id="sort_by" name="sort_by">
                        <option value="deleted_at" {% if sort_by == 'deleted_at' %}selected{% endif %}>–î–∞—Ç–µ —É–¥–∞–ª–µ–Ω–∏—è</option>
                        <option value="created_at" {% if sort_by == 'created_at' %}selected{% endif %}>–î–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è</option>
                        <option value="updated_at" {% if sort_by == 'updated_at' %}selected{% endif %}>–ü–æ—Å–ª–µ–¥–Ω–µ–º—É –∏–∑–º–µ–Ω–µ–Ω–∏—é</option>
                        <option value="title" {% if sort_by == 'title' %}selected{% endif %}>–ù–∞–∑–≤–∞–Ω–∏—é</option>
                    </select>
                </div>
                
                <div class="col-md-2">
                    <label for="sort_order" class="form-label">–ü–æ—Ä—è–¥–æ–∫</label>
                    <select class="form-select" id="sort_order" name="sort_order">
                        <option value="desc" {% if sort_order == 'desc' %}selected{% endif %}>–ü–æ —É–±—ã–≤–∞–Ω–∏—é</option>
                        <option value="asc" {% if sort_order == 'asc' %}selected{% endif %}>–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</option>
                    </select>
                </div>
            </div>
            
            <div class="mt-3">
                <button type="submit" class="btn btn-primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
                {% if search_query %}
                <a href="/mnt/trash" class="btn btn-outline-secondary">–°–±—Ä–æ—Å–∏—Ç—å</a>
                {% endif %}
            </div>
        </div>
    </div>
</form>

<div class="alert alert-info">
    –í—Å–µ–≥–æ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –ú–ù–¢: <strong>{{ total }}</strong>
    {% if search_query %}
    (–Ω–∞–π–¥–µ–Ω–æ –ø–æ —Ñ–∏–ª—å—Ç—Ä–∞–º)
    {% endif %}
</div>

{% if documents %}
<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>ID</th>
                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th>–ü—Ä–æ–µ–∫—Ç</th>
                <th>–ê–≤—Ç–æ—Ä</th>
                <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                <th>–î–∞—Ç–∞ —É–¥–∞–ª–µ–Ω–∏—è</th>
                <th>–°—Ç–∞—Ç—É—Å –Ω–∞ –º–æ–º–µ–Ω—Ç —É–¥–∞–ª–µ–Ω–∏—è</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody>
            {% for doc in documents %}
            <tr>
                <td>{{ doc.id }}</td>
                <td>
                    <strong>{{ doc.title or '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è' }}</strong>
                    {% if doc.data_json.tags %}
                    <div class="mt-1">
                        {% for tag in doc.data_json.tags %}
                        <span class="badge bg-secondary me-1">{{ tag }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}
                </td>
                <td>{{ doc.project }}</td>
                <td>{{ doc.author }}</td>
                <td>
                    {% if doc.created_at %}
                    {{ doc.created_at.strftime('%d.%m.%Y %H:%M') }}
                    {% else %}
                    -
                    {% endif %}
                </td>
                <td>
                    {% if doc.deleted_at %}
                    <strong class="text-danger">{{ doc.deleted_at.strftime('%d.%m.%Y %H:%M') }}</strong>
                    {% else %}
                    -
                    {% endif %}
                </td>
                <td>
                    {% if doc.status == 'published' %}
                    <span class="badge bg-success">–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω</span>
                    {% elif doc.status == 'draft' %}
                    <span class="badge bg-secondary">–ß–µ—Ä–Ω–æ–≤–∏–∫</span>
                    {% elif doc.status == 'error' %}
                    <span class="badge bg-danger">–û—à–∏–±–∫–∞</span>
                    {% else %}
                    <span class="badge bg-secondary">{{ doc.status }}</span>
                    {% endif %}
                </td>
                <td>
                    <form method="post" action="/mnt/{{ doc.id }}/restore" style="display: inline;" 
                          onsubmit="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —ç—Ç–æ—Ç –ú–ù–¢? –°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤ Confluence –±—É–¥–µ—Ç –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∞, –µ—Å–ª–∏ –æ–Ω–∞ –±—ã–ª–∞ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞.');">
                        <button type="submit" class="btn btn-sm btn-success" title="–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ú–ù–¢">
                            ‚ôªÔ∏è –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                        </button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
{% if total > limit %}
<nav aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º">
    <ul class="pagination justify-content-center">
        {% if skip > 0 %}
        <li class="page-item">
            <a class="page-link" href="?skip={{ skip - limit }}&limit={{ limit }}{% if search_query %}&search={{ search_query }}{% endif %}{% if sort_by %}&sort_by={{ sort_by }}{% endif %}{% if sort_order %}&sort_order={{ sort_order }}{% endif %}">–ü—Ä–µ–¥—ã–¥—É—â–∞—è</a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <span class="page-link">–ü—Ä–µ–¥—ã–¥—É—â–∞—è</span>
        </li>
        {% endif %}
        
        {% set current_page = (skip // limit) + 1 %}
        {% set total_pages = (total // limit) + (1 if total % limit > 0 else 0) %}
        
        {% for page_num in range(1, total_pages + 1) %}
            {% if page_num == current_page %}
            <li class="page-item active">
                <span class="page-link">{{ page_num }}</span>
            </li>
            {% elif page_num <= 3 or page_num >= total_pages - 2 or (page_num >= current_page - 1 and page_num <= current_page + 1) %}
            <li class="page-item">
                <a class="page-link" href="?skip={{ (page_num - 1) * limit }}&limit={{ limit }}{% if search_query %}&search={{ search_query }}{% endif %}{% if sort_by %}&sort_by={{ sort_by }}{% endif %}{% if sort_order %}&sort_order={{ sort_order }}{% endif %}">{{ page_num }}</a>
            </li>
            {% elif page_num == 4 and current_page > 5 %}
            <li class="page-item disabled">
                <span class="page-link">...</span>
            </li>
            {% elif page_num == total_pages - 3 and current_page < total_pages - 4 %}
            <li class="page-item disabled">
                <span class="page-link">...</span>
            </li>
            {% endif %}
        {% endfor %}
        
        {% if skip + limit < total %}
        <li class="page-item">
            <a class="page-link" href="?skip={{ skip + limit }}&limit={{ limit }}{% if search_query %}&search={{ search_query }}{% endif %}{% if sort_by %}&sort_by={{ sort_by }}{% endif %}{% if sort_order %}&sort_order={{ sort_order }}{% endif %}">–°–ª–µ–¥—É—é—â–∞—è</a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <span class="page-link">–°–ª–µ–¥—É—é—â–∞—è</span>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

{% else %}
<div class="alert alert-info">
    <strong>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞.</strong> –£–¥–∞–ª–µ–Ω–Ω—ã–µ –ú–ù–¢ –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å –≤ —Ç–µ—á–µ–Ω–∏–µ 30 –¥–Ω–µ–π.
</div>
{% endif %}

{% endblock %}
