{% extends "base.html" %}

{% block title %}Создать МНТ - МНТ Generator{% endblock %}

{% block breadcrumbs %}
    <nav aria-label="breadcrumb" class="bg-light border-bottom py-2">
        <div class="container-fluid">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="/">Главная</a></li>
                <li class="breadcrumb-item"><a href="/mnt/list">Список МНТ</a></li>
                <li class="breadcrumb-item active">Создать МНТ</li>
            </ol>
        </div>
    </nav>
{% endblock %}

{% block navigation %}
<nav class="form-navigation">
    <h5>Навигация</h5>
    <div class="nav-container">
        <div class="nav-section">
            <a href="#section-header" class="nav-item">Заголовок документа</a>
        </div>
        <div class="nav-section">
            <a href="#section-1" class="nav-item">1. История изменений</a>
        </div>
        <div class="nav-section">
            <a href="#section-2" class="nav-item">2. Лист согласования</a>
        </div>
        <div class="nav-section">
            <a href="#section-3" class="nav-item">3. Сокращения и терминология</a>
            <a href="#section-3-1" class="nav-item nav-subsection">3.1 Сокращения</a>
            <a href="#section-3-2" class="nav-item nav-subsection">3.2 Терминология</a>
        </div>
        <div class="nav-section">
            <a href="#section-4" class="nav-item">4. Введение</a>
        </div>
        <div class="nav-section">
            <a href="#section-5" class="nav-item">5. Цели и задачи НТ</a>
            <a href="#section-5-1" class="nav-item nav-subsection">5.1 Цели НТ</a>
            <a href="#section-5-2" class="nav-item nav-subsection">5.2 Задачи НТ</a>
        </div>
        <div class="nav-section">
            <a href="#section-6" class="nav-item">6. Ограничения и риски НТ</a>
            <a href="#section-6-1" class="nav-item nav-subsection">6.1 Ограничения НТ</a>
            <a href="#section-6-2" class="nav-item nav-subsection">6.2 Риски НТ</a>
        </div>
        <div class="nav-section">
            <a href="#section-7" class="nav-item">7. Объект НТ</a>
            <a href="#section-7-1" class="nav-item nav-subsection">7.1 Общие сведения</a>
            <a href="#section-7-2" class="nav-item nav-subsection">7.2 Требования к производительности</a>
            <a href="#section-7-3" class="nav-item nav-subsection">7.3 Архитектура системы</a>
        </div>
        <div class="nav-section">
            <a href="#section-8" class="nav-item">8. Тестовый и промышленный стенды</a>
            <a href="#section-8-1" class="nav-item nav-subsection">8.1 Архитектура тестового стенда</a>
            <a href="#section-8-2" class="nav-item nav-subsection">8.2 Сравнение конфигураций</a>
        </div>
        <div class="nav-section">
            <a href="#section-9" class="nav-item">9. Стратегия тестирования</a>
            <a href="#section-9-1" class="nav-item nav-subsection">9.1 Описание планируемых тестов</a>
            <a href="#section-9-2" class="nav-item nav-subsection">9.2 Условия завершения НТ</a>
        </div>
        <div class="nav-section">
            <a href="#section-10" class="nav-item">10. Наполнение БД</a>
        </div>
        <div class="nav-section">
            <a href="#section-11" class="nav-item">11. Моделирование нагрузки</a>
            <a href="#section-11-1" class="nav-item nav-subsection">11.1 Общие принципы</a>
            <a href="#section-11-2" class="nav-item nav-subsection">11.2 Профили нагрузки</a>
            <a href="#section-11-3" class="nav-item nav-subsection">11.3 Сценарии использования</a>
            <a href="#section-11-4" class="nav-item nav-subsection">11.4 Описание работы эмуляторов</a>
        </div>
        <div class="nav-section">
            <a href="#section-12" class="nav-item">12. Мониторинг</a>
            <a href="#section-12-1" class="nav-item nav-subsection">12.1 Описание средств мониторинга</a>
            <a href="#section-12-2" class="nav-item nav-subsection">12.2 Описание метрик мониторинга</a>
        </div>
        <div class="nav-section">
            <a href="#section-13" class="nav-item">13. Требования к Заказчику</a>
        </div>
        <div class="nav-section">
            <a href="#section-14" class="nav-item">14. Материалы, подлежащие сдаче</a>
        </div>
        <div class="nav-section">
            <a href="#section-15" class="nav-item">15. Контакты</a>
        </div>
        <div class="nav-section">
            <a href="#section-tags" class="nav-item">Теги</a>
        </div>
        <div class="nav-section">
            <a href="#section-confluence" class="nav-item">Публикация в Confluence</a>
        </div>
    </div>
</nav>
{% endblock %}

{% block content %}
<h1 class="mb-4">Создать новый МНТ</h1>

{% if error_message %}
<div class="alert alert-danger alert-dismissible fade show mb-4" role="alert">
    <strong>⚠ Ошибка:</strong> {{ error_message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

<form method="post" action="/mnt/create" enctype="multipart/form-data">
    
    <!-- Заголовок документа -->
    <div class="form-section" id="section-header">
        <h3>Заголовок документа</h3>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="project_name" class="form-label">Название проекта <span class="text-danger">*</span></label>
                <textarea class="form-control" id="project_name" name="project_name" rows="2" required>{{ data.project_name if data else '' }}</textarea>
            </div>
            <div class="col-md-6 mb-3">
                <label for="organization_name" class="form-label">Название компании <span class="text-danger">*</span></label>
                <textarea class="form-control" id="organization_name" name="organization_name" rows="2" required>{{ data.organization_name if data else 'УК «Первая»' }}</textarea>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="system_version" class="form-label">Версия системы <span class="text-danger">*</span></label>
                <textarea class="form-control" id="system_version" name="system_version" rows="2" required placeholder="Например: 1.0">{{ data.system_version if data else '' }}</textarea>
            </div>
            <div class="col-md-6 mb-3">
                <label for="author" class="form-label">Автор (для истории изменений) <span class="text-danger">*</span></label>
                <textarea class="form-control" id="author" name="author" rows="2" required placeholder="Укажите ФИО автора (Фамилия И.О.)">{{ data.author if data else '' }}</textarea>
            </div>
        </div>
    </div>

    <!-- Раздел 1: История изменений -->
    <div class="form-section" id="section-1">
        <h3>1. История изменений</h3>
        <div class="mb-3">
            <label class="form-label">Таблица истории изменений</label>
            <small class="text-muted d-block mb-2">Дата, версия и автор заполняются автоматически. Укажите описание изменений.</small>
            
            <!-- Скрытое поле для отправки данных на сервер -->
            <input type="hidden" id="history_changes_table" name="history_changes_table">
            
            <!-- Визуальная таблица с редактируемым полем описания -->
            <div class="table-responsive">
                <table class="table table-bordered" id="history_changes_visual_table">
                    <thead>
                        <tr>
                            <th style="width: 20%;">Дата</th>
                            <th style="width: 10%;">Версия</th>
                            <th style="width: 50%;">Описание</th>
                            <th style="width: 20%;">Автор</th>
                        </tr>
                    </thead>
                    <tbody id="history_changes_tbody">
                        <!-- Заполняется автоматически через JavaScript -->
                    </tbody>
                </table>
            </div>
            <small class="text-muted d-block mt-1">При создании МНТ будет автоматически добавлена первая запись с версией 0.1</small>
        </div>
    </div>

    <!-- Раздел 2: Лист согласования -->
    <div class="form-section" id="section-2">
        <h3>2. Лист согласования</h3>
        <div class="mb-3">
            <label for="approval_list_table" class="form-label">Таблица листа согласования</label>
            <small class="text-muted d-block mb-2">Поля ФИО, Должность и Дата обязательны для заполнения. Подпись заполняется позже. Для добавления новой строки нажмите кнопку "Добавить строку".</small>
            
            <!-- Скрытое поле для отправки данных на сервер -->
            <input type="hidden" id="approval_list_table" name="approval_list_table" value="">
            
            <!-- Визуальная таблица с input полями -->
            <div class="table-responsive">
                <table class="table table-bordered" id="approval_list_visual_table">
                    <thead>
                        <tr>
                            <th style="width: 22%;">ФИО <span class="text-danger">*</span></th>
                            <th style="width: 22%;">Должность <span class="text-danger">*</span></th>
                            <th style="width: 22%;">Подпись</th>
                            <th style="width: 20%;">Дата <span class="text-danger">*</span></th>
                            <th style="width: 14%; text-align: center;">Действия</th>
                        </tr>
                    </thead>
                    <tbody id="approval_list_tbody">
                        <!-- Заполняется автоматически через JavaScript -->
                    </tbody>
                </table>
            </div>
            <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="add_approval_row_btn">
                <i class="bi bi-plus-circle"></i> Добавить строку
            </button>
        </div>
    </div>

    <!-- Раздел 3: Сокращения и терминология -->
    <div class="form-section" id="section-3">
        <h3>3. Сокращения и терминология</h3>
        
        <h4 class="mt-3 mb-3" id="section-3-1">3.1 Сокращения</h4>
        <div class="mb-3">
            <label for="abbreviations_table" class="form-label">Таблица сокращений</label>
            <small class="text-muted d-block mb-2">Для добавления новой строки нажмите кнопку "Добавить строку".</small>
            
            <!-- Скрытое поле для отправки данных на сервер -->
            <input type="hidden" id="abbreviations_table" name="abbreviations_table" value="{{ data.abbreviations_table if data else '' }}">
            
            <!-- Визуальная таблица с input полями -->
            <div class="table-responsive">
                <table class="table table-bordered" id="abbreviations_visual_table">
                    <thead>
                        <tr>
                            <th style="width: 40%;">Наименование сокращения <span class="text-danger">*</span></th>
                            <th style="width: 55%;">Описание <span class="text-danger">*</span></th>
                            <th style="width: 5%; text-align: center;">Действия</th>
                        </tr>
                    </thead>
                    <tbody id="abbreviations_tbody">
                        <!-- Заполняется автоматически через JavaScript -->
                    </tbody>
                </table>
            </div>
            <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="add_abbreviation_row_btn">
                <i class="bi bi-plus-circle"></i> Добавить строку
            </button>
        </div>

        <h4 class="mt-3 mb-3" id="section-3-2">3.2 Терминология</h4>
        <div class="mb-3">
            <label for="terminology_table" class="form-label">Таблица терминологии</label>
            <small class="text-muted d-block mb-2">Для добавления новой строки нажмите кнопку "Добавить строку".</small>
            
            <!-- Скрытое поле для отправки данных на сервер -->
            <input type="hidden" id="terminology_table" name="terminology_table" value="{{ data.terminology_table if data else '' }}">
            
            <!-- Визуальная таблица с input полями -->
            <div class="table-responsive">
                <table class="table table-bordered" id="terminology_visual_table">
                    <thead>
                        <tr>
                            <th style="width: 40%;">Термин <span class="text-danger">*</span></th>
                            <th style="width: 55%;">Определение <span class="text-danger">*</span></th>
                            <th style="width: 5%; text-align: center;">Действия</th>
                        </tr>
                    </thead>
                    <tbody id="terminology_tbody">
                        <!-- Заполняется автоматически через JavaScript -->
                    </tbody>
                </table>
            </div>
            <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="add_terminology_row_btn">
                <i class="bi bi-plus-circle"></i> Добавить строку
            </button>
        </div>
    </div>

    <!-- Раздел 4: Введение -->
    <div class="form-section" id="section-4">
        <h3>4. Введение</h3>
        <div class="mb-3">
            <label for="introduction_text" class="form-label">Текст введения</label>
            <textarea class="form-control" id="introduction_text" name="introduction_text" rows="10">{{ data.introduction_text if data else '' }}</textarea>
        </div>
    </div>

    <!-- Раздел 5: Цели и задачи НТ -->
    <div class="form-section" id="section-5">
        <h3>5. Цели и задачи НТ</h3>
        
        <h4 class="mt-3 mb-3" id="section-5-1">5.1 Цели НТ</h4>
        <div class="mb-3">
            <label for="goals_business" class="form-label">Бизнес-цели (каждый пункт с новой строки)</label>
            <textarea class="form-control" id="goals_business" name="goals_business" rows="5">{{ data.goals_business if data else '' }}</textarea>
        </div>
        <div class="mb-3">
            <label for="goals_technical" class="form-label">Технические цели (каждый пункт с новой строки)</label>
            <textarea class="form-control" id="goals_technical" name="goals_technical" rows="5">{{ data.goals_technical if data else '' }}</textarea>
        </div>

        <h4 class="mt-3 mb-3" id="section-5-2">5.2 Задачи НТ</h4>
        <div class="mb-3">
            <label for="tasks_nt" class="form-label">Список задач НТ (каждая задача с новой строки, можно нумеровать)</label>
            <textarea class="form-control" id="tasks_nt" name="tasks_nt" rows="10">{{ data.tasks_nt if data else '' }}</textarea>
        </div>
    </div>

    <!-- Раздел 6: Ограничения и риски НТ -->
    <div class="form-section" id="section-6">
        <h3>6. Ограничения и риски НТ</h3>
        
        <h4 class="mt-3 mb-3" id="section-6-1">6.1 Ограничения НТ</h4>
        <div class="mb-3">
            <label for="limitations_list" class="form-label">Список ограничений НТ (каждое ограничение с новой строки)</label>
            <textarea class="form-control" id="limitations_list" name="limitations_list" rows="15">{{ data.limitations_list if data else '' }}</textarea>
        </div>

        <h4 class="mt-3 mb-3" id="section-6-2">6.2 Риски НТ</h4>
        <div class="mb-3">
            <label for="risks_table" class="form-label">Таблица рисков НТ</label>
            <small class="text-muted d-block mb-2">Для добавления новой строки нажмите кнопку "Добавить строку".</small>
            
            <!-- Скрытое поле для отправки данных на сервер -->
            <input type="hidden" id="risks_table" name="risks_table" value="{{ data.risks_table if data else '' }}">
            
            <!-- Визуальная таблица с input полями -->
            <div class="table-responsive">
                <table class="table table-bordered" id="risks_visual_table">
                    <thead>
                        <tr>
                            <th style="width: 50%;">Риск <span class="text-danger">*</span></th>
                            <th style="width: 25%;">Вероятность возникновения <span class="text-danger">*</span></th>
                            <th style="width: 20%;">Влияние <span class="text-danger">*</span></th>
                            <th style="width: 5%; text-align: center;">Действия</th>
                        </tr>
                    </thead>
                    <tbody id="risks_tbody">
                        <!-- Заполняется автоматически через JavaScript -->
                    </tbody>
                </table>
            </div>
            <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="add_risk_row_btn">
                <i class="bi bi-plus-circle"></i> Добавить строку
            </button>
        </div>
    </div>

    <!-- Раздел 7: Объект НТ -->
    <div class="form-section" id="section-7">
        <h3>7. Объект НТ</h3>
        
        <h4 class="mt-3 mb-3" id="section-7-1">7.1 Общие сведения</h4>
        <div class="mb-3">
            <label for="object_general" class="form-label">Общие сведения об объекте НТ</label>
            <textarea class="form-control" id="object_general" name="object_general" rows="3">{{ data.object_general if data else '' }}</textarea>
        </div>

        <h4 class="mt-3 mb-3" id="section-7-2">7.2 Требования к производительности</h4>
        <div class="mb-3">
            <label for="performance_requirements" class="form-label">Список требований к производительности (каждое требование с новой строки)</label>
            <textarea class="form-control" id="performance_requirements" name="performance_requirements" rows="6">{{ data.performance_requirements if data else '' }}</textarea>
        </div>

        <h4 class="mt-3 mb-3" id="section-7-3">7.3 Архитектура системы</h4>
        
        <h5 class="mt-2 mb-2">7.3.1 Компонентная архитектура</h5>
        <div class="mb-3">
            <label for="component_architecture_text" class="form-label">Текст описания компонентной архитектуры (каждый компонент с новой строки) <span class="text-danger">*</span></label>
            <textarea class="form-control required-field" id="component_architecture_text" name="component_architecture_text" rows="6" required>{% if data and data.get('component_architecture_text') %}{{ data.component_architecture_text }}{% else %}Компонентная архитектура состоит из следующих частей:
•-
•-
•-{% endif %}</textarea>
        </div>
        <div class="mb-3">
            <label for="component_architecture_image_file" class="form-label">Изображение компонентной архитектуры (Рисунок 1)</label>
            <input type="file" class="form-control" id="component_architecture_image_file" name="component_architecture_image_file" accept="image/*">
        </div>

        <h5 class="mt-3 mb-2">7.3.2 Информационная архитектура</h5>
        <div class="mb-3">
            <label for="information_architecture_image_file" class="form-label">Изображение информационной архитектуры (Рисунок 2)</label>
            <input type="file" class="form-control" id="information_architecture_image_file" name="information_architecture_image_file" accept="image/*">
        </div>
    </div>

    <!-- Раздел 8: Тестовый и промышленный стенды -->
    <div class="form-section" id="section-8">
        <h3>8. Тестовый и промышленный стенды</h3>
        
        <h4 class="mt-3 mb-3" id="section-8-1">8.1 Архитектура тестового стенда</h4>
        <div class="mb-3">
            <label for="test_stand_architecture_text" class="form-label">Описание архитектуры тестового стенда</label>
            <textarea class="form-control" id="test_stand_architecture_text" name="test_stand_architecture_text" rows="4">{{ data.test_stand_architecture_text if data else '' }}</textarea>
        </div>

        <h4 class="mt-3 mb-3" id="section-8-2">8.2 Сравнение конфигураций промышленной среды и тестового стенда</h4>
        <div class="mb-3">
            <label for="stand_comparison_table" class="form-label">Таблица сравнения конфигураций</label>
            <small class="text-muted d-block mb-2">Для добавления новой строки нажмите кнопку "Добавить строку".</small>
            
            <!-- Скрытое поле для отправки данных на сервер -->
            <input type="hidden" id="stand_comparison_table" name="stand_comparison_table" value="{{ data.stand_comparison_table if data else '' }}">
            
            <!-- Визуальная таблица с input полями -->
            <div class="table-responsive">
                <table class="table table-bordered" id="stand_comparison_visual_table">
                    <thead>
                        <tr>
                            <th style="width: 25%;">Система <span class="text-danger">*</span></th>
                            <th style="width: 25%;">Параметр <span class="text-danger">*</span></th>
                            <th style="width: 25%;">Значение на UAT контуре <span class="text-danger">*</span></th>
                            <th style="width: 20%;">Значение на продуктивной среде <span class="text-danger">*</span></th>
                            <th style="width: 5%; text-align: center;">Действия</th>
                        </tr>
                    </thead>
                    <tbody id="stand_comparison_tbody">
                        <!-- Заполняется автоматически через JavaScript -->
                    </tbody>
                </table>
            </div>
            <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="add_stand_comparison_row_btn">
                <i class="bi bi-plus-circle"></i> Добавить строку
            </button>
        </div>
    </div>

    <!-- Раздел 9: Стратегия тестирования -->
    <div class="form-section" id="section-9">
        <h3>9. Стратегия тестирования</h3>
        
        <div class="mb-3">
            <label for="planned_tests_intro" class="form-label">Вводный текст</label>
            <textarea class="form-control" id="planned_tests_intro" name="planned_tests_intro" rows="3">{{ data.planned_tests_intro if data else '' }}</textarea>
        </div>
        
        <h4 class="mt-3 mb-3" id="section-9-1">9.1 Описание планируемых тестов</h4>
        <div class="mb-3">
            <label for="planned_tests_table" class="form-label">Таблица планируемых тестов</label>
            <small class="text-muted d-block mb-2">Для добавления новой строки нажмите кнопку "Добавить строку".</small>
            
            <!-- Скрытое поле для отправки данных на сервер -->
            <input type="hidden" id="planned_tests_table" name="planned_tests_table" value="{{ data.planned_tests_table if data else '' }}">
            
            <!-- Визуальная таблица с input полями -->
            <div class="table-responsive">
                <table class="table table-bordered" id="planned_tests_visual_table">
                    <thead>
                        <tr>
                            <th style="width: 5%;">№ <span class="text-danger">*</span></th>
                            <th style="width: 25%;">Тест <span class="text-danger">*</span></th>
                            <th style="width: 20%;">Длительность теста <span class="text-danger">*</span></th>
                            <th style="width: 45%;">Описание теста <span class="text-danger">*</span></th>
                            <th style="width: 5%; text-align: center;">Действия</th>
                        </tr>
                    </thead>
                    <tbody id="planned_tests_tbody">
                        <!-- Заполняется автоматически через JavaScript -->
                    </tbody>
                </table>
            </div>
            <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="add_planned_test_row_btn">
                <i class="bi bi-plus-circle"></i> Добавить строку
            </button>
        </div>
        <div class="mb-3">
            <div class="alert alert-info" role="alert" style="margin-bottom: 0;">
                * приступая к тестированию необходимо выяснить, проработана ли Горизонтальная масштабируемость? Если да, то проводим тест. Если нет, то указываем это в МНТ и в рекомендациях отчёта.
            </div>
        </div>

        <h4 class="mt-3 mb-3" id="section-9-2">9.2 Условия завершения НТ</h4>
        <div class="mb-3">
            <label for="completion_conditions" class="form-label">Список условий завершения НТ (каждое условие с новой строки)</label>
            <textarea class="form-control" id="completion_conditions" name="completion_conditions" rows="6">{% if data and data.get('completion_conditions') %}{{ data.completion_conditions }}{% else %}Критериями успешного завершения нагрузочного тестирования являются:
•-
•-
•-{% endif %}</textarea>
        </div>
    </div>

    <!-- Раздел 10: Наполнение БД -->
    <div class="form-section" id="section-10">
        <h3>10. Наполнение БД</h3>
        <div class="mb-3">
            <label for="database_preparation_text" class="form-label">Текст описания наполнения БД</label>
            <textarea class="form-control" id="database_preparation_text" name="database_preparation_text" rows="6">{{ data.database_preparation_text if data else '' }}</textarea>
        </div>
        <div class="mb-3">
            <label for="database_preparation_table" class="form-label">Таблица требований к объемам данных</label>
            <small class="text-muted d-block mb-2">Для добавления новой строки нажмите кнопку "Добавить строку".</small>
            
            <!-- Скрытое поле для отправки данных на сервер -->
            <input type="hidden" id="database_preparation_table" name="database_preparation_table" value="{{ data.database_preparation_table if data else '' }}">
            
            <!-- Визуальная таблица с input полями -->
            <div class="table-responsive">
                <table class="table table-bordered" id="database_preparation_visual_table">
                    <thead>
                        <tr>
                            <th style="width: 30%;">Схема.Таблица <span class="text-danger">*</span></th>
                            <th style="width: 35%;">Текущее кол-во строк в таблице <span class="text-danger">*</span></th>
                            <th style="width: 30%;">Прогноз роста в день <span class="text-danger">*</span></th>
                            <th style="width: 5%; text-align: center;">Действия</th>
                        </tr>
                    </thead>
                    <tbody id="database_preparation_tbody">
                        <!-- Заполняется автоматически через JavaScript -->
                    </tbody>
                </table>
            </div>
            <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="add_database_preparation_row_btn">
                <i class="bi bi-plus-circle"></i> Добавить строку
            </button>
        </div>
    </div>

    <!-- Раздел 11: Моделирование нагрузки -->
    <div class="form-section" id="section-11">
        <h3>11. Моделирование нагрузки</h3>
        
        <h4 class="mt-3 mb-3" id="section-11-1">11.1 Общие принципы моделирования нагрузки</h4>
        <div class="mb-3">
            <label for="load_modeling_principles" class="form-label">Текст принципов моделирования нагрузки</label>
            <textarea class="form-control" id="load_modeling_principles" name="load_modeling_principles" rows="12">{{ data.load_modeling_principles if data else '' }}</textarea>
        </div>

        <h4 class="mt-3 mb-3" id="section-11-2">11.2 Профили нагрузки</h4>
        <div class="mb-3">
            <label for="load_profiles_intro" class="form-label">Вводный текст</label>
            <textarea class="form-control" id="load_profiles_intro" name="load_profiles_intro" rows="3">{% if data and data.get('load_profiles_intro') %}{{ data.load_profiles_intro }}{% else %}В таблице ниже приведен Профиль НТ Р1 бизнес – операции, с использованием которых проводится тестирование и показатели интенсивности нагрузки по этим операциям принятые за 100%. Формирование перечня операций и показателей интенсивности нагрузки происходило на основе данных из сервиса Яндекс.Метрика о промышленном использовании тестируемой системы, с учётом правок, внесённых Заказчиком.{% endif %}</textarea>
        </div>
        <div class="mb-3">
            <label for="load_profiles_table" class="form-label">Таблица профилей нагрузки</label>
            <small class="text-muted d-block mb-2">Для добавления новой строки нажмите кнопку "Добавить строку".</small>
            
            <!-- Скрытое поле для отправки данных на сервер -->
            <input type="hidden" id="load_profiles_table" name="load_profiles_table" value="{{ data.load_profiles_table if data else '' }}">
            
            <!-- Визуальная таблица с input полями -->
            <div class="table-responsive">
                <table class="table table-bordered" id="load_profiles_visual_table">
                    <thead>
                        <tr>
                            <th style="width: 50%;">Название страниц <span class="text-danger">*</span></th>
                            <th style="width: 45%;">Интенсивность нагрузки, операций\минута <span class="text-danger">*</span></th>
                            <th style="width: 5%; text-align: center;">Действия</th>
                        </tr>
                    </thead>
                    <tbody id="load_profiles_tbody">
                        <!-- Заполняется автоматически через JavaScript -->
                    </tbody>
                </table>
            </div>
            <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="add_load_profiles_row_btn">
                <i class="bi bi-plus-circle"></i> Добавить строку
            </button>
        </div>

        <h4 class="mt-3 mb-3" id="section-11-3">11.3 Сценарии использования</h4>
        <div class="mb-3">
            <label for="use_scenarios_intro" class="form-label">Вводный текст</label>
            <textarea class="form-control" id="use_scenarios_intro" name="use_scenarios_intro" rows="3">{% if data and data.get('use_scenarios_intro') %}{{ data.use_scenarios_intro }}{% else %}Перечень эмулируемых пользовательских бизнес-сценариев представлен в нижеприведенной таблице.{% endif %}</textarea>
        </div>
        <div class="mb-3">
            <label for="use_scenarios_table" class="form-label">Таблица сценариев использования</label>
            <small class="text-muted d-block mb-2">Для добавления новой строки нажмите кнопку "Добавить строку".</small>
            
            <!-- Скрытое поле для отправки данных на сервер -->
            <input type="hidden" id="use_scenarios_table" name="use_scenarios_table" value="{{ data.use_scenarios_table if data else '' }}">
            
            <!-- Визуальная таблица с input полями -->
            <div class="table-responsive">
                <table class="table table-bordered" id="use_scenarios_visual_table">
                    <thead>
                        <tr>
                            <th style="width: 50%;">Шаги <span class="text-danger">*</span></th>
                            <th style="width: 45%;">Интенсивность нагрузки, операций\минута принятая за 100% <span class="text-danger">*</span></th>
                            <th style="width: 5%; text-align: center;">Действия</th>
                        </tr>
                    </thead>
                    <tbody id="use_scenarios_tbody">
                        <!-- Заполняется автоматически через JavaScript -->
                    </tbody>
                </table>
            </div>
            <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="add_use_scenarios_row_btn">
                <i class="bi bi-plus-circle"></i> Добавить строку
            </button>
        </div>

        <h4 class="mt-3 mb-3" id="section-11-4">11.4 Описание работы эмуляторов</h4>
        <div class="mb-3">
            <label for="emulators_description" class="form-label">Текст описания работы эмуляторов <span class="text-danger">*</span></label>
            <textarea class="form-control required-field" id="emulators_description" name="emulators_description" rows="4" required>{% if data and data.get('emulators_description') %}{{ data.emulators_description }}{% else %}В текущем проекте взаимодействие со внешними системами не рассматривается.{% endif %}</textarea>
        </div>
    </div>

    <!-- Раздел 12: Мониторинг -->
    <div class="form-section" id="section-12">
        <h3>12. Мониторинг</h3>
        
        <div class="mb-3">
            <label for="monitoring_intro" class="form-label">Общий вводный текст</label>
            <textarea class="form-control" id="monitoring_intro" name="monitoring_intro" rows="4">{{ data.monitoring_intro if data else '' }}</textarea>
        </div>

        <h4 class="mt-3 mb-3" id="section-12-1">12.1 Описание средств мониторинга</h4>
        <div class="mb-3">
            <label for="monitoring_tools_intro" class="form-label">Вводный текст</label>
            <textarea class="form-control" id="monitoring_tools_intro" name="monitoring_tools_intro" rows="2">{% if data and data.get('monitoring_tools_intro') %}{{ data.monitoring_tools_intro }}{% else %}Для мониторинга в ходе НТ предполагается использовать инструменты, указанные в таблице Таблица 11.{% endif %}</textarea>
        </div>
        <div class="mb-3">
            <label for="monitoring_tools_table" class="form-label">Таблица средств мониторинга</label>
            <small class="text-muted d-block mb-2">Для добавления новой строки нажмите кнопку "Добавить строку".</small>
            
            <!-- Скрытое поле для отправки данных на сервер -->
            <input type="hidden" id="monitoring_tools_table" name="monitoring_tools_table" value="{{ data.monitoring_tools_table if data else '' }}">
            
            <!-- Визуальная таблица с input полями -->
            <div class="table-responsive">
                <table class="table table-bordered" id="monitoring_tools_visual_table">
                    <thead>
                        <tr>
                            <th style="width: 30%;">Наименование <span class="text-danger">*</span></th>
                            <th style="width: 35%;">Роль <span class="text-danger">*</span></th>
                            <th style="width: 30%;">Эндпоинт (URI)</th>
                            <th style="width: 5%; text-align: center;">Действия</th>
                        </tr>
                    </thead>
                    <tbody id="monitoring_tools_tbody">
                        <!-- Заполняется автоматически через JavaScript -->
                    </tbody>
                </table>
            </div>
            <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="add_monitoring_tools_row_btn">
                <i class="bi bi-plus-circle"></i> Добавить строку
            </button>
        </div>
        <div class="mb-3">
            <label for="monitoring_tools_note" class="form-label">Текст после таблицы средств мониторинга</label>
            <textarea class="form-control" id="monitoring_tools_note" name="monitoring_tools_note" rows="8">{{ data.monitoring_tools_note if data else '' }}</textarea>
        </div>

        <h4 class="mt-3 mb-3" id="section-12-2">12.2 Описание метрик мониторинга</h4>
        
        <h5 class="mt-2 mb-2">12.2.1 Мониторинг системных ресурсов</h5>
        <div class="mb-3">
            <label for="system_resources_intro" class="form-label">Вводный текст</label>
            <textarea class="form-control" id="system_resources_intro" name="system_resources_intro" rows="2">{% if data and data.get('system_resources_intro') %}{{ data.system_resources_intro }}{% else %}Мониторинг системных ресурсов серверов приложений, серверов БД, серверов с эмуляторами и генерации нагрузки будет выполняться посредством метрик, указанных в таблице 12.{% endif %}</textarea>
        </div>
        <div class="mb-3">
            <label for="system_resources_table" class="form-label">Таблица метрик системных ресурсов</label>
            <small class="text-muted d-block mb-2">Для добавления новой строки нажмите кнопку "Добавить строку".</small>
            
            <!-- Скрытое поле для отправки данных на сервер -->
            <input type="hidden" id="system_resources_table" name="system_resources_table" value="{{ data.system_resources_table if data else '' }}">
            
            <!-- Визуальная таблица с input полями -->
            <div class="table-responsive">
                <table class="table table-bordered" id="system_resources_visual_table">
                    <thead>
                        <tr>
                            <th style="width: 5%;">№</th>
                            <th style="width: 20%;">Тип метрики <span class="text-danger">*</span></th>
                            <th style="width: 30%;">Способ снятия <span class="text-danger">*</span></th>
                            <th style="width: 22%;">Способ получения <span class="text-danger">*</span></th>
                            <th style="width: 18%;">Визуализация</th>
                            <th style="width: 5%; text-align: center;">Действия</th>
                        </tr>
                    </thead>
                    <tbody id="system_resources_tbody">
                        <!-- Заполняется автоматически через JavaScript -->
                    </tbody>
                </table>
            </div>
            <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="add_system_resources_row_btn">
                <i class="bi bi-plus-circle"></i> Добавить строку
            </button>
        </div>

        <h5 class="mt-3 mb-2">12.2.2 Мониторинг бизнес-метрик</h5>
        <div class="mb-3">
            <label for="business_metrics_intro" class="form-label">Вводный текст</label>
            <textarea class="form-control" id="business_metrics_intro" name="business_metrics_intro" rows="2">{% if data and data.get('business_metrics_intro') %}{{ data.business_metrics_intro }}{% else %}В процессе НТ необходимо отслеживать бизнес-характеристики системы, указанные в таблице Таблица 13.{% endif %}</textarea>
        </div>
        <div class="mb-3">
            <label for="business_metrics_table" class="form-label">Таблица бизнес-метрик</label>
            <small class="text-muted d-block mb-2">Для добавления новой строки нажмите кнопку "Добавить строку".</small>
            
            <!-- Скрытое поле для отправки данных на сервер -->
            <input type="hidden" id="business_metrics_table" name="business_metrics_table" value="{{ data.business_metrics_table if data else '' }}">
            
            <!-- Визуальная таблица с input полями -->
            <div class="table-responsive">
                <table class="table table-bordered" id="business_metrics_visual_table">
                    <thead>
                        <tr>
                            <th style="width: 60%;">Бизнес-метрика <span class="text-danger">*</span></th>
                            <th style="width: 35%;">Единица измерения</th>
                            <th style="width: 5%; text-align: center;">Действия</th>
                        </tr>
                    </thead>
                    <tbody id="business_metrics_tbody">
                        <!-- Заполняется автоматически через JavaScript -->
                    </tbody>
                </table>
            </div>
            <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="add_business_metrics_row_btn">
                <i class="bi bi-plus-circle"></i> Добавить строку
            </button>
        </div>
    </div>

    <!-- Раздел 13: Требования к Заказчику -->
    <div class="form-section" id="section-13">
        <h3>13. Требования к Заказчику</h3>
        <div class="mb-3">
            <label for="customer_requirements_list" class="form-label">Список требований к Заказчику</label>
            <textarea class="form-control" id="customer_requirements_list" name="customer_requirements_list" rows="20">{% if data and data.get('customer_requirements_list') %}{{ data.customer_requirements_list }}{% else %}1. Выполнить подготовку (сборку, настройку, установку системного ПО, развертывание тестируемых подсистем) тестового стенда для нагрузочного тестирования (отвечает Заказчик). Полное развертывание тестового стенда для нагрузочного тестирования должно быть произведено в сроки, указанные в календарном плане, согласованным с Заказчиком;
2. Предоставить выборки данных (статистики) по операциям Системы за пиковые часы работы в промышленной эксплуатации;
3. Спрогнозировать промышленную эксплуатацию при невозможности собрать статистику (например, когда система еще не введена в эксплуатацию);
4. Необходимо участие администраторов АС в мониторинге утилизации системных ресурсов и предоставление данных мониторинга для анализа результатов нагрузочного тестирования;
5. Необходимо участие специалистов Заказчика для консультации по вопросам интеграции с внешними системами и выполняемых в системе операций если таковы имеются;
6. Предоставить доступ к серверам генерации нагрузки, способных обеспечивать необходимую интенсивность выполнения операций;
7. Предоставить доступ к тестовому стенду с рабочего места Исполнителя;
8. Выполнить миграцию данных с промышленной БД в БД стенда нагрузочного тестирования;
9. Создать резервные копии тестовых БД перед началом проведения нагрузочных испытаний;
10. При необходимости, по запросу выполнить восстановление тестовой БД из резервной копии;
11. При необходимости, по запросу выполнить перезагрузку серверов, оперативно восстановить стенд после сбоев;
12. Обеспечить неизменность версии системы на протяжении тестирования в целях валидности результатов;
13. Исключить несогласованные изменения конфигурации тестового стенда на протяжении периода выполнения проекта по нагрузочному тестированию системы;
14. Обеспечить скорость подключения между узлами системы, генераторами нагрузки, эмуляторами и т.д., достаточной для проведения НТ;
15. Устранить блокеры НТ в случае их выявления. По необходимости доработать ППО силами Заказчика;
Если сроки доработки ППО приводят к тому, что проект не может быть завершен вовремя, то:
1. В случае, если объём работ не меняется, стороны согласовывают изменение даты завершения работ без изменения общей трудоемкости;
2. В случае, если объём работ должен быть изменен, стороны согласовывают перечень и объем работ по тестированию после доработки ППО, вынесенных за рамки данного проекта в отдельный проект.{% endif %}</textarea>
        </div>
    </div>

    <!-- Раздел 14: Материалы, подлежащие сдаче -->
    <div class="form-section" id="section-14">
        <h3>14. Материалы, подлежащие сдаче</h3>
        <div class="mb-3">
            <label for="deliverables_intro" class="form-label">Вводный текст</label>
            <textarea class="form-control" id="deliverables_intro" name="deliverables_intro" rows="3">{% if data and data.get('deliverables_intro') %}{{ data.deliverables_intro }}{% else %}При завершении НТ на всех этапах, сдаче Заказчику подлежат материалы, указанные в таблице 14.{% endif %}</textarea>
        </div>
        <div class="mb-3">
            <label for="deliverables_table" class="form-label">Таблица материалов</label>
            <small class="text-muted d-block mb-2">Для добавления новой строки нажмите кнопку "Добавить строку".</small>
            
            <!-- Скрытое поле для отправки данных на сервер -->
            <input type="hidden" id="deliverables_table" name="deliverables_table" value="{{ data.deliverables_table if data else '' }}">
            
            <!-- Визуальная таблица с input полями -->
            <div class="table-responsive">
                <table class="table table-bordered" id="deliverables_visual_table">
                    <thead>
                        <tr>
                            <th style="width: 45%;">Документ <span class="text-danger">*</span></th>
                            <th style="width: 50%;">Подготавливается в результате деятельности <span class="text-danger">*</span></th>
                            <th style="width: 5%; text-align: center;">Действия</th>
                        </tr>
                    </thead>
                    <tbody id="deliverables_tbody">
                        <!-- Заполняется автоматически через JavaScript -->
                    </tbody>
                </table>
            </div>
            <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="add_deliverables_row_btn">
                <i class="bi bi-plus-circle"></i> Добавить строку
            </button>
        </div>
        
        <div class="mb-3 mt-4">
            <label class="form-label"><strong>Рабочие документы (предоставляются только в электронном виде):</strong></label>
            <small class="text-muted d-block mb-2">Для добавления новой строки нажмите кнопку "Добавить строку".</small>
            
            <!-- Скрытое поле для отправки данных на сервер -->
            <input type="hidden" id="deliverables_working_docs_table" name="deliverables_working_docs_table" value="{{ data.deliverables_working_docs_table if data else '' }}">
            
            <!-- Визуальная таблица с input полями -->
            <div class="table-responsive">
                <table class="table table-bordered" id="deliverables_working_docs_visual_table">
                    <thead>
                        <tr>
                            <th style="width: 45%;">Документ <span class="text-danger">*</span></th>
                            <th style="width: 50%;">Подготавливается в результате деятельности <span class="text-danger">*</span></th>
                            <th style="width: 5%; text-align: center;">Действия</th>
                        </tr>
                    </thead>
                    <tbody id="deliverables_working_docs_tbody">
                        <!-- Заполняется автоматически через JavaScript -->
                    </tbody>
                </table>
            </div>
            <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="add_deliverables_working_docs_row_btn">
                <i class="bi bi-plus-circle"></i> Добавить строку
            </button>
        </div>
    </div>

    <!-- Раздел 15: Контакты -->
    <div class="form-section" id="section-15">
        <h3>15. Контакты</h3>
        <div class="mb-3">
            <label for="contacts_table" class="form-label">Таблица контактов ответственных лиц</label>
            <small class="text-muted d-block mb-2">Для добавления новой строки нажмите кнопку "Добавить строку".</small>
            
            <!-- Скрытое поле для отправки данных на сервер -->
            <input type="hidden" id="contacts_table" name="contacts_table" value="{{ data.contacts_table if data else '' }}">
            
            <!-- Визуальная таблица с input полями -->
            <div class="table-responsive">
                <table class="table table-bordered" id="contacts_visual_table">
                    <thead>
                        <tr>
                            <th style="width: 5%;">п/п</th>
                            <th style="width: 25%;">ФИО <span class="text-danger">*</span></th>
                            <th style="width: 30%;">Сфера ответственности <span class="text-danger">*</span></th>
                            <th style="width: 35%;">Контакты</th>
                            <th style="width: 5%; text-align: center;">Действия</th>
                        </tr>
                    </thead>
                    <tbody id="contacts_tbody">
                        <!-- Заполняется автоматически через JavaScript -->
                    </tbody>
                </table>
            </div>
            <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="add_contacts_row_btn">
                <i class="bi bi-plus-circle"></i> Добавить строку
            </button>
        </div>
    </div>

    <!-- Confluence -->
    <!-- Пользовательские блоки - закомментировано
    <div id="custom-sections-container"></div>
    
    <div class="form-section" id="section-add-custom">
        <h3>Добавить пользовательский блок</h3>
        <div class="mb-3">
            <label for="custom_section_title" class="form-label">Название блока <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="custom_section_title" placeholder="Например: 16. Дополнительные материалы">
        </div>
        <div class="mb-3">
            <label for="custom_section_insert_after" class="form-label">Вставить после блока</label>
            <select class="form-select" id="custom_section_insert_after">
                <option value="15">15. Контакты (в конец документа)</option>
                <option value="1">1. История изменений</option>
                <option value="2">2. Лист согласования</option>
                <option value="3">3. Сокращения и терминология</option>
                <option value="4">4. Введение</option>
                <option value="5">5. Цели и задачи НТ</option>
                <option value="6">6. Ограничения и риски НТ</option>
                <option value="7">7. Объект НТ</option>
                <option value="8">8. Тестовый и промышленный стенды</option>
                <option value="9">9. Стратегия тестирования</option>
                <option value="10">10. Наполнение БД</option>
                <option value="11">11. Моделирование нагрузки</option>
                <option value="12">12. Мониторинг</option>
                <option value="13">13. Требования к Заказчику</option>
                <option value="14">14. Материалы, подлежащие сдаче</option>
                <option value="15">15. Контакты</option>
            </select>
        </div>
        <button type="button" class="btn btn-primary" id="add-custom-section-btn">Добавить блок</button>
    </div>
    -->
    
    <!-- Теги -->
    <div class="form-section" id="section-tags">
        <h3>Теги</h3>
        <div class="mb-3">
            <label for="tags" class="form-label">Теги (через запятую)</label>
            <input type="text" 
                   class="form-control" 
                   id="tags" 
                   name="tags" 
                   placeholder="Например: Претрейд, Тестирование, Микросервис"
                   value="">
            <small class="form-text text-muted">Введите теги через запятую для категоризации документа. Например: Претрейд, Команда А, Проект Б</small>
        </div>
    </div>

    <!-- Confluence -->
    <div class="form-section" id="section-confluence">
        <h3>Публикация в Confluence</h3>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="confluence_space" class="form-label">Space Key <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="confluence_space" name="confluence_space" required 
                       placeholder="Например: TEST" value="{{ data.confluence_space if data else 'TEST' }}">
                <small class="form-text text-muted">
                    Ключ пространства (Space) в Confluence, где будет создана страница МНТ. 
                    Это короткий уникальный идентификатор пространства (обычно в верхнем регистре).
                    <br><strong>Как найти Space Key:</strong> Откройте любое пространство в Confluence и посмотрите на URL — там будет параметр <code>spaceKey=TEST</code> или путь <code>/spaces/TEST/</code>
                </small>
            </div>
            <div class="col-md-6 mb-3">
                <label for="confluence_parent_id" class="form-label">Parent Page ID (опционально)</label>
                <input type="number" class="form-control" id="confluence_parent_id" name="confluence_parent_id" 
                       placeholder="Например: 123456" value="{{ data.confluence_parent_id if data else '' }}">
                <small class="form-text text-muted">
                    ID страницы в Confluence, под которой будет создана эта страница МНТ (для создания иерархии страниц). 
                    Если не указано, страница будет создана на верхнем уровне пространства.
                    <br><strong>Как найти ID:</strong> Откройте нужную страницу в Confluence и посмотрите на URL — там будет параметр <code>pageId=123456</code>
                </small>
            </div>
        </div>
    </div>

    <!-- Скрытое поле для отслеживания действия -->
    <input type="hidden" name="publish" id="publish_hidden" value="">
    
    <!-- Кнопки -->
    <div class="d-flex gap-2 mb-4">
        <button type="submit" class="btn btn-primary" onclick="document.getElementById('publish_hidden').value='1';">Сохранить и сгенерировать в Confluence</button>
        <button type="submit" class="btn btn-secondary" onclick="document.getElementById('publish_hidden').value='';">Сохранить без публикации</button>
        <button type="button" class="btn btn-outline-info" id="preview-btn">👁️ Превью</button>
        <a href="/mnt/list" class="btn btn-outline-secondary">Отмена</a>
    </div>
</form>
{% endblock %}

{% block scripts %}
<script src="/static/js/table-editor.js"></script>
<script src="/static/js/form-validation.js"></script>
<script src="/static/js/image-preview.js"></script>
<script>
// Автоматическое заполнение таблицы истории изменений при вводе данных
document.addEventListener('DOMContentLoaded', function() {
    const authorInput = document.getElementById('author');
    const historyTableHidden = document.getElementById('history_changes_table');
    const historyTableTbody = document.getElementById('history_changes_tbody');
    
    if (!authorInput || !historyTableTbody || !historyTableHidden) {
        return;
    }
    
    // Функция для обновления скрытого поля из визуальной таблицы
    function updateHiddenField() {
        if (!historyTableTbody || !historyTableHidden) return;
        
        const rows = historyTableTbody.querySelectorAll('tr');
        if (rows.length === 0) {
            historyTableHidden.value = '';
            return;
        }
        
        const parts = [];
        parts.push('Дата|Версия|Описание|Автор'); // Заголовок
        
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length >= 4) {
                const date = cells[0].textContent.trim();
                const version = cells[1].textContent.trim();
                const descInput = cells[2].querySelector('input[name="history_description"]');
                const description = descInput ? descInput.value.trim() : cells[2].textContent.trim();
                const author = cells[3].textContent.trim();
                parts.push(`${date}|${version}|${description}|${author}`);
            }
        });
        
        historyTableHidden.value = parts.join('\n');
    }
    
    function updateHistoryTable() {
        if (!historyTableTbody || !historyTableHidden || !authorInput) return;
        
        const author = authorInput.value.trim();
        
        if (!author) {
            // Если автор не указан, очищаем таблицу
            historyTableTbody.innerHTML = '';
            historyTableHidden.value = '';
            return;
        }
        
        // Форматируем текущую дату
        const today = new Date();
        const day = String(today.getDate()).padStart(2, '0');
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const year = today.getFullYear();
        const dateStr = `${day}.${month}.${year}`;
        
        // Получаем описание из input (если уже есть строка в таблице)
        let description = 'Заполнены основные пункты';
        const existingInput = historyTableTbody.querySelector('input[name="history_description"]');
        if (existingInput && existingInput.value.trim()) {
            description = existingInput.value.trim();
        }
        
        // Создаем строку таблицы
        historyTableTbody.innerHTML = `
            <tr>
                <td>${dateStr}</td>
                <td>0.1</td>
                <td>
                    <input type="text" 
                           class="form-control form-control-sm" 
                           name="history_description" 
                           value="${description}"
                           placeholder="Заполнены основные пункты">
                </td>
                <td>${author}</td>
            </tr>
        `;
        
        // Добавляем слушатель на изменение описания ПЕРЕД обновлением скрытого поля
        const newDescriptionInput = historyTableTbody.querySelector('input[name="history_description"]');
        if (newDescriptionInput) {
            newDescriptionInput.addEventListener('input', function() {
                updateHiddenField();
            });
        }
        
        // Обновляем скрытое поле для отправки на сервер ПОСЛЕ создания строки
        updateHiddenField();
    }
    
    // Обновляем таблицу при изменении автора (только при потере фокуса, а не при каждом символе)
    authorInput.addEventListener('blur', function() {
        if (authorInput.value.trim()) {
            updateHistoryTable();
        }
    });
    
    // Инициализируем таблицу при загрузке, если автор уже есть (например, из автозаполнения браузера)
    setTimeout(function() {
        if (authorInput.value.trim()) {
            updateHistoryTable();
        }
    }, 100);
    
    // Обновляем скрытое поле перед отправкой формы
    const form = document.querySelector('form[action*="/mnt/create"]');
    if (form) {
        form.addEventListener('submit', function(e) {
            updateHiddenField();
        });
    }
});
</script>

<!-- JavaScript для таблицы сокращений -->
<script>
// Управление таблицей сокращений
document.addEventListener('DOMContentLoaded', function() {
    const abbreviationsTableHidden = document.getElementById('abbreviations_table');
    const abbreviationsTableTbody = document.getElementById('abbreviations_tbody');
    const addAbbreviationRowBtn = document.getElementById('add_abbreviation_row_btn');
    
    if (!abbreviationsTableHidden || !abbreviationsTableTbody) {
        console.error('Abbreviations table elements not found');
        return;
    }
    
    console.log('Abbreviations table script loaded, button:', addAbbreviationRowBtn);
    
    // Функция для создания новой строки в таблице
    function createAbbreviationRow(rowData = { name: '', description: '' }) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <textarea class="form-control form-control-sm abbreviation-name" 
                       name="abbreviation_name[]" 
                       rows="2"
                       placeholder="Например: МНТ"
                       required>${rowData.name || ''}</textarea>
            </td>
            <td>
                <textarea class="form-control form-control-sm abbreviation-description" 
                       name="abbreviation_description[]" 
                       rows="2"
                       placeholder="Методика нагрузочного тестирования"
                       required>${rowData.description || ''}</textarea>
            </td>
            <td style="text-align: center; vertical-align: middle;">
                <button type="button" 
                        class="btn btn-sm btn-danger remove-abbreviation-row" 
                        title="Удалить строку">
                    <i class="bi bi-trash"></i> Удалить
                </button>
            </td>
        `;
        return row;
    }
    
    // Функция для загрузки существующих данных
    function loadExistingAbbreviationData() {
        const abbreviationData = abbreviationsTableHidden.value.trim();
        
        if (!abbreviationData) {
            return; // Нет данных - таблица остается пустой
        }
        
        const lines = abbreviationData.split('\n').filter(line => line.trim());
        if (lines.length < 2) {
            return; // Только заголовок или пусто
        }
        
        // Пропускаем заголовок (первая строка)
        for (let i = 1; i < lines.length; i++) {
            const parts = lines[i].split('|').map(p => p.trim());
            if (parts.length >= 2) {
                const rowData = {
                    name: parts[0] || '',
                    description: parts[1] || ''
                };
                const row = createAbbreviationRow(rowData);
                abbreviationsTableTbody.appendChild(row);
            }
        }
        
        updateAbbreviationHiddenField();
    }
    
    // Функция для обновления скрытого поля из визуальной таблицы
    function updateAbbreviationHiddenField() {
        const rows = abbreviationsTableTbody.querySelectorAll('tr');
        if (rows.length === 0) {
            abbreviationsTableHidden.value = '';
            return;
        }
        
        const parts = [];
        parts.push('Наименование сокращения|Описание'); // Заголовок
        
        rows.forEach(row => {
            const nameInput = row.querySelector('.abbreviation-name');
            const descriptionInput = row.querySelector('.abbreviation-description');
            
            if (nameInput && descriptionInput) {
                const name = nameInput.value.trim();
                const description = descriptionInput.value.trim();
                if (name || description) {
                    parts.push(`${name}|${description}`);
                }
            }
        });
        
        abbreviationsTableHidden.value = parts.join('\n');
    }
    
    // Обработчик добавления новой строки
    if (addAbbreviationRowBtn) {
        console.log('Adding click handler to abbreviation row button');
        addAbbreviationRowBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Add abbreviation row button clicked');
            const newRow = createAbbreviationRow();
            abbreviationsTableTbody.appendChild(newRow);
            updateAbbreviationHiddenField();
        });
    } else {
        console.error('Add abbreviation row button not found!');
    }
    
    // Обработчик удаления строки
    abbreviationsTableTbody.addEventListener('click', function(e) {
        if (e.target.closest('.remove-abbreviation-row')) {
            const row = e.target.closest('tr');
            if (row) {
                row.remove();
                updateAbbreviationHiddenField();
            }
        }
    });
    
    // Обновляем скрытое поле при изменении полей
    abbreviationsTableTbody.addEventListener('input', function() {
        updateAbbreviationHiddenField();
    });
    
    abbreviationsTableTbody.addEventListener('change', function() {
        updateAbbreviationHiddenField();
    });
    
    // Загружаем существующие данные при загрузке страницы
    loadExistingAbbreviationData();
    
    // Обновляем скрытое поле перед отправкой формы
    const form = document.querySelector('form[action*="/mnt/"]');
    if (form) {
        form.addEventListener('submit', function() {
            updateAbbreviationHiddenField();
        });
    }
});
</script>

<!-- JavaScript для таблицы терминологии -->
<script>
// Управление таблицей терминологии
document.addEventListener('DOMContentLoaded', function() {
    const terminologyTableHidden = document.getElementById('terminology_table');
    const terminologyTableTbody = document.getElementById('terminology_tbody');
    const addTerminologyRowBtn = document.getElementById('add_terminology_row_btn');
    
    if (!terminologyTableHidden || !terminologyTableTbody) {
        console.error('Terminology table elements not found');
        return;
    }
    
    console.log('Terminology table script loaded, button:', addTerminologyRowBtn);
    
    // Функция для создания новой строки в таблице
    function createTerminologyRow(rowData = { term: '', definition: '' }) {
        const row = document.createElement('tr');
        const termValue = (rowData.term || '').replace(/"/g, '&quot;');
        // Убираем метку изображения из определения при отображении
        let definitionValue = (rowData.definition || '').replace(/\[IMAGE:[^\]]+\]/g, '').trim();
        definitionValue = definitionValue.replace(/</g, '&lt;').replace(/>/g, '&gt;');
        
        row.innerHTML = `
            <td>
                <textarea class="form-control form-control-sm terminology-term" 
                       name="terminology_term[]" 
                       rows="2"
                       placeholder="Например: Нагрузочное тестирование"
                       required>${termValue}</textarea>
            </td>
            <td>
                <textarea class="form-control form-control-sm terminology-definition" 
                       name="terminology_definition[]" 
                       rows="3"
                       placeholder="Процесс тестирования системы под нагрузкой"
                       required>${definitionValue}</textarea>
            </td>
            <td style="text-align: center; vertical-align: middle;">
                <button type="button" 
                        class="btn btn-sm btn-danger remove-terminology-row" 
                        title="Удалить строку">
                    <i class="bi bi-trash"></i> Удалить
                </button>
            </td>
        `;
        
        return row;
    }
    
    // Функция для загрузки существующих данных
    function loadExistingTerminologyData() {
        const terminologyData = terminologyTableHidden.value.trim();
        
        if (!terminologyData) {
            return; // Нет данных - таблица остается пустой
        }
        
        const lines = terminologyData.split('\n').filter(line => line.trim());
        if (lines.length < 2) {
            return; // Только заголовок или пусто
        }
        
        // Пропускаем заголовок (первая строка)
        for (let i = 1; i < lines.length; i++) {
            const parts = lines[i].split('|').map(p => p.trim());
            if (parts.length >= 2) {
                const rowData = {
                    term: parts[0] || '',
                    definition: parts[1] || ''
                };
                const row = createTerminologyRow(rowData);
                terminologyTableTbody.appendChild(row);
            }
        }
        
        updateTerminologyHiddenField();
    }
    
    // Функция для обновления скрытого поля из визуальной таблицы
    function updateTerminologyHiddenField() {
        const rows = terminologyTableTbody.querySelectorAll('tr');
        if (rows.length === 0) {
            terminologyTableHidden.value = '';
            return;
        }
        
        const parts = [];
        parts.push('Термин|Определение'); // Заголовок
        
        rows.forEach(row => {
            const termInput = row.querySelector('.terminology-term');
            const definitionInput = row.querySelector('.terminology-definition');
            
            if (termInput && definitionInput) {
                const term = termInput.value.trim();
                const definition = definitionInput.value.trim();
                
                if (term || definition) {
                    parts.push(`${term}|${definition}`);
                }
            }
        });
        
        terminologyTableHidden.value = parts.join('\n');
    }
    
    // Обработчик добавления новой строки
    if (addTerminologyRowBtn) {
        console.log('Adding click handler to terminology row button');
        addTerminologyRowBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Add terminology row button clicked');
            const newRow = createTerminologyRow();
            terminologyTableTbody.appendChild(newRow);
            updateTerminologyHiddenField();
        });
    } else {
        console.error('Add terminology row button not found!');
    }
    
    // Обработчик удаления строки
    terminologyTableTbody.addEventListener('click', function(e) {
        if (e.target.closest('.remove-terminology-row')) {
            const row = e.target.closest('tr');
            if (row) {
                row.remove();
                updateTerminologyHiddenField();
            }
        }
    });
    
    // Обновляем скрытое поле при изменении полей
    terminologyTableTbody.addEventListener('input', function() {
        updateTerminologyHiddenField();
    });
    
    terminologyTableTbody.addEventListener('change', function() {
        updateTerminologyHiddenField();
    });
    
    // Загружаем существующие данные при загрузке страницы
    loadExistingTerminologyData();
    
    // Обновляем скрытое поле перед отправкой формы
    const form = document.querySelector('form[action*="/mnt/"]');
    if (form) {
        form.addEventListener('submit', function() {
            updateTerminologyHiddenField();
        });
    }
});
</script>

<!-- JavaScript для таблицы рисков -->
<script>
// Управление таблицей рисков
document.addEventListener('DOMContentLoaded', function() {
    const risksTableHidden = document.getElementById('risks_table');
    const risksTableTbody = document.getElementById('risks_tbody');
    const addRiskRowBtn = document.getElementById('add_risk_row_btn');
    
    if (!risksTableHidden || !risksTableTbody) {
        console.error('Risks table elements not found');
        return;
    }
    
    console.log('Risks table script loaded, button:', addRiskRowBtn);
    
    // Функция для создания новой строки в таблице
    function createRiskRow(rowData = { risk: '', probability: '', impact: '' }) {
        const row = document.createElement('tr');
        
        row.innerHTML = `
            <td>
                <textarea class="form-control form-control-sm risk-risk" 
                       name="risk_risk[]" 
                       rows="2"
                       placeholder="Например: При подготовке СНТ возможно изменение функционала"
                       required>${(rowData.risk || '').replace(/"/g, '&quot;')}</textarea>
            </td>
            <td>
                <textarea class="form-control form-control-sm risk-probability" 
                       name="risk_probability[]" 
                       rows="2"
                       placeholder="Например: Средняя"
                       required>${(rowData.probability || '').replace(/"/g, '&quot;')}</textarea>
            </td>
            <td>
                <textarea class="form-control form-control-sm risk-impact" 
                       name="risk_impact[]" 
                       rows="2"
                       placeholder="Например: Сроки НТ"
                       required>${(rowData.impact || '').replace(/"/g, '&quot;')}</textarea>
            </td>
            <td style="text-align: center; vertical-align: middle;">
                <button type="button" 
                        class="btn btn-sm btn-danger remove-risk-row" 
                        title="Удалить строку">
                    <i class="bi bi-trash"></i> Удалить
                </button>
            </td>
        `;
        
        return row;
    }
    
    // Функция для загрузки существующих данных
    function loadExistingRiskData() {
        const risksData = risksTableHidden.value.trim();
        
        if (!risksData) {
            return; // Нет данных - таблица остается пустой
        }
        
        const lines = risksData.split('\n').filter(line => line.trim());
        if (lines.length < 2) {
            return; // Только заголовок или пусто
        }
        
        // Пропускаем заголовок (первая строка)
        for (let i = 1; i < lines.length; i++) {
            const parts = lines[i].split('|').map(p => p.trim());
            if (parts.length >= 3) {
                const rowData = {
                    risk: parts[0] || '',
                    probability: parts[1] || '',
                    impact: parts[2] || ''
                };
                const row = createRiskRow(rowData);
                risksTableTbody.appendChild(row);
            }
        }
        
        updateRiskHiddenField();
    }
    
    // Функция для обновления скрытого поля из визуальной таблицы
    function updateRiskHiddenField() {
        const rows = risksTableTbody.querySelectorAll('tr');
        if (rows.length === 0) {
            risksTableHidden.value = '';
            return;
        }
        
        const parts = [];
        parts.push('Риск|Вероятность возникновения|Влияние'); // Заголовок
        
        rows.forEach(row => {
            const riskInput = row.querySelector('.risk-risk');
            const probabilityInput = row.querySelector('.risk-probability');
            const impactInput = row.querySelector('.risk-impact');
            
            if (riskInput && probabilityInput && impactInput) {
                const risk = riskInput.value.trim();
                const probability = probabilityInput.value.trim();
                const impact = impactInput.value.trim();
                if (risk || probability || impact) {
                    parts.push(`${risk}|${probability}|${impact}`);
                }
            }
        });
        
        risksTableHidden.value = parts.join('\n');
    }
    
    // Обработчик добавления новой строки
    if (addRiskRowBtn) {
        console.log('Adding click handler to risk row button');
        addRiskRowBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Add risk row button clicked');
            const newRow = createRiskRow();
            risksTableTbody.appendChild(newRow);
            updateRiskHiddenField();
        });
    } else {
        console.error('Add risk row button not found!');
    }
    
    // Обработчик удаления строки
    risksTableTbody.addEventListener('click', function(e) {
        if (e.target.closest('.remove-risk-row')) {
            const row = e.target.closest('tr');
            if (row) {
                row.remove();
                updateRiskHiddenField();
            }
        }
    });
    
    // Обновляем скрытое поле при изменении полей
    risksTableTbody.addEventListener('input', function() {
        updateRiskHiddenField();
    });
    
    risksTableTbody.addEventListener('change', function() {
        updateRiskHiddenField();
    });
    
    // Загружаем существующие данные при загрузке страницы
    loadExistingRiskData();
    
    // Обновляем скрытое поле перед отправкой формы
    const form = document.querySelector('form[action*="/mnt/"]');
    if (form) {
        form.addEventListener('submit', function() {
            updateRiskHiddenField();
        });
    }
});
</script>

<!-- JavaScript для таблицы сравнения стендов -->
<script>
// Управление таблицей сравнения стендов
document.addEventListener('DOMContentLoaded', function() {
    const standComparisonTableHidden = document.getElementById('stand_comparison_table');
    const standComparisonTableTbody = document.getElementById('stand_comparison_tbody');
    const addStandComparisonRowBtn = document.getElementById('add_stand_comparison_row_btn');
    
    if (!standComparisonTableHidden || !standComparisonTableTbody) {
        console.error('Stand comparison table elements not found');
        return;
    }
    
    console.log('Stand comparison table script loaded, button:', addStandComparisonRowBtn);
    
    // Функция для создания новой строки в таблице
    function createStandComparisonRow(rowData = { system: '', parameter: '', test_value: '', prod_value: '' }) {
        const row = document.createElement('tr');
        
        row.innerHTML = `
            <td>
                <textarea class="form-control form-control-sm stand-system" 
                       name="stand_system[]" 
                       rows="2"
                       placeholder="Например: Кластер из трёх нод"
                       required>${(rowData.system || '').replace(/"/g, '&quot;')}</textarea>
            </td>
            <td>
                <textarea class="form-control form-control-sm stand-parameter" 
                       name="stand_parameter[]" 
                       rows="2"
                       placeholder="Например: Имена серверов"
                       required>${(rowData.parameter || '').replace(/"/g, '&quot;')}</textarea>
            </td>
            <td>
                <textarea class="form-control form-control-sm stand-test-value" 
                       name="stand_test_value[]" 
                       rows="2"
                       placeholder="Например: site-dbapp-lt-01"
                       required>${(rowData.test_value || '').replace(/"/g, '&quot;')}</textarea>
            </td>
            <td>
                <textarea class="form-control form-control-sm stand-prod-value" 
                       name="stand_prod_value[]" 
                       rows="2"
                       placeholder="Например: Site-dbapp-p-05"
                       required>${(rowData.prod_value || '').replace(/"/g, '&quot;')}</textarea>
            </td>
            <td style="text-align: center; vertical-align: middle;">
                <button type="button" 
                        class="btn btn-sm btn-danger remove-stand-comparison-row" 
                        title="Удалить строку">
                    <i class="bi bi-trash"></i> Удалить
                </button>
            </td>
        `;
        
        return row;
    }
    
    // Функция для загрузки существующих данных
    function loadExistingStandComparisonData() {
        const standComparisonData = standComparisonTableHidden.value.trim();
        
        if (!standComparisonData) {
            return; // Нет данных - таблица остается пустой
        }
        
        const lines = standComparisonData.split('\n').filter(line => line.trim());
        if (lines.length < 2) {
            return; // Только заголовок или пусто
        }
        
        // Пропускаем заголовок (первая строка)
        for (let i = 1; i < lines.length; i++) {
            const parts = lines[i].split('|').map(p => p.trim());
            if (parts.length >= 4) {
                const rowData = {
                    system: parts[0] || '',
                    parameter: parts[1] || '',
                    test_value: parts[2] || '',
                    prod_value: parts[3] || ''
                };
                const row = createStandComparisonRow(rowData);
                standComparisonTableTbody.appendChild(row);
            }
        }
        
        updateStandComparisonHiddenField();
    }
    
    // Функция для обновления скрытого поля из визуальной таблицы
    function updateStandComparisonHiddenField() {
        const rows = standComparisonTableTbody.querySelectorAll('tr');
        if (rows.length === 0) {
            standComparisonTableHidden.value = '';
            return;
        }
        
        const parts = [];
        parts.push('Система|Параметр|Значение на UAT контуре|Значение на продуктивной среде'); // Заголовок
        
        rows.forEach(row => {
            const systemInput = row.querySelector('.stand-system');
            const parameterInput = row.querySelector('.stand-parameter');
            const testValueInput = row.querySelector('.stand-test-value');
            const prodValueInput = row.querySelector('.stand-prod-value');
            
            if (systemInput && parameterInput && testValueInput && prodValueInput) {
                const system = systemInput.value.trim();
                const parameter = parameterInput.value.trim();
                const testValue = testValueInput.value.trim();
                const prodValue = prodValueInput.value.trim();
                if (system || parameter || testValue || prodValue) {
                    parts.push(`${system}|${parameter}|${testValue}|${prodValue}`);
                }
            }
        });
        
        standComparisonTableHidden.value = parts.join('\n');
    }
    
    // Обработчик добавления новой строки
    if (addStandComparisonRowBtn) {
        console.log('Adding click handler to stand comparison row button');
        addStandComparisonRowBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Add stand comparison row button clicked');
            const newRow = createStandComparisonRow();
            standComparisonTableTbody.appendChild(newRow);
            updateStandComparisonHiddenField();
        });
    } else {
        console.error('Add stand comparison row button not found!');
    }
    
    // Обработчик удаления строки
    standComparisonTableTbody.addEventListener('click', function(e) {
        if (e.target.closest('.remove-stand-comparison-row')) {
            const row = e.target.closest('tr');
            if (row) {
                row.remove();
                updateStandComparisonHiddenField();
            }
        }
    });
    
    // Обновляем скрытое поле при изменении полей
    standComparisonTableTbody.addEventListener('input', function() {
        updateStandComparisonHiddenField();
    });
    
    standComparisonTableTbody.addEventListener('change', function() {
        updateStandComparisonHiddenField();
    });
    
    // Загружаем существующие данные при загрузке страницы
    loadExistingStandComparisonData();
    
    // Обновляем скрытое поле перед отправкой формы
    const form = document.querySelector('form[action*="/mnt/"]');
    if (form) {
        form.addEventListener('submit', function() {
            updateStandComparisonHiddenField();
        });
    }
});
</script>

<!-- JavaScript для таблицы планируемых тестов -->
<script>
// Управление таблицей планируемых тестов
document.addEventListener('DOMContentLoaded', function() {
    const plannedTestsTableHidden = document.getElementById('planned_tests_table');
    const plannedTestsTableTbody = document.getElementById('planned_tests_tbody');
    const addPlannedTestRowBtn = document.getElementById('add_planned_test_row_btn');
    
    if (!plannedTestsTableHidden || !plannedTestsTableTbody) {
        console.error('Planned tests table elements not found');
        return;
    }
    
    console.log('Planned tests table script loaded, button:', addPlannedTestRowBtn);
    
    // Функция для создания новой строки в таблице
    function createPlannedTestRow(rowData = { number: '', test: '', duration: '', description: '' }) {
        const row = document.createElement('tr');
        
        // Автоматически определяем номер, если не указан
        let rowNumber = rowData.number;
        if (!rowNumber) {
            const existingRows = plannedTestsTableTbody.querySelectorAll('tr');
            rowNumber = (existingRows.length + 1).toString();
        }
        
        row.innerHTML = `
            <td style="text-align: center; vertical-align: middle;">
                <span class="planned-test-number" style="font-weight: bold; font-size: 1.1rem; color: #212529;">${rowNumber}</span>
                <input type="hidden" name="planned_test_number[]" value="${rowNumber}">
            </td>
            <td>
                <textarea class="form-control form-control-sm planned-test-name" 
                       name="planned_test_name[]" 
                       rows="2"
                       placeholder="Например: Поиск максимума"
                       required>${(rowData.test || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</textarea>
            </td>
            <td>
                <textarea class="form-control form-control-sm planned-test-duration" 
                       name="planned_test_duration[]" 
                       rows="2"
                       placeholder="Например: 2 часа"
                       required>${(rowData.duration || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</textarea>
            </td>
            <td>
                <textarea class="form-control form-control-sm planned-test-description" 
                       name="planned_test_description[]" 
                       rows="3"
                       placeholder="Описание теста"
                       required>${(rowData.description || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</textarea>
            </td>
            <td style="text-align: center; vertical-align: middle;">
                <button type="button" 
                        class="btn btn-sm btn-danger remove-planned-test-row" 
                        title="Удалить строку">
                    <i class="bi bi-trash"></i> Удалить
                </button>
            </td>
        `;
        
        return row;
    }
    
    // Функция для загрузки существующих данных
    function loadExistingPlannedTestData() {
        const plannedTestsData = plannedTestsTableHidden.value.trim();
        
        if (!plannedTestsData) {
            return; // Нет данных - таблица остается пустой
        }
        
        const lines = plannedTestsData.split('\n').filter(line => line.trim());
        if (lines.length < 2) {
            return; // Только заголовок или пусто
        }
        
        // Пропускаем заголовок (первая строка)
        for (let i = 1; i < lines.length; i++) {
            const parts = lines[i].split('|').map(p => p.trim());
            if (parts.length >= 4) {
                const rowData = {
                    number: parts[0] || '',
                    test: parts[1] || '',
                    duration: parts[2] || '',
                    description: parts[3] || ''
                };
                const row = createPlannedTestRow(rowData);
                plannedTestsTableTbody.appendChild(row);
            }
        }
        
        updatePlannedTestHiddenField();
    }
    
    // Функция для обновления скрытого поля из визуальной таблицы
    function updatePlannedTestHiddenField() {
        const rows = plannedTestsTableTbody.querySelectorAll('tr');
        if (rows.length === 0) {
            plannedTestsTableHidden.value = '';
            return;
        }
        
        const parts = [];
        parts.push('№|Тест|Длительность теста|Описание теста'); // Заголовок
        
        rows.forEach(row => {
            const numberHidden = row.querySelector('input[name="planned_test_number[]"]');
            const testInput = row.querySelector('.planned-test-name');
            const durationInput = row.querySelector('.planned-test-duration');
            const descriptionInput = row.querySelector('.planned-test-description');
            
            if (numberHidden && testInput && durationInput && descriptionInput) {
                const number = numberHidden.value.trim();
                const test = testInput.value.trim();
                const duration = durationInput.value.trim();
                const description = descriptionInput.value.trim();
                if (number || test || duration || description) {
                    parts.push(`${number}|${test}|${duration}|${description}`);
                }
            }
        });
        
        plannedTestsTableHidden.value = parts.join('\n');
    }
    
    // Функция для перенумерации всех строк
    function renumberRows() {
        const rows = plannedTestsTableTbody.querySelectorAll('tr');
        rows.forEach((row, index) => {
            const numberSpan = row.querySelector('.planned-test-number');
            const numberHidden = row.querySelector('input[name="planned_test_number[]"]');
            const newNumber = (index + 1).toString();
            if (numberSpan) {
                numberSpan.textContent = newNumber;
            }
            if (numberHidden) {
                numberHidden.value = newNumber;
            }
        });
    }
    
    // Обработчик добавления новой строки
    if (addPlannedTestRowBtn) {
        console.log('Adding click handler to planned test row button');
        addPlannedTestRowBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Add planned test row button clicked');
            const newRow = createPlannedTestRow();
            plannedTestsTableTbody.appendChild(newRow);
            renumberRows(); // Перенумеровываем все строки
            updatePlannedTestHiddenField();
        });
    } else {
        console.error('Add planned test row button not found!');
    }
    
    // Обработчик удаления строки
    plannedTestsTableTbody.addEventListener('click', function(e) {
        if (e.target.closest('.remove-planned-test-row')) {
            const row = e.target.closest('tr');
            if (row) {
                row.remove();
                renumberRows(); // Перенумеровываем все строки после удаления
                updatePlannedTestHiddenField();
            }
        }
    });
    
    // Обновляем скрытое поле при изменении полей
    plannedTestsTableTbody.addEventListener('input', function() {
        updatePlannedTestHiddenField();
    });
    
    plannedTestsTableTbody.addEventListener('change', function() {
        updatePlannedTestHiddenField();
    });
    
    // Загружаем существующие данные при загрузке страницы
    loadExistingPlannedTestData();
    
    // Обновляем скрытое поле перед отправкой формы
    const form = document.querySelector('form[action*="/mnt/"]');
    if (form) {
        form.addEventListener('submit', function() {
            updatePlannedTestHiddenField();
        });
    }
});
</script>

<!-- JavaScript для таблицы листа согласования -->
<script>
// Управление таблицей листа согласования
document.addEventListener('DOMContentLoaded', function() {
    const approvalTableHidden = document.getElementById('approval_list_table');
    const approvalTableTbody = document.getElementById('approval_list_tbody');
    const addApprovalRowBtn = document.getElementById('add_approval_row_btn');
    
    if (!approvalTableHidden || !approvalTableTbody) {
        console.error('Approval table elements not found');
        return;
    }
    
    console.log('Approval table script loaded, button:', addApprovalRowBtn);
    
    // Функция для форматирования даты в формат DD.MM.YYYY
    function formatDate(date) {
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}.${month}.${year}`;
    }
    
    // Функция для преобразования даты в формат YYYY-MM-DD для input[type="date"]
    function formatDateForInput(date) {
        if (!date) {
            const today = new Date();
            return today.toISOString().split('T')[0]; // YYYY-MM-DD
        }
        // Если дата уже в формате YYYY-MM-DD, возвращаем как есть
        if (date.match(/^\d{4}-\d{2}-\d{2}$/)) {
            return date;
        }
        // Если дата в формате DD.MM.YYYY, преобразуем в YYYY-MM-DD
        if (date.match(/^\d{2}\.\d{2}\.\d{4}$/)) {
            const [day, month, year] = date.split('.');
            return `${year}-${month}-${day}`;
        }
        // Если это объект Date, преобразуем
        if (date instanceof Date) {
            return date.toISOString().split('T')[0];
        }
        // По умолчанию - текущая дата
        return new Date().toISOString().split('T')[0];
    }
    
    // Функция для создания новой строки в таблице
    function createApprovalRow(rowData = { fio: '', position: '', signature: '', date: null }) {
        const row = document.createElement('tr');
        const dateValue = formatDateForInput(rowData.date);
        row.innerHTML = `
            <td>
                <input type="text" 
                       class="form-control form-control-sm approval-fio" 
                       name="approval_fio[]" 
                       value="${rowData.fio || ''}"
                       placeholder="Фамилия И.О."
                       required>
            </td>
            <td>
                <input type="text" 
                       class="form-control form-control-sm approval-position" 
                       name="approval_position[]" 
                       value="${rowData.position || ''}"
                       placeholder="Должность"
                       required>
            </td>
            <td>
                <input type="text" 
                       class="form-control form-control-sm approval-signature" 
                       name="approval_signature[]" 
                       value="${rowData.signature || ''}"
                       placeholder="Подпись (необязательно)">
            </td>
            <td>
                <input type="date" 
                       class="form-control form-control-sm approval-date" 
                       name="approval_date[]" 
                       value="${dateValue}"
                       required>
            </td>
            <td style="text-align: center; vertical-align: middle;">
                <button type="button" 
                        class="btn btn-sm btn-danger remove-approval-row" 
                        title="Удалить строку">
                    <i class="bi bi-trash"></i> Удалить
                </button>
            </td>
        `;
        return row;
    }
    
    // Функция для загрузки существующих данных
    function loadExistingApprovalData() {
        const approvalData = approvalTableHidden.value.trim();
        
        if (!approvalData) {
            // Если данных нет - добавляем одну пустую строку по умолчанию
            const defaultRow = createApprovalRow();
            approvalTableTbody.appendChild(defaultRow);
            updateApprovalHiddenField();
            return;
        }
        
        const lines = approvalData.split('\n').filter(line => line.trim());
        if (lines.length < 2) {
            // Только заголовок или пусто - добавляем одну пустую строку
            const defaultRow = createApprovalRow();
            approvalTableTbody.appendChild(defaultRow);
            updateApprovalHiddenField();
            return;
        }
        
        // Пропускаем заголовок (первая строка)
        for (let i = 1; i < lines.length; i++) {
            const parts = lines[i].split('|').map(p => p.trim());
            if (parts.length >= 4) {
                const rowData = {
                    fio: parts[0] || '',
                    position: parts[1] || '',
                    signature: parts[2] || '',
                    date: parts[3] || null // formatDateForInput обработает null и преобразует в нужный формат
                };
                const row = createApprovalRow(rowData);
                approvalTableTbody.appendChild(row);
            }
        }
        
        updateApprovalHiddenField();
    }
    
    // Функция для обновления скрытого поля из визуальной таблицы
    function updateApprovalHiddenField() {
        const rows = approvalTableTbody.querySelectorAll('tr');
        if (rows.length === 0) {
            approvalTableHidden.value = '';
            return;
        }
        
        const parts = [];
        parts.push('ФИО|Должность|Подпись|Дата'); // Заголовок
        
        rows.forEach(row => {
            const fioInput = row.querySelector('.approval-fio');
            const positionInput = row.querySelector('.approval-position');
            const signatureInput = row.querySelector('.approval-signature');
            const dateInput = row.querySelector('.approval-date');
            
            if (fioInput && positionInput && signatureInput && dateInput) {
                const fio = fioInput.value.trim();
                const position = positionInput.value.trim();
                const signature = signatureInput.value.trim();
                let date = dateInput.value.trim();
                
                // Если дата в формате YYYY-MM-DD, преобразуем в DD.MM.YYYY
                if (date && date.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    const [year, month, day] = date.split('-');
                    date = `${day}.${month}.${year}`;
                }
                
                parts.push(`${fio}|${position}|${signature}|${date}`);
            }
        });
        
        approvalTableHidden.value = parts.join('\n');
    }
    
    // Обработчик добавления новой строки
    if (addApprovalRowBtn) {
        console.log('Adding click handler to approval row button');
        addApprovalRowBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Add approval row button clicked');
            const newRow = createApprovalRow();
            approvalTableTbody.appendChild(newRow);
            updateApprovalHiddenField();
        });
    } else {
        console.error('Add approval row button not found!');
    }
    
    // Обработчик удаления строки
    approvalTableTbody.addEventListener('click', function(e) {
        if (e.target.closest('.remove-approval-row')) {
            const row = e.target.closest('tr');
            if (row) {
                // Не позволяем удалить последнюю строку
                if (approvalTableTbody.querySelectorAll('tr').length > 1) {
                    row.remove();
                    updateApprovalHiddenField();
                } else {
                    alert('Должна быть хотя бы одна строка в таблице');
                }
            }
        }
    });
    
    // Обновляем скрытое поле при изменении полей
    approvalTableTbody.addEventListener('input', function() {
        updateApprovalHiddenField();
    });
    
    approvalTableTbody.addEventListener('change', function() {
        updateApprovalHiddenField();
    });
    
    // Загружаем существующие данные при загрузке страницы
    loadExistingApprovalData();
    
    // Обновляем скрытое поле перед отправкой формы
    const form = document.querySelector('form[action*="/mnt/"]');
    if (form) {
        form.addEventListener('submit', function() {
            updateApprovalHiddenField();
        });
    }
});
</script>

<!-- JavaScript для таблицы требований к объемам данных -->
<script>
// Управление таблицей требований к объемам данных
document.addEventListener('DOMContentLoaded', function() {
    const databasePreparationTableHidden = document.getElementById('database_preparation_table');
    const databasePreparationTableTbody = document.getElementById('database_preparation_tbody');
    const addDatabasePreparationRowBtn = document.getElementById('add_database_preparation_row_btn');
    
    if (!databasePreparationTableHidden || !databasePreparationTableTbody) {
        console.error('Database preparation table elements not found');
        return;
    }
    
    console.log('Database preparation table script loaded, button:', addDatabasePreparationRowBtn);
    
    // Функция для создания новой строки в таблице
    function createDatabasePreparationRow(rowData = { schema_table: '', current_rows: '', growth_per_day: '' }) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <textarea class="form-control form-control-sm database-prep-schema-table" 
                       name="database_prep_schema_table[]" 
                       rows="2"
                       placeholder="Например: public.users"
                       required>${rowData.schema_table || ''}</textarea>
            </td>
            <td>
                <textarea class="form-control form-control-sm database-prep-current-rows" 
                       name="database_prep_current_rows[]" 
                       rows="2"
                       placeholder="Например: 1000000"
                       required>${rowData.current_rows || ''}</textarea>
            </td>
            <td>
                <textarea class="form-control form-control-sm database-prep-growth-per-day" 
                       name="database_prep_growth_per_day[]" 
                       rows="2"
                       placeholder="Например: 1000"
                       required>${rowData.growth_per_day || ''}</textarea>
            </td>
            <td style="text-align: center; vertical-align: middle;">
                <button type="button" 
                        class="btn btn-sm btn-danger remove-database-prep-row" 
                        title="Удалить строку">
                    <i class="bi bi-trash"></i> Удалить
                </button>
            </td>
        `;
        return row;
    }
    
    // Функция для загрузки существующих данных
    function loadExistingDatabasePreparationData() {
        const databasePreparationData = databasePreparationTableHidden.value.trim();
        
        if (!databasePreparationData) {
            return; // Нет данных - таблица остается пустой
        }
        
        const lines = databasePreparationData.split('\n').filter(line => line.trim());
        if (lines.length < 2) {
            return; // Только заголовок или пусто
        }
        
        // Пропускаем заголовок (первая строка)
        for (let i = 1; i < lines.length; i++) {
            const parts = lines[i].split('|').map(p => p.trim());
            if (parts.length >= 3) {
                const rowData = {
                    schema_table: parts[0] || '',
                    current_rows: parts[1] || '',
                    growth_per_day: parts[2] || ''
                };
                const row = createDatabasePreparationRow(rowData);
                databasePreparationTableTbody.appendChild(row);
            }
        }
        
        updateDatabasePreparationHiddenField();
    }
    
    // Функция для обновления скрытого поля из визуальной таблицы
    function updateDatabasePreparationHiddenField() {
        const rows = databasePreparationTableTbody.querySelectorAll('tr');
        if (rows.length === 0) {
            databasePreparationTableHidden.value = '';
            return;
        }
        
        const parts = [];
        parts.push('Схема.Таблица|Текущее кол-во строк в таблице|Прогноз роста в день'); // Заголовок
        
        rows.forEach(row => {
            const schemaTableInput = row.querySelector('.database-prep-schema-table');
            const currentRowsInput = row.querySelector('.database-prep-current-rows');
            const growthPerDayInput = row.querySelector('.database-prep-growth-per-day');
            
            if (schemaTableInput && currentRowsInput && growthPerDayInput) {
                const schemaTable = schemaTableInput.value.trim();
                const currentRows = currentRowsInput.value.trim();
                const growthPerDay = growthPerDayInput.value.trim();
                if (schemaTable || currentRows || growthPerDay) {
                    parts.push(`${schemaTable}|${currentRows}|${growthPerDay}`);
                }
            }
        });
        
        databasePreparationTableHidden.value = parts.join('\n');
    }
    
    // Обработчик добавления новой строки
    if (addDatabasePreparationRowBtn) {
        console.log('Adding click handler to database preparation row button');
        addDatabasePreparationRowBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Add database preparation row button clicked');
            const newRow = createDatabasePreparationRow();
            databasePreparationTableTbody.appendChild(newRow);
            updateDatabasePreparationHiddenField();
        });
    } else {
        console.error('Add database preparation row button not found!');
    }
    
    // Обработчик удаления строки
    databasePreparationTableTbody.addEventListener('click', function(e) {
        if (e.target.closest('.remove-database-prep-row')) {
            const row = e.target.closest('tr');
            if (row) {
                row.remove();
                updateDatabasePreparationHiddenField();
            }
        }
    });
    
    // Обновляем скрытое поле при изменении полей
    databasePreparationTableTbody.addEventListener('input', function() {
        updateDatabasePreparationHiddenField();
    });
    
    databasePreparationTableTbody.addEventListener('change', function() {
        updateDatabasePreparationHiddenField();
    });
    
    // Загружаем существующие данные при загрузке страницы
    loadExistingDatabasePreparationData();
    
    // Обновляем скрытое поле перед отправкой формы
    const form = document.querySelector('form[action*="/mnt/"]');
    if (form) {
        form.addEventListener('submit', function() {
            updateDatabasePreparationHiddenField();
        });
    }
});
</script>
<!-- JavaScript для таблицы профилей нагрузки -->
<script>
// Управление таблицей профилей нагрузки
document.addEventListener('DOMContentLoaded', function() {
    const loadProfilesTableHidden = document.getElementById('load_profiles_table');
    const loadProfilesTableTbody = document.getElementById('load_profiles_tbody');
    const addLoadProfilesRowBtn = document.getElementById('add_load_profiles_row_btn');
    
    if (!loadProfilesTableHidden || !loadProfilesTableTbody) {
        console.error('Load profiles table elements not found');
        return;
    }
    
    console.log('Load profiles table script loaded, button:', addLoadProfilesRowBtn);
    
    // Функция для создания новой строки в таблице
    function createLoadProfilesRow(rowData = { page_name: '', intensity: '' }) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <textarea class="form-control form-control-sm load-profile-page-name" 
                       name="load_profile_page_name[]" 
                       rows="2"
                       placeholder="Название страницы"
                       required>${rowData.page_name || ''}</textarea>
            </td>
            <td>
                <textarea class="form-control form-control-sm load-profile-intensity" 
                       name="load_profile_intensity[]" 
                       rows="2"
                       placeholder="Интенсивность, операций/минута"
                       required>${rowData.intensity || ''}</textarea>
            </td>
            <td style="text-align: center; vertical-align: middle;">
                <button type="button" 
                        class="btn btn-sm btn-danger remove-load-profile-row" 
                        title="Удалить строку">
                    <i class="bi bi-trash"></i> Удалить
                </button>
            </td>
        `;
        return row;
    }
    
    // Функция для загрузки существующих данных
    function loadExistingLoadProfilesData() {
        const loadProfilesData = loadProfilesTableHidden.value.trim();
        
        if (!loadProfilesData) {
            return; // Нет данных - таблица остается пустой
        }
        
        const lines = loadProfilesData.split('\n').filter(line => line.trim());
        if (lines.length < 2) {
            return; // Только заголовок или пусто
        }
        
        // Пропускаем заголовок (первая строка)
        for (let i = 1; i < lines.length; i++) {
            const parts = lines[i].split('|').map(p => p.trim());
            if (parts.length >= 2) {
                const rowData = {
                    page_name: parts[0] || '',
                    intensity: parts[1] || ''
                };
                const row = createLoadProfilesRow(rowData);
                loadProfilesTableTbody.appendChild(row);
            }
        }
        
        updateLoadProfilesHiddenField();
    }
    
    // Функция для обновления скрытого поля из визуальной таблицы
    function updateLoadProfilesHiddenField() {
        const rows = loadProfilesTableTbody.querySelectorAll('tr');
        if (rows.length === 0) {
            loadProfilesTableHidden.value = '';
            return;
        }
        
        const parts = [];
        parts.push('Название страниц|Интенсивность нагрузки, операций\\минута'); // Заголовок
        
        rows.forEach(row => {
            const pageNameInput = row.querySelector('.load-profile-page-name');
            const intensityInput = row.querySelector('.load-profile-intensity');
            
            if (pageNameInput && intensityInput) {
                const pageName = pageNameInput.value.trim();
                const intensity = intensityInput.value.trim();
                if (pageName || intensity) {
                    parts.push(`${pageName}|${intensity}`);
                }
            }
        });
        
        loadProfilesTableHidden.value = parts.join('\n');
    }
    
    // Обработчик добавления новой строки
    if (addLoadProfilesRowBtn) {
        console.log('Adding click handler to load profiles row button');
        addLoadProfilesRowBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Add load profiles row button clicked');
            const newRow = createLoadProfilesRow();
            loadProfilesTableTbody.appendChild(newRow);
            updateLoadProfilesHiddenField();
        });
    } else {
        console.error('Add load profiles row button not found!');
    }
    
    // Обработчик удаления строки
    loadProfilesTableTbody.addEventListener('click', function(e) {
        if (e.target.closest('.remove-load-profile-row')) {
            const row = e.target.closest('tr');
            if (row) {
                row.remove();
                updateLoadProfilesHiddenField();
            }
        }
    });
    
    // Обновляем скрытое поле при изменении полей
    loadProfilesTableTbody.addEventListener('input', function() {
        updateLoadProfilesHiddenField();
    });
    
    loadProfilesTableTbody.addEventListener('change', function() {
        updateLoadProfilesHiddenField();
    });
    
    // Загружаем существующие данные при загрузке страницы
    loadExistingLoadProfilesData();
    
    // Обновляем скрытое поле перед отправкой формы
    const form = document.querySelector('form[action*="/mnt/"]');
    if (form) {
        form.addEventListener('submit', function() {
            updateLoadProfilesHiddenField();
        });
    }
});
</script>
<!-- JavaScript для таблицы сценариев использования -->
<script>
// Управление таблицей сценариев использования
document.addEventListener('DOMContentLoaded', function() {
    const useScenariosTableHidden = document.getElementById('use_scenarios_table');
    const useScenariosTableTbody = document.getElementById('use_scenarios_tbody');
    const addUseScenariosRowBtn = document.getElementById('add_use_scenarios_row_btn');
    
    if (!useScenariosTableHidden || !useScenariosTableTbody) {
        console.error('Use scenarios table elements not found');
        return;
    }
    
    console.log('Use scenarios table script loaded, button:', addUseScenariosRowBtn);
    
    // Функция для создания новой строки в таблице
    function createUseScenariosRow(rowData = { steps: '', intensity: '' }) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <textarea class="form-control form-control-sm use-scenario-steps" 
                       name="use_scenario_steps[]" 
                       rows="2"
                       placeholder="Шаги сценария"
                       required>${rowData.steps || ''}</textarea>
            </td>
            <td>
                <textarea class="form-control form-control-sm use-scenario-intensity" 
                       name="use_scenario_intensity[]" 
                       rows="2"
                       placeholder="Интенсивность, операций/минута"
                       required>${rowData.intensity || ''}</textarea>
            </td>
            <td style="text-align: center; vertical-align: middle;">
                <button type="button" 
                        class="btn btn-sm btn-danger remove-use-scenario-row" 
                        title="Удалить строку">
                    <i class="bi bi-trash"></i> Удалить
                </button>
            </td>
        `;
        return row;
    }
    
    // Функция для загрузки существующих данных
    function loadExistingUseScenariosData() {
        const useScenariosData = useScenariosTableHidden.value.trim();
        
        if (!useScenariosData) {
            return; // Нет данных - таблица остается пустой
        }
        
        const lines = useScenariosData.split('\n').filter(line => line.trim());
        if (lines.length < 2) {
            return; // Только заголовок или пусто
        }
        
        // Пропускаем заголовок (первая строка)
        for (let i = 1; i < lines.length; i++) {
            const parts = lines[i].split('|').map(p => p.trim());
            if (parts.length >= 2) {
                const rowData = {
                    steps: parts[0] || '',
                    intensity: parts[1] || ''
                };
                const row = createUseScenariosRow(rowData);
                useScenariosTableTbody.appendChild(row);
            }
        }
        
        updateUseScenariosHiddenField();
    }
    
    // Функция для обновления скрытого поля из визуальной таблицы
    function updateUseScenariosHiddenField() {
        const rows = useScenariosTableTbody.querySelectorAll('tr');
        if (rows.length === 0) {
            useScenariosTableHidden.value = '';
            return;
        }
        
        const parts = [];
        parts.push('Шаги|Интенсивность нагрузки, операций\\минута принятая за 100%'); // Заголовок
        
        rows.forEach(row => {
            const stepsInput = row.querySelector('.use-scenario-steps');
            const intensityInput = row.querySelector('.use-scenario-intensity');
            
            if (stepsInput && intensityInput) {
                const steps = stepsInput.value.trim();
                const intensity = intensityInput.value.trim();
                if (steps || intensity) {
                    parts.push(`${steps}|${intensity}`);
                }
            }
        });
        
        useScenariosTableHidden.value = parts.join('\n');
    }
    
    // Обработчик добавления новой строки
    if (addUseScenariosRowBtn) {
        console.log('Adding click handler to use scenarios row button');
        addUseScenariosRowBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Add use scenarios row button clicked');
            const newRow = createUseScenariosRow();
            useScenariosTableTbody.appendChild(newRow);
            updateUseScenariosHiddenField();
        });
    } else {
        console.error('Add use scenarios row button not found!');
    }
    
    // Обработчик удаления строки
    useScenariosTableTbody.addEventListener('click', function(e) {
        if (e.target.closest('.remove-use-scenario-row')) {
            const row = e.target.closest('tr');
            if (row) {
                row.remove();
                updateUseScenariosHiddenField();
            }
        }
    });
    
    // Обновляем скрытое поле при изменении полей
    useScenariosTableTbody.addEventListener('input', function() {
        updateUseScenariosHiddenField();
    });
    
    useScenariosTableTbody.addEventListener('change', function() {
        updateUseScenariosHiddenField();
    });
    
    // Загружаем существующие данные при загрузке страницы
    loadExistingUseScenariosData();
    
    // Обновляем скрытое поле перед отправкой формы
    const form = document.querySelector('form[action*="/mnt/"]');
    if (form) {
        form.addEventListener('submit', function() {
            updateUseScenariosHiddenField();
        });
    }
});
</script>
<!-- JavaScript для таблицы средств мониторинга -->
<script>
// Управление таблицей средств мониторинга
document.addEventListener('DOMContentLoaded', function() {
    const monitoringToolsTableHidden = document.getElementById('monitoring_tools_table');
    const monitoringToolsTableTbody = document.getElementById('monitoring_tools_tbody');
    const addMonitoringToolsRowBtn = document.getElementById('add_monitoring_tools_row_btn');
    
    if (!monitoringToolsTableHidden || !monitoringToolsTableTbody) {
        console.error('Monitoring tools table elements not found');
        return;
    }
    
    console.log('Monitoring tools table script loaded, button:', addMonitoringToolsRowBtn);
    
    // Функция для создания новой строки в таблице
    function createMonitoringToolsRow(rowData = { name: '', role: '', endpoint: '' }) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <textarea class="form-control form-control-sm monitoring-tool-name" 
                       name="monitoring_tool_name[]" 
                       rows="2"
                       placeholder="Например: Grafana"
                       required>${rowData.name || ''}</textarea>
            </td>
            <td>
                <textarea class="form-control form-control-sm monitoring-tool-role" 
                       name="monitoring_tool_role[]" 
                       rows="2"
                       placeholder="Роль инструмента"
                       required>${rowData.role || ''}</textarea>
            </td>
            <td>
                <textarea class="form-control form-control-sm monitoring-tool-endpoint" 
                       name="monitoring_tool_endpoint[]" 
                       rows="2"
                       placeholder="Эндпоинт (URI)">${rowData.endpoint || ''}</textarea>
            </td>
            <td style="text-align: center; vertical-align: middle;">
                <button type="button" 
                        class="btn btn-sm btn-danger remove-monitoring-tool-row" 
                        title="Удалить строку">
                    <i class="bi bi-trash"></i> Удалить
                </button>
            </td>
        `;
        return row;
    }
    
    // Функция для загрузки существующих данных
    function loadExistingMonitoringToolsData() {
        const monitoringToolsData = monitoringToolsTableHidden.value.trim();
        
        if (!monitoringToolsData) {
            return; // Нет данных - таблица остается пустой
        }
        
        const lines = monitoringToolsData.split('\n').filter(line => line.trim());
        if (lines.length < 2) {
            return; // Только заголовок или пусто
        }
        
        // Пропускаем заголовок (первая строка)
        for (let i = 1; i < lines.length; i++) {
            const parts = lines[i].split('|').map(p => p.trim());
            if (parts.length >= 2) {
                const rowData = {
                    name: parts[0] || '',
                    role: parts[1] || '',
                    endpoint: parts[2] || ''
                };
                const row = createMonitoringToolsRow(rowData);
                monitoringToolsTableTbody.appendChild(row);
            }
        }
        
        updateMonitoringToolsHiddenField();
    }
    
    // Функция для обновления скрытого поля из визуальной таблицы
    function updateMonitoringToolsHiddenField() {
        const rows = monitoringToolsTableTbody.querySelectorAll('tr');
        if (rows.length === 0) {
            monitoringToolsTableHidden.value = '';
            return;
        }
        
        const parts = [];
        parts.push('Наименование|Роль|Эндпоинт (URI)'); // Заголовок
        
        rows.forEach(row => {
            const nameInput = row.querySelector('.monitoring-tool-name');
            const roleInput = row.querySelector('.monitoring-tool-role');
            const endpointInput = row.querySelector('.monitoring-tool-endpoint');
            
            if (nameInput && roleInput) {
                const name = nameInput.value.trim();
                const role = roleInput.value.trim();
                const endpoint = endpointInput ? endpointInput.value.trim() : '';
                if (name || role || endpoint) {
                    parts.push(`${name}|${role}|${endpoint}`);
                }
            }
        });
        
        monitoringToolsTableHidden.value = parts.join('\n');
    }
    
    // Обработчик добавления новой строки
    if (addMonitoringToolsRowBtn) {
        console.log('Adding click handler to monitoring tools row button');
        addMonitoringToolsRowBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Add monitoring tools row button clicked');
            const newRow = createMonitoringToolsRow();
            monitoringToolsTableTbody.appendChild(newRow);
            updateMonitoringToolsHiddenField();
        });
    } else {
        console.error('Add monitoring tools row button not found!');
    }
    
    // Обработчик удаления строки
    monitoringToolsTableTbody.addEventListener('click', function(e) {
        if (e.target.closest('.remove-monitoring-tool-row')) {
            const row = e.target.closest('tr');
            if (row) {
                row.remove();
                updateMonitoringToolsHiddenField();
            }
        }
    });
    
    // Обновляем скрытое поле при изменении полей
    monitoringToolsTableTbody.addEventListener('input', function() {
        updateMonitoringToolsHiddenField();
    });
    
    monitoringToolsTableTbody.addEventListener('change', function() {
        updateMonitoringToolsHiddenField();
    });
    
    // Загружаем существующие данные при загрузке страницы
    loadExistingMonitoringToolsData();
    
    // Обновляем скрытое поле перед отправкой формы
    const form = document.querySelector('form[action*="/mnt/"]');
    if (form) {
        form.addEventListener('submit', function() {
            updateMonitoringToolsHiddenField();
        });
    }
});
</script>
<!-- JavaScript для таблицы метрик системных ресурсов -->
<script>
// Управление таблицей метрик системных ресурсов
document.addEventListener('DOMContentLoaded', function() {
    const systemResourcesTableHidden = document.getElementById('system_resources_table');
    const systemResourcesTableTbody = document.getElementById('system_resources_tbody');
    const addSystemResourcesRowBtn = document.getElementById('add_system_resources_row_btn');
    
    if (!systemResourcesTableHidden || !systemResourcesTableTbody) {
        console.error('System resources table elements not found');
        return;
    }
    
    console.log('System resources table script loaded, button:', addSystemResourcesRowBtn);
    
    // Функция для создания новой строки в таблице
    function createSystemResourcesRow(rowData = { number: '', metric_type: '', collection_method: '', acquisition_method: '', visualization: '' }) {
        const row = document.createElement('tr');
        
        // Автоматически определяем номер, если не указан
        let rowNumber = rowData.number;
        if (!rowNumber) {
            const existingRows = systemResourcesTableTbody.querySelectorAll('tr');
            rowNumber = (existingRows.length + 1).toString();
        }
        
        row.innerHTML = `
            <td style="text-align: center; vertical-align: middle;">
                <span class="system-resource-number-display" style="font-weight: bold; display: inline-block; min-width: 20px;">${rowNumber}</span>
                <input type="hidden" class="system-resource-number" name="system_resource_number[]" value="${rowNumber}">
            </td>
            <td>
                <textarea class="form-control form-control-sm system-resource-metric-type" 
                       name="system_resource_metric_type[]" 
                       rows="2"
                       placeholder="Тип метрики"
                       required>${rowData.metric_type || ''}</textarea>
            </td>
            <td>
                <textarea class="form-control form-control-sm system-resource-collection-method" 
                       name="system_resource_collection_method[]" 
                       rows="2"
                       placeholder="Способ снятия"
                       required>${rowData.collection_method || ''}</textarea>
            </td>
            <td>
                <textarea class="form-control form-control-sm system-resource-acquisition-method" 
                       name="system_resource_acquisition_method[]" 
                       rows="2"
                       placeholder="Способ получения"
                       required>${rowData.acquisition_method || ''}</textarea>
            </td>
            <td>
                <textarea class="form-control form-control-sm system-resource-visualization" 
                       name="system_resource_visualization[]" 
                       rows="2"
                       placeholder="Визуализация">${rowData.visualization || ''}</textarea>
            </td>
            <td style="text-align: center; vertical-align: middle;">
                <button type="button" 
                        class="btn btn-sm btn-danger remove-system-resource-row" 
                        title="Удалить строку">
                    <i class="bi bi-trash"></i> Удалить
                </button>
            </td>
        `;
        return row;
    }
    
    // Функция для перенумерации строк
    function renumberSystemResourcesRows() {
        const rows = systemResourcesTableTbody.querySelectorAll('tr');
        rows.forEach((row, index) => {
            const numberDisplay = row.querySelector('.system-resource-number-display');
            const numberInput = row.querySelector('.system-resource-number');
            const number = (index + 1).toString();
            if (numberDisplay) numberDisplay.textContent = number;
            if (numberInput) numberInput.value = number;
        });
    }
    
    // Функция для загрузки существующих данных
    function loadExistingSystemResourcesData() {
        const systemResourcesData = systemResourcesTableHidden.value.trim();
        
        if (!systemResourcesData) {
            return; // Нет данных - таблица остается пустой
        }
        
        const allLines = systemResourcesData.split('\n');
        if (allLines.length < 2) {
            return; // Только заголовок или пусто
        }
        
        // Парсим строки таблицы
        // Строка таблицы начинается с номера (число|), что помогает отличить её от многострочных полей
        const rows = [];
        let currentRowParts = null;
        let currentCollectionMethod = '';
        
        // Пропускаем заголовок (первая строка)
        for (let i = 1; i < allLines.length; i++) {
            const line = allLines[i].trim();
            if (!line) continue;
            
            // Проверяем, начинается ли строка с числа и | (новая строка таблицы)
            const match = line.match(/^(\d+)\|(.*)$/);
            if (match) {
                // Сохраняем предыдущую строку, если есть
                if (currentRowParts) {
                    currentRowParts[2] = currentCollectionMethod.trim();
                    if (currentRowParts.length >= 4) {
                        rows.push({
                            number: currentRowParts[0] || '',
                            metric_type: currentRowParts[1] || '',
                            collection_method: currentRowParts[2] || '',
                            acquisition_method: currentRowParts[3] || '',
                            visualization: currentRowParts[4] || ''
                        });
                    }
                }
                // Начинаем новую строку
                const parts = line.split('|').map(p => p.trim());
                if (parts.length >= 4) {
                    currentRowParts = parts;
                    currentCollectionMethod = parts[2] || '';
                }
            } else if (currentRowParts) {
                // Это продолжение многострочного поля "Способ снятия"
                currentCollectionMethod += '\n' + line;
            }
        }
        
        // Добавляем последнюю строку
        if (currentRowParts) {
            currentRowParts[2] = currentCollectionMethod.trim();
            if (currentRowParts.length >= 4) {
                rows.push({
                    number: currentRowParts[0] || '',
                    metric_type: currentRowParts[1] || '',
                    collection_method: currentRowParts[2] || '',
                    acquisition_method: currentRowParts[3] || '',
                    visualization: currentRowParts[4] || ''
                });
            }
        }
        
        // Если парсинг не сработал, пробуем простой вариант
        if (rows.length === 0) {
            const lines = systemResourcesData.split('\n').filter(line => line.trim());
            for (let i = 1; i < lines.length; i++) {
                const parts = lines[i].split('|').map(p => p.trim());
                if (parts.length >= 4) {
                    rows.push({
                        number: parts[0] || '',
                        metric_type: parts[1] || '',
                        collection_method: parts[2] || '',
                        acquisition_method: parts[3] || '',
                        visualization: parts[4] || ''
                    });
                }
            }
        }
        
        // Создаем строки таблицы
        rows.forEach(rowData => {
            const row = createSystemResourcesRow(rowData);
            systemResourcesTableTbody.appendChild(row);
        });
        
        renumberSystemResourcesRows();
        updateSystemResourcesHiddenField();
    }
    
    // Функция для обновления скрытого поля из визуальной таблицы
    function updateSystemResourcesHiddenField() {
        const rows = systemResourcesTableTbody.querySelectorAll('tr');
        if (rows.length === 0) {
            systemResourcesTableHidden.value = '';
            return;
        }
        
        const parts = [];
        parts.push('№|Тип метрики|Способ снятия|Способ получения|Визуализация'); // Заголовок
        
        rows.forEach(row => {
            const numberInput = row.querySelector('.system-resource-number');
            const metricTypeInput = row.querySelector('.system-resource-metric-type');
            const collectionMethodInput = row.querySelector('.system-resource-collection-method');
            const acquisitionMethodInput = row.querySelector('.system-resource-acquisition-method');
            const visualizationInput = row.querySelector('.system-resource-visualization');
            
            if (numberInput && metricTypeInput && collectionMethodInput && acquisitionMethodInput) {
                const number = numberInput.value.trim();
                const metricType = metricTypeInput.value.trim();
                const collectionMethod = collectionMethodInput.value.trim();
                const acquisitionMethod = acquisitionMethodInput.value.trim();
                const visualization = visualizationInput ? visualizationInput.value.trim() : '';
                if (metricType || collectionMethod || acquisitionMethod || visualization) {
                    parts.push(`${number}|${metricType}|${collectionMethod}|${acquisitionMethod}|${visualization}`);
                }
            }
        });
        
        systemResourcesTableHidden.value = parts.join('\n');
    }
    
    // Обработчик добавления новой строки
    if (addSystemResourcesRowBtn) {
        console.log('Adding click handler to system resources row button');
        addSystemResourcesRowBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Add system resources row button clicked');
            const newRow = createSystemResourcesRow();
            systemResourcesTableTbody.appendChild(newRow);
            renumberSystemResourcesRows();
            updateSystemResourcesHiddenField();
        });
    } else {
        console.error('Add system resources row button not found!');
    }
    
    // Обработчик удаления строки
    systemResourcesTableTbody.addEventListener('click', function(e) {
        if (e.target.closest('.remove-system-resource-row')) {
            const row = e.target.closest('tr');
            if (row) {
                row.remove();
                renumberSystemResourcesRows();
                updateSystemResourcesHiddenField();
            }
        }
    });
    
    // Обновляем скрытое поле при изменении полей
    systemResourcesTableTbody.addEventListener('input', function() {
        updateSystemResourcesHiddenField();
    });
    
    systemResourcesTableTbody.addEventListener('change', function() {
        updateSystemResourcesHiddenField();
    });
    
    // Загружаем существующие данные при загрузке страницы
    loadExistingSystemResourcesData();
    
    // Обновляем скрытое поле перед отправкой формы
    const form = document.querySelector('form[action*="/mnt/"]');
    if (form) {
        form.addEventListener('submit', function() {
            updateSystemResourcesHiddenField();
        });
    }
});
</script>
<!-- JavaScript для таблицы бизнес-метрик -->
<script>
// Управление таблицей бизнес-метрик
document.addEventListener('DOMContentLoaded', function() {
    const businessMetricsTableHidden = document.getElementById('business_metrics_table');
    const businessMetricsTableTbody = document.getElementById('business_metrics_tbody');
    const addBusinessMetricsRowBtn = document.getElementById('add_business_metrics_row_btn');
    
    if (!businessMetricsTableHidden || !businessMetricsTableTbody) {
        console.error('Business metrics table elements not found');
        return;
    }
    
    console.log('Business metrics table script loaded, button:', addBusinessMetricsRowBtn);
    
    // Функция для создания новой строки в таблице
    function createBusinessMetricsRow(rowData = { metric: '', unit: '' }) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <textarea class="form-control form-control-sm business-metric-metric" 
                       name="business_metric_metric[]" 
                       rows="2"
                       placeholder="Бизнес-метрика"
                       required>${rowData.metric || ''}</textarea>
            </td>
            <td>
                <textarea class="form-control form-control-sm business-metric-unit" 
                       name="business_metric_unit[]" 
                       rows="2"
                       placeholder="Единица измерения">${rowData.unit || ''}</textarea>
            </td>
            <td style="text-align: center; vertical-align: middle;">
                <button type="button" 
                        class="btn btn-sm btn-danger remove-business-metric-row" 
                        title="Удалить строку">
                    <i class="bi bi-trash"></i> Удалить
                </button>
            </td>
        `;
        return row;
    }
    
    // Функция для загрузки существующих данных
    function loadExistingBusinessMetricsData() {
        const businessMetricsData = businessMetricsTableHidden.value.trim();
        
        if (!businessMetricsData) {
            return; // Нет данных - таблица остается пустой
        }
        
        const lines = businessMetricsData.split('\n').filter(line => line.trim());
        if (lines.length < 2) {
            return; // Только заголовок или пусто
        }
        
        // Пропускаем заголовок (первая строка)
        for (let i = 1; i < lines.length; i++) {
            const parts = lines[i].split('|').map(p => p.trim());
            if (parts.length >= 2) {
                const rowData = {
                    metric: parts[0] || '',
                    unit: parts[1] || ''
                };
                const row = createBusinessMetricsRow(rowData);
                businessMetricsTableTbody.appendChild(row);
            }
        }
        
        updateBusinessMetricsHiddenField();
    }
    
    // Функция для обновления скрытого поля из визуальной таблицы
    function updateBusinessMetricsHiddenField() {
        const rows = businessMetricsTableTbody.querySelectorAll('tr');
        if (rows.length === 0) {
            businessMetricsTableHidden.value = '';
            return;
        }
        
        const parts = [];
        parts.push('Бизнес-метрика|Единица измерения'); // Заголовок
        
        rows.forEach(row => {
            const metricInput = row.querySelector('.business-metric-metric');
            const unitInput = row.querySelector('.business-metric-unit');
            
            if (metricInput && unitInput) {
                const metric = metricInput.value.trim();
                const unit = unitInput.value.trim();
                if (metric || unit) {
                    parts.push(`${metric}|${unit}`);
                }
            }
        });
        
        businessMetricsTableHidden.value = parts.join('\n');
    }
    
    // Обработчик добавления новой строки
    if (addBusinessMetricsRowBtn) {
        console.log('Adding click handler to business metrics row button');
        addBusinessMetricsRowBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Add business metrics row button clicked');
            const newRow = createBusinessMetricsRow();
            businessMetricsTableTbody.appendChild(newRow);
            updateBusinessMetricsHiddenField();
        });
    } else {
        console.error('Add business metrics row button not found!');
    }
    
    // Обработчик удаления строки
    businessMetricsTableTbody.addEventListener('click', function(e) {
        if (e.target.closest('.remove-business-metric-row')) {
            const row = e.target.closest('tr');
            if (row) {
                row.remove();
                updateBusinessMetricsHiddenField();
            }
        }
    });
    
    // Обновляем скрытое поле при изменении полей
    businessMetricsTableTbody.addEventListener('input', function() {
        updateBusinessMetricsHiddenField();
    });
    
    businessMetricsTableTbody.addEventListener('change', function() {
        updateBusinessMetricsHiddenField();
    });
    
    // Загружаем существующие данные при загрузке страницы
    loadExistingBusinessMetricsData();
    
    // Обновляем скрытое поле перед отправкой формы
    const form = document.querySelector('form[action*="/mnt/"]');
    if (form) {
        form.addEventListener('submit', function() {
            updateBusinessMetricsHiddenField();
        });
    }
});
</script>
<!-- JavaScript для таблицы материалов (14) -->
<script>
// Управление таблицей материалов
document.addEventListener('DOMContentLoaded', function() {
    const deliverablesTableHidden = document.getElementById('deliverables_table');
    const deliverablesTableTbody = document.getElementById('deliverables_tbody');
    const addDeliverablesRowBtn = document.getElementById('add_deliverables_row_btn');
    
    if (!deliverablesTableHidden || !deliverablesTableTbody) {
        console.error('Deliverables table elements not found');
        return;
    }
    
    console.log('Deliverables table script loaded, button:', addDeliverablesRowBtn);
    
    // Функция для создания новой строки в таблице
    function createDeliverablesRow(rowData = { document: '', activity: '' }) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <textarea class="form-control form-control-sm deliverable-document" 
                       name="deliverable_document[]" 
                       rows="2"
                       placeholder="Документ"
                       required>${rowData.document || ''}</textarea>
            </td>
            <td>
                <textarea class="form-control form-control-sm deliverable-activity" 
                       name="deliverable_activity[]" 
                       rows="2"
                       placeholder="Подготавливается в результате деятельности"
                       required>${rowData.activity || ''}</textarea>
            </td>
            <td style="text-align: center; vertical-align: middle;">
                <button type="button" class="btn btn-sm btn-danger remove-deliverable-row" title="Удалить строку">
                    <i class="bi bi-trash"></i> Удалить
                </button>
            </td>
        `;
        return row;
    }
    
    // Функция для обновления скрытого поля
    function updateDeliverablesHiddenField() {
        const rows = deliverablesTableTbody.querySelectorAll('tr');
        
        const parts = [];
        parts.push('Документ|Подготавливается в результате деятельности'); // Заголовок
        
        rows.forEach(row => {
            const documentInput = row.querySelector('.deliverable-document');
            const activityInput = row.querySelector('.deliverable-activity');
            
            if (documentInput && activityInput) {
                const document = documentInput.value.trim();
                const activity = activityInput.value.trim();
                if (document || activity) {
                    parts.push(`${document}|${activity}`);
                }
            }
        });
        
        deliverablesTableHidden.value = parts.join('\n');
    }
    
    // Функция для загрузки существующих данных
    function loadExistingDeliverablesData() {
        const deliverablesData = deliverablesTableHidden.value.trim();
        
        if (!deliverablesData) {
            return; // Нет данных - таблица остается пустой
        }
        
        const lines = deliverablesData.split('\n').filter(line => line.trim());
        if (lines.length < 2) {
            return; // Только заголовок или пусто
        }
        
        // Пропускаем заголовок (первая строка)
        for (let i = 1; i < lines.length; i++) {
            const parts = lines[i].split('|').map(p => p.trim());
            if (parts.length >= 2) {
                const rowData = {
                    document: parts[0] || '',
                    activity: parts[1] || ''
                };
                const row = createDeliverablesRow(rowData);
                deliverablesTableTbody.appendChild(row);
            }
        }
    }
    
    // Загружаем существующие данные при загрузке страницы
    loadExistingDeliverablesData();
    
    // Обработчик добавления новой строки
    if (addDeliverablesRowBtn) {
        console.log('Adding click handler to deliverables row button');
        addDeliverablesRowBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Add deliverables row button clicked');
            const newRow = createDeliverablesRow();
            deliverablesTableTbody.appendChild(newRow);
            updateDeliverablesHiddenField();
        });
    } else {
        console.error('Add deliverables row button not found!');
    }
    
    // Обработчик удаления строки
    deliverablesTableTbody.addEventListener('click', function(e) {
        if (e.target.closest('.remove-deliverable-row')) {
            const row = e.target.closest('tr');
            if (row) {
                row.remove();
                updateDeliverablesHiddenField();
            }
        }
    });
    
    // Обновляем скрытое поле при изменении полей
    deliverablesTableTbody.addEventListener('input', function() {
        updateDeliverablesHiddenField();
    });
    
    // Обновляем скрытое поле перед отправкой формы
    const form = document.querySelector('form[action*="/mnt/"]');
    if (form) {
        form.addEventListener('submit', function() {
            updateDeliverablesHiddenField();
        });
    }
});
</script>
<!-- JavaScript для таблицы рабочих документов (14) -->
<script>
// Управление таблицей рабочих документов
document.addEventListener('DOMContentLoaded', function() {
    const deliverablesWorkingDocsTableHidden = document.getElementById('deliverables_working_docs_table');
    const deliverablesWorkingDocsTableTbody = document.getElementById('deliverables_working_docs_tbody');
    const addDeliverablesWorkingDocsRowBtn = document.getElementById('add_deliverables_working_docs_row_btn');
    
    if (!deliverablesWorkingDocsTableHidden || !deliverablesWorkingDocsTableTbody) {
        console.error('Deliverables working docs table elements not found');
        return;
    }
    
    console.log('Deliverables working docs table script loaded, button:', addDeliverablesWorkingDocsRowBtn);
    
    // Функция для создания новой строки в таблице
    function createDeliverablesWorkingDocsRow(rowData = { document: '', activity: '' }) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <textarea class="form-control form-control-sm deliverable-working-doc-document" 
                       name="deliverable_working_doc_document[]" 
                       rows="2"
                       placeholder="Документ"
                       required>${rowData.document || ''}</textarea>
            </td>
            <td>
                <textarea class="form-control form-control-sm deliverable-working-doc-activity" 
                       name="deliverable_working_doc_activity[]" 
                       rows="2"
                       placeholder="Подготавливается в результате деятельности"
                       required>${rowData.activity || ''}</textarea>
            </td>
            <td style="text-align: center; vertical-align: middle;">
                <button type="button" class="btn btn-sm btn-danger remove-deliverable-working-doc-row" title="Удалить строку">
                    <i class="bi bi-trash"></i> Удалить
                </button>
            </td>
        `;
        return row;
    }
    
    // Функция для обновления скрытого поля
    function updateDeliverablesWorkingDocsHiddenField() {
        const rows = deliverablesWorkingDocsTableTbody.querySelectorAll('tr');
        
        const parts = [];
        parts.push('Рабочие документы (предоставляются только в электронном виде)'); // Заголовок (первая строка)
        
        rows.forEach(row => {
            const documentInput = row.querySelector('.deliverable-working-doc-document');
            const activityInput = row.querySelector('.deliverable-working-doc-activity');
            
            if (documentInput && activityInput) {
                const document = documentInput.value.trim();
                const activity = activityInput.value.trim();
                if (document || activity) {
                    parts.push(`${document}|${activity}`);
                }
            }
        });
        
        deliverablesWorkingDocsTableHidden.value = parts.join('\n');
    }
    
    // Функция для загрузки существующих данных
    function loadExistingDeliverablesWorkingDocsData() {
        const deliverablesWorkingDocsData = deliverablesWorkingDocsTableHidden.value.trim();
        
        if (!deliverablesWorkingDocsData) {
            return; // Нет данных - таблица остается пустой
        }
        
        const lines = deliverablesWorkingDocsData.split('\n').filter(line => line.trim());
        if (lines.length < 2) {
            return; // Только заголовок или пусто
        }
        
        // Пропускаем заголовок (первая строка)
        for (let i = 1; i < lines.length; i++) {
            const parts = lines[i].split('|').map(p => p.trim());
            if (parts.length >= 2) {
                const rowData = {
                    document: parts[0] || '',
                    activity: parts[1] || ''
                };
                const row = createDeliverablesWorkingDocsRow(rowData);
                deliverablesWorkingDocsTableTbody.appendChild(row);
            }
        }
    }
    
    // Загружаем существующие данные при загрузке страницы
    loadExistingDeliverablesWorkingDocsData();
    
    // Обработчик добавления новой строки
    if (addDeliverablesWorkingDocsRowBtn) {
        console.log('Adding click handler to deliverables working docs row button');
        addDeliverablesWorkingDocsRowBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Add deliverables working docs row button clicked');
            const newRow = createDeliverablesWorkingDocsRow();
            deliverablesWorkingDocsTableTbody.appendChild(newRow);
            updateDeliverablesWorkingDocsHiddenField();
        });
    } else {
        console.error('Add deliverables working docs row button not found!');
    }
    
    // Обработчик удаления строки
    deliverablesWorkingDocsTableTbody.addEventListener('click', function(e) {
        if (e.target.closest('.remove-deliverable-working-doc-row')) {
            const row = e.target.closest('tr');
            if (row) {
                row.remove();
                updateDeliverablesWorkingDocsHiddenField();
            }
        }
    });
    
    // Обновляем скрытое поле при изменении полей
    deliverablesWorkingDocsTableTbody.addEventListener('input', function() {
        updateDeliverablesWorkingDocsHiddenField();
    });
    
    // Обновляем скрытое поле перед отправкой формы
    const form = document.querySelector('form[action*="/mnt/"]');
    if (form) {
        form.addEventListener('submit', function() {
            updateDeliverablesWorkingDocsHiddenField();
        });
    }
});
</script>
<!-- JavaScript для таблицы контактов (15) -->
<script>
// Управление таблицей контактов
document.addEventListener('DOMContentLoaded', function() {
    const contactsTableHidden = document.getElementById('contacts_table');
    const contactsTableTbody = document.getElementById('contacts_tbody');
    const addContactsRowBtn = document.getElementById('add_contacts_row_btn');
    
    if (!contactsTableHidden || !contactsTableTbody) {
        console.error('Contacts table elements not found');
        return;
    }
    
    console.log('Contacts table script loaded, button:', addContactsRowBtn);
    
    // Функция для перенумерации строк
    function renumberContactsRows() {
        const rows = contactsTableTbody.querySelectorAll('tr');
        rows.forEach((row, index) => {
            const numberSpan = row.querySelector('.contact-number-display');
            const numberInput = row.querySelector('.contact-number');
            if (numberSpan && numberInput) {
                const number = index + 1;
                numberSpan.textContent = number;
                numberInput.value = number;
            }
        });
    }
    
    // Функция для создания новой строки в таблице
    function createContactsRow(rowData = { number: '', fio: '', responsibility: '', contacts: '' }) {
        const row = document.createElement('tr');
        const currentRowCount = contactsTableTbody.querySelectorAll('tr').length + 1;
        const rowNumber = rowData.number || currentRowCount;
        
        row.innerHTML = `
            <td style="text-align: center; vertical-align: middle;">
                <span class="contact-number-display" style="font-weight: bold; display: inline-block; min-width: 20px;">${rowNumber}</span>
                <input type="hidden" class="contact-number" name="contact_number[]" value="${rowNumber}">
            </td>
            <td>
                <textarea class="form-control form-control-sm contact-fio" 
                       name="contact_fio[]" 
                       rows="2"
                       placeholder="ФИО"
                       required>${rowData.fio || ''}</textarea>
            </td>
            <td>
                <textarea class="form-control form-control-sm contact-responsibility" 
                       name="contact_responsibility[]" 
                       rows="2"
                       placeholder="Сфера ответственности"
                       required>${rowData.responsibility || ''}</textarea>
            </td>
            <td>
                <textarea class="form-control form-control-sm contact-contacts" 
                       name="contact_contacts[]" 
                       rows="2"
                       placeholder="Контакты">${rowData.contacts || ''}</textarea>
            </td>
            <td style="text-align: center; vertical-align: middle;">
                <button type="button" class="btn btn-sm btn-danger remove-contact-row" title="Удалить строку">
                    <i class="bi bi-trash"></i> Удалить
                </button>
            </td>
        `;
        return row;
    }
    
    // Функция для обновления скрытого поля
    function updateContactsHiddenField() {
        const rows = contactsTableTbody.querySelectorAll('tr');
        
        const parts = [];
        parts.push('п/п|ФИО|Сфера ответственности|Контакты'); // Заголовок
        
        rows.forEach(row => {
            const numberInput = row.querySelector('.contact-number');
            const fioInput = row.querySelector('.contact-fio');
            const responsibilityInput = row.querySelector('.contact-responsibility');
            const contactsInput = row.querySelector('.contact-contacts');
            
            if (numberInput && fioInput && responsibilityInput) {
                const number = numberInput.value.trim();
                const fio = fioInput.value.trim();
                const responsibility = responsibilityInput.value.trim();
                const contacts = contactsInput ? contactsInput.value.trim() : '';
                if (fio || responsibility || contacts) {
                    parts.push(`${number}|${fio}|${responsibility}|${contacts}`);
                }
            }
        });
        
        contactsTableHidden.value = parts.join('\n');
    }
    
    // Функция для загрузки существующих данных
    function loadExistingContactsData() {
        const contactsData = contactsTableHidden.value.trim();
        
        if (!contactsData) {
            return; // Нет данных - таблица остается пустой
        }
        
        const lines = contactsData.split('\n').filter(line => line.trim());
        if (lines.length < 2) {
            return; // Только заголовок или пусто
        }
        
        // Пропускаем заголовок (первая строка)
        for (let i = 1; i < lines.length; i++) {
            const parts = lines[i].split('|').map(p => p.trim());
            if (parts.length >= 3) {
                const rowData = {
                    number: parts[0] || '',
                    fio: parts[1] || '',
                    responsibility: parts[2] || '',
                    contacts: parts[3] || ''
                };
                const row = createContactsRow(rowData);
                contactsTableTbody.appendChild(row);
            }
        }
        renumberContactsRows();
    }
    
    // Загружаем существующие данные при загрузке страницы
    loadExistingContactsData();
    
    // Обработчик добавления новой строки
    if (addContactsRowBtn) {
        console.log('Adding click handler to contacts row button');
        addContactsRowBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Add contacts row button clicked');
            const newRow = createContactsRow();
            contactsTableTbody.appendChild(newRow);
            renumberContactsRows();
            updateContactsHiddenField();
        });
    } else {
        console.error('Add contacts row button not found!');
    }
    
    // Обработчик удаления строки
    contactsTableTbody.addEventListener('click', function(e) {
        if (e.target.closest('.remove-contact-row')) {
            const row = e.target.closest('tr');
            if (row) {
                row.remove();
                renumberContactsRows();
                updateContactsHiddenField();
            }
        }
    });
    
    // Обновляем скрытое поле при изменении полей
    contactsTableTbody.addEventListener('input', function() {
        updateContactsHiddenField();
    });
    
    // Обновляем скрытое поле перед отправкой формы
    const form = document.querySelector('form[action*="/mnt/"]');
    if (form) {
        form.addEventListener('submit', function() {
            updateContactsHiddenField();
        });
    }
});
</script>
<script>
// Инициализация редакторов таблиц и других функций
document.addEventListener('DOMContentLoaded', function() {
    // Инициализируем редакторы таблиц
    // history_changes_table - НЕ редактируется, заполняется автоматически
    // approval_list_table - визуальная таблица с input полями
    const tableFields = [
        // 'approval_list_table', // Убрали, т.к. теперь визуальная таблица
        // 'abbreviations_table', // Убрали, т.к. теперь визуальная таблица
        // 'terminology_table', // Убрали, т.к. теперь визуальная таблица
        // 'risks_table', // Убрали, т.к. теперь визуальная таблица
        // 'stand_comparison_table', // Убрали, т.к. теперь визуальная таблица
        // 'planned_tests_table', // Убрали, т.к. теперь визуальная таблица
        // 'database_preparation_table', // Убрали, т.к. теперь визуальная таблица
        // 'load_profiles_table', // Убрали, т.к. теперь визуальная таблица
        // 'use_scenarios_table', // Убрали, т.к. теперь визуальная таблица
        // 'monitoring_tools_table', // Убрали, т.к. теперь визуальная таблица
        // 'system_resources_table', // Убрали, т.к. теперь визуальная таблица
        // 'business_metrics_table', // Убрали, т.к. теперь визуальная таблица
        // 'deliverables_table', // Убрали, т.к. теперь визуальная таблица
        // 'contacts_table', // Убрали, т.к. теперь визуальная таблица
    ];
    
    tableFields.forEach(fieldId => {
        if (document.getElementById(fieldId)) {
            new TableEditor(fieldId);
        }
    });
    
    // Навигация - плавная прокрутка (только для боковой навигации формы)
    document.querySelectorAll('.form-navigation .nav-item').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault(); // Всегда предотвращаем стандартное поведение
            const href = this.getAttribute('href');
            // Обрабатываем только якоря (начинающиеся с #)
            if (href && href.startsWith('#')) {
                const targetId = href.substring(1);
                const targetElement = document.getElementById(targetId);
                if (targetElement) {
                    // Получаем позицию элемента с учетом offset для фиксированной навигации
                    const elementPosition = targetElement.getBoundingClientRect().top + window.pageYOffset;
                    const offsetPosition = elementPosition - 80; // Отступ сверху
                    
                    window.scrollTo({
                        top: offsetPosition,
                        behavior: 'smooth'
                    });
                    
                    // Подсветка активного пункта
                    document.querySelectorAll('.form-navigation .nav-item').forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Обновляем URL без перезагрузки страницы
                    history.pushState(null, null, href);
                } else {
                    console.warn(`Элемент с id="${targetId}" не найден`);
                }
            }
            // Для обычных ссылок (не якорей) ничего не делаем - пусть работают как обычно
        });
    });
    
    // Отслеживание активного раздела при прокрутке
    const sections = document.querySelectorAll('.form-section[id]');
    const navItems = document.querySelectorAll('.form-navigation .nav-item[href^="#"]');
    
    function updateActiveNav() {
        let current = '';
        sections.forEach(section => {
            const sectionTop = section.offsetTop;
            const sectionHeight = section.clientHeight;
            if (window.pageYOffset >= sectionTop - 150) {
                current = section.getAttribute('id');
            }
        });
        
        navItems.forEach(item => {
            item.classList.remove('active');
            if (item.getAttribute('href') === '#' + current) {
                item.classList.add('active');
            }
        });
    }
    
    window.addEventListener('scroll', updateActiveNav);
    updateActiveNav();
    
    // Управление пользовательскими блоками - закомментировано
    /*
    let customSectionCounter = 0;
    const customSectionsContainer = document.getElementById('custom-sections-container');
    const addCustomSectionBtn = document.getElementById('add-custom-section-btn');
    
    if (addCustomSectionBtn && customSectionsContainer) {
        addCustomSectionBtn.addEventListener('click', function() {
            const title = document.getElementById('custom_section_title').value.trim();
            const insertAfter = parseInt(document.getElementById('custom_section_insert_after').value);
            
            if (!title) {
                alert('Введите название блока');
                return;
            }
            
            customSectionCounter++;
            const sectionId = `custom-section-${customSectionCounter}`;
            const timestamp = Date.now();
            
            // Создаем HTML блока
            const sectionHtml = `
                <div class="form-section custom-section" id="${sectionId}" data-section-id="${timestamp}" data-position="${insertAfter}">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3>${title}</h3>
                        <button type="button" class="btn btn-sm btn-danger remove-custom-section" data-section-id="${timestamp}">Удалить</button>
                    </div>
                    
                    <input type="hidden" name="custom_sections[${timestamp}][id]" value="${timestamp}">
                    <input type="hidden" name="custom_sections[${timestamp}][title]" value="${title.replace(/"/g, '&quot;')}">
                    <input type="hidden" name="custom_sections[${timestamp}][position]" value="${insertAfter}">
                    
                    <div class="mb-3">
                        <label class="form-label">Текст</label>
                        <textarea class="form-control" name="custom_sections[${timestamp}][text]" rows="5" placeholder="Введите текст блока"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Таблица</label>
                        <textarea class="form-control" id="custom_table_${timestamp}" name="custom_sections[${timestamp}][table]" rows="5" placeholder="Введите таблицу"></textarea>
                        <small class="text-muted">Формат: Заголовок1|Заголовок2, Данные1|Данные2</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Список (каждый элемент с новой строки)</label>
                        <textarea class="form-control" name="custom_sections[${timestamp}][list]" rows="5" placeholder="Введите элементы списка"></textarea>
                    </div>
                </div>
            `;
            
            customSectionsContainer.insertAdjacentHTML('beforeend', sectionHtml);
            
            if (typeof TableEditor !== 'undefined') {
                const tableEditorId = `custom_table_${timestamp}`;
                setTimeout(() => {
                    const tableField = document.getElementById(tableEditorId);
                    if (tableField) {
                        new TableEditor(tableEditorId);
                    }
                }, 100);
            }
            
            addToNavigation(sectionId, title);
            document.getElementById('custom_section_title').value = '';
            updateActiveNav();
        });
        
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-custom-section')) {
                const sectionId = e.target.getAttribute('data-section-id');
                const section = document.querySelector(`[data-section-id="${sectionId}"]`);
                if (section && confirm('Удалить этот блок?')) {
                    const navItem = document.querySelector(`[data-nav-custom="${sectionId}"]`);
                    if (navItem) navItem.remove();
                    section.remove();
                }
            }
        });
        
        function addToNavigation(sectionId, title) {
            const navContainer = document.querySelector('.form-navigation .nav-container');
            if (!navContainer) return;
            
            const navItem = document.createElement('div');
            navItem.className = 'nav-section';
            navItem.setAttribute('data-nav-custom', sectionId);
            navItem.innerHTML = `<a href="#${sectionId}" class="nav-item">${title}</a>`;
            
            const publishNav = Array.from(navContainer.children).find(el => 
                el.querySelector('a[href="#section-confluence"]')
            );
            
            if (publishNav) {
                navContainer.insertBefore(navItem, publishNav);
            } else {
                navContainer.appendChild(navItem);
            }
        }
    }
    */
    
    // Синхронизация тегов из текстового поля (если есть чекбоксы, они также обновляют текстовое поле)
    const formForTags = document.querySelector('form[action*="/mnt/create"]');
    if (formForTags) {
        const tagsInput = document.getElementById('tags');
        if (tagsInput) {
            // Обработка изменения чекбоксов тегов (если они есть)
            const tagCheckboxes = document.querySelectorAll('.tag-checkbox');
            if (tagCheckboxes.length > 0) {
                tagCheckboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        const selectedTags = Array.from(document.querySelectorAll('.tag-checkbox:checked'))
                            .map(cb => cb.value)
                            .join(',');
                        tagsInput.value = selectedTags;
                    });
                });
            }
            
            // Убеждаемся, что значение текстового поля отправляется при submit
            formForTags.addEventListener('submit', function(e) {
                // Значение уже в поле, форма отправит его автоматически
                console.log('Отправка формы, теги:', tagsInput.value);
            });
        }
    }
    
    // Превью при создании
    const previewBtn = document.getElementById('preview-btn');
    if (previewBtn) {
        previewBtn.addEventListener('click', function() {
            // Собираем данные формы
            const formForPreview = document.querySelector('form[action*="/mnt/"]');
            if (!formForPreview) return;
    
            const formData = new FormData(formForPreview);
            const data = {};
            for (let [key, value] of formData.entries()) {
                if (key !== 'publish') {
                    data[key] = value;
                }
            }
            
            // Создаем модальное окно с превью
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.id = 'previewModal';
            modal.innerHTML = `
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Превью МНТ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="preview-content">
                        <h1>Методика нагрузочного тестирования</h1>
                        <h2>${data.project_name || 'Название проекта'}</h2>
                        <p><strong>УК «Первая»</strong></p>
                        <p>Версия системы: ${data.system_version || ''}</p>
                        <hr>
                        <p><em>Это упрощенный превью. Полный контент будет отображаться после сохранения и публикации в Confluence.</em></p>
                        <p><strong>Автор:</strong> ${data.author || ''}</p>
                        <p><strong>Space Key:</strong> ${data.confluence_space || ''}</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                </div>
            </div>
        </div>
    `;
    
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            // Удаляем модальное окно после закрытия
            modal.addEventListener('hidden.bs.modal', function() {
                modal.remove();
            });
        });
    }
}); // конец DOMContentLoaded
</script>

<!-- Drag & Drop для таблиц -->
<script src="{{ url_for('static', path='js/drag-drop-tables.js') }}"></script>
<!-- Автодополнение для полей -->
<script src="{{ url_for('static', path='js/autocomplete.js') }}"></script>
<!-- Подсказки и помощь для полей -->
<script src="{{ url_for('static', path='js/field-help.js') }}"></script>

<!-- Инициализация Drag & Drop и автодополнения -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ========== Drag & Drop для всех таблиц ==========
    
    // Функция для инициализации drag & drop для таблицы
    function initDragDropForTable(tableId, tbodyId, updateFunction, addButtonId) {
        const tbody = document.getElementById(tbodyId);
        if (!tbody) return null;
        
        const dragDrop = new TableDragDrop(
            tableId,
            tbodyId,
            function() {
                if (typeof updateFunction === 'function') {
                    updateFunction();
                }
            }
        );
        
        // Обновляем drag & drop после добавления новых строк
        if (addButtonId) {
            const addBtn = document.getElementById(addButtonId);
            if (addBtn) {
                addBtn.addEventListener('click', function() {
                    setTimeout(() => {
                        if (dragDrop) dragDrop.refresh();
                    }, 100);
                });
            }
        }
        
        return dragDrop;
    }
    
    // Инициализируем drag & drop для всех таблиц
    const dragDropInstances = {};
    
    // 1. История изменений - drag & drop отключен (записи нельзя перетаскивать)
    // dragDropInstances.historyChanges = initDragDropForTable(
    //     'history_changes_visual_table',
    //     'history_changes_tbody',
    //     function() {
    //         if (typeof updateHistoryChangesHiddenField === 'function') {
    //             updateHistoryChangesHiddenField();
    //         }
    //     },
    //     'add_history_row_btn'
    // );
    
    // 2. Лист согласования
    dragDropInstances.approvalList = initDragDropForTable(
        'approval_list_visual_table',
        'approval_list_tbody',
        function() {
            if (typeof updateApprovalHiddenField === 'function') {
                updateApprovalHiddenField();
            }
        },
        'add_approval_row_btn'
    );
    
    // 3. Сокращения
    dragDropInstances.abbreviations = initDragDropForTable(
        'abbreviations_visual_table',
        'abbreviations_tbody',
        function() {
            if (typeof updateAbbreviationHiddenField === 'function') {
                updateAbbreviationHiddenField();
            }
        },
        'add_abbreviation_row_btn'
    );
    
    // 4. Терминология
    dragDropInstances.terminology = initDragDropForTable(
        'terminology_visual_table',
        'terminology_tbody',
        function() {
            if (typeof updateTerminologyHiddenField === 'function') {
                updateTerminologyHiddenField();
            }
        },
        'add_terminology_row_btn'
    );
    
    // 5. Риски
    dragDropInstances.risks = initDragDropForTable(
        'risks_visual_table',
        'risks_tbody',
        function() {
            if (typeof updateRiskHiddenField === 'function') {
                updateRiskHiddenField();
            }
        },
        'add_risk_row_btn'
    );
    
    // 6. Сравнение конфигураций
    dragDropInstances.standComparison = initDragDropForTable(
        'stand_comparison_visual_table',
        'stand_comparison_tbody',
        function() {
            if (typeof updateStandComparisonHiddenField === 'function') {
                updateStandComparisonHiddenField();
            }
        },
        'add_stand_comparison_row_btn'
    );
    
    // 7. Планируемые тесты
    dragDropInstances.plannedTests = initDragDropForTable(
        'planned_tests_visual_table',
        'planned_tests_tbody',
        function() {
            if (typeof updatePlannedTestHiddenField === 'function') {
                updatePlannedTestHiddenField();
            }
        },
        'add_planned_test_row_btn'
    );
    
    // 8. Наполнение БД
    dragDropInstances.databasePreparation = initDragDropForTable(
        'database_preparation_visual_table',
        'database_preparation_tbody',
        function() {
            if (typeof updateDatabasePreparationHiddenField === 'function') {
                updateDatabasePreparationHiddenField();
            }
        },
        'add_database_preparation_row_btn'
    );
    
    // 9. Профили нагрузки
    dragDropInstances.loadProfiles = initDragDropForTable(
        'load_profiles_visual_table',
        'load_profiles_tbody',
        function() {
            if (typeof updateLoadProfilesHiddenField === 'function') {
                updateLoadProfilesHiddenField();
            }
        },
        'add_load_profiles_row_btn'
    );
    
    // 10. Сценарии использования
    dragDropInstances.useScenarios = initDragDropForTable(
        'use_scenarios_visual_table',
        'use_scenarios_tbody',
        function() {
            if (typeof updateUseScenariosHiddenField === 'function') {
                updateUseScenariosHiddenField();
            }
        },
        'add_use_scenarios_row_btn'
    );
    
    // 11. Средства мониторинга
    dragDropInstances.monitoringTools = initDragDropForTable(
        'monitoring_tools_visual_table',
        'monitoring_tools_tbody',
        function() {
            if (typeof updateMonitoringToolsHiddenField === 'function') {
                updateMonitoringToolsHiddenField();
            }
        },
        'add_monitoring_tools_row_btn'
    );
    
    // 12. Системные ресурсы
    dragDropInstances.systemResources = initDragDropForTable(
        'system_resources_visual_table',
        'system_resources_tbody',
        function() {
            if (typeof updateSystemResourcesHiddenField === 'function') {
                updateSystemResourcesHiddenField();
            }
        },
        'add_system_resources_row_btn'
    );
    
    // 13. Бизнес-метрики
    dragDropInstances.businessMetrics = initDragDropForTable(
        'business_metrics_visual_table',
        'business_metrics_tbody',
        function() {
            if (typeof updateBusinessMetricsHiddenField === 'function') {
                updateBusinessMetricsHiddenField();
            }
        },
        'add_business_metrics_row_btn'
    );
    
        // 14. Материалы, подлежащие сдаче
        dragDropInstances.deliverables = initDragDropForTable(
            'deliverables_visual_table',
            'deliverables_tbody',
            function() {
                if (typeof updateDeliverablesHiddenField === 'function') {
                    updateDeliverablesHiddenField();
                }
            },
            'add_deliverables_row_btn'
        );
    
    // 15. Рабочие документы
    dragDropInstances.deliverablesWorkingDocs = initDragDropForTable(
        'deliverables_working_docs_visual_table',
        'deliverables_working_docs_tbody',
        function() {
            if (typeof updateDeliverablesWorkingDocsHiddenField === 'function') {
                updateDeliverablesWorkingDocsHiddenField();
            }
        },
        'add_deliverables_working_docs_row_btn'
    );
    
    // 16. Контакты
    dragDropInstances.contacts = initDragDropForTable(
        'contacts_visual_table',
        'contacts_tbody',
        function() {
            if (typeof updateContactsHiddenField === 'function') {
                updateContactsHiddenField();
            }
        },
        'add_contacts_row_btn'
    );
    
    // ========== Автодополнение для полей ==========
    
    // Автодополнение для поля "Проект" (project_name или project)
    const projectInput = document.getElementById('project_name') || document.getElementById('project');
    if (projectInput) {
        initAutocomplete(projectInput, {
            source: async () => {
                try {
                    const response = await fetch('/api/autocomplete/projects');
                    const data = await response.json();
                    return data;
                } catch (error) {
                    console.error('Ошибка загрузки проектов:', error);
                    return [];
                }
            },
            minLength: 1,
            fetchOnFocus: true,
            maxItems: 10
        });
    }
    
    // Автодополнение для поля "Автор"
    const authorInput = document.getElementById('author');
    if (authorInput) {
        initAutocomplete(authorInput, {
            source: async () => {
                try {
                    const response = await fetch('/api/autocomplete/authors');
                    const data = await response.json();
                    return data;
                } catch (error) {
                    console.error('Ошибка загрузки авторов:', error);
                    return [];
                }
            },
            minLength: 1,
            fetchOnFocus: true,
            maxItems: 10
        });
    }
    
    // Автодополнение для поля "Теги" (с поддержкой множественного ввода через запятую)
    const tagsInput = document.getElementById('tags');
    if (tagsInput) {
        initAutocomplete(tagsInput, {
            source: async () => {
                try {
                    const response = await fetch('/api/autocomplete/tags');
                    const data = await response.json();
                    return data;
                } catch (error) {
                    console.error('Ошибка загрузки тегов:', error);
                    return [];
                }
            },
            minLength: 1,
            maxItems: 10,
            onSelect: (item, input) => {
                const currentValue = input.value.trim();
                const newTag = typeof item === 'string' ? item : item.value;
                
                // Разбиваем текущее значение на теги
                const parts = currentValue.split(',').map(s => s.trim()).filter(s => s);
                
                // Добавляем новый тег если его еще нет
                if (!parts.includes(newTag)) {
                    parts.push(newTag);
                }
                
                // Объединяем обратно
                input.value = parts.join(', ');
                
                // Фокусируемся в конце для продолжения ввода
                setTimeout(() => {
                    input.focus();
                    input.setSelectionRange(input.value.length, input.value.length);
                }, 10);
            }
        });
    }
    
    // Инициализируем подсказки для полей
    if (typeof initFieldHelp === 'function') {
        setTimeout(() => {
            initFieldHelp();
        }, 500); // Даем время на загрузку всех полей
    }
});
</script>

<!-- CSS стили для Drag & Drop -->
<style>
.draggable-row {
    transition: background-color 0.2s;
}

.draggable-row.dragging {
    opacity: 0.5;
    background-color: #f0f0f0;
}

.draggable-row.drag-over {
    background-color: #e3f2fd;
}

.draggable-row.drag-over-top {
    border-top: 3px solid #2196f3;
}

.draggable-row.drag-over-bottom {
    border-bottom: 3px solid #2196f3;
}

.draggable-row.drag-enter {
    background-color: #bbdefb;
}

.drag-handle {
    cursor: move !important;
    user-select: none;
    color: #666;
    font-size: 1.2em;
    transition: color 0.2s;
}

.drag-handle:hover {
    color: #2196f3;
}

.drag-handle:active {
    cursor: grabbing !important;
}

.drag-handle-floating {
    opacity: 0.5;
}

.draggable-row:hover .drag-handle-floating {
    opacity: 1;
}

/* Убеждаемся, что колонка действий имеет достаточно места */
td:has(.drag-handle) {
    white-space: nowrap;
}
</style>
{% endblock %}
