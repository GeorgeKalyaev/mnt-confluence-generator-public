{% extends "base.html" %}

{% block title %}–°–ø–∏—Å–æ–∫ –ú–ù–¢ - –ú–ù–¢ Generator{% endblock %}

{% block breadcrumbs %}
    <nav aria-label="breadcrumb" class="bg-light border-bottom py-2">
        <div class="container-fluid">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="/">–ì–ª–∞–≤–Ω–∞—è</a></li>
                <li class="breadcrumb-item active">–°–ø–∏—Å–æ–∫ –ú–ù–¢</li>
            </ol>
        </div>
    </nav>
{% endblock %}

{% block content %}
<!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± —É—Å–ø–µ—Ö–µ/–æ—à–∏–±–∫–∞—Ö -->
{% if success_message %}
<div class="alert alert-success alert-dismissible fade show" role="alert">
    {% if success_message == 'created_published' %}
    <strong>‚úì –£—Å–ø–µ—à–Ω–æ!</strong> –ú–ù–¢ —Å–æ–∑–¥–∞–Ω –∏ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω –≤ Confluence.
    {% elif success_message == 'draft_created' %}
    <strong>‚úì –£—Å–ø–µ—à–Ω–æ!</strong> –ú–ù–¢ —Å–æ–∑–¥–∞–Ω –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –∫–∞–∫ —á–µ—Ä–Ω–æ–≤–∏–∫.
    {% elif success_message == 'updated' %}
    <strong>‚úì –£—Å–ø–µ—à–Ω–æ!</strong> –ú–ù–¢ –æ–±–Ω–æ–≤–ª–µ–Ω.
    {% elif success_message == 'updated_published' %}
    <strong>‚úì –£—Å–ø–µ—à–Ω–æ!</strong> –ú–ù–¢ –æ–±–Ω–æ–≤–ª–µ–Ω –∏ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω –≤ Confluence.
    {% elif success_message == 'deleted' %}
    <strong>‚úì –£—Å–ø–µ—à–Ω–æ!</strong> –ú–ù–¢ —É–¥–∞–ª–µ–Ω –∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É. –°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤ Confluence —Ç–∞–∫–∂–µ —É–¥–∞–ª–µ–Ω–∞. –í—ã –º–æ–∂–µ—Ç–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ú–ù–¢ –≤ —Ç–µ—á–µ–Ω–∏–µ 30 –¥–Ω–µ–π –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã.
    {% elif success_message == 'duplicated' %}
    <strong>‚úì –£—Å–ø–µ—à–Ω–æ!</strong> –ú–ù–¢ —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–¥—É–±–ª–∏—Ä–æ–≤–∞–Ω. –ö–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞ –∫–∞–∫ —á–µ—Ä–Ω–æ–≤–∏–∫ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º ¬´(–∫–æ–ø–∏—è)¬ª.
    {% else %}
    <strong>‚úì –£—Å–ø–µ—à–Ω–æ!</strong> {{ success_message }}
    {% endif %}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}

{% if error_message %}
<div class="alert alert-danger alert-dismissible fade show" role="alert">
    <strong>‚úó –û—à–∏–±–∫–∞!</strong> {{ error_message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>–°–ø–∏—Å–æ–∫ –ú–ù–¢</h1>
    <a href="/mnt/create" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ú–ù–¢</a>
</div>

<!-- –§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫ -->
<form method="get" action="/mnt/list" class="mb-4">
    <div class="card mb-3">
        <div class="card-header">
            <h5 class="mb-0">–§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <!-- –ü–æ–∏—Å–∫ -->
                <div class="col-md-4">
                    <label for="search" class="form-label">–ü–æ–∏—Å–∫</label>
                    <input type="text" 
                           class="form-control" 
                           id="search"
                           name="search" 
                           placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ, –ø—Ä–æ–µ–∫—Ç, –∞–≤—Ç–æ—Ä..." 
                           value="{{ search_query }}">
                </div>
                
                <!-- –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É -->
                <div class="col-md-2">
                    <label for="status" class="form-label">–°—Ç–∞—Ç—É—Å</label>
                    <select class="form-select" id="status" name="status">
                        <option value="">–í—Å–µ</option>
                        <option value="draft" {% if status_filter == 'draft' %}selected{% endif %}>–ß–µ—Ä–Ω–æ–≤–∏–∫</option>
                        <option value="published" {% if status_filter == 'published' %}selected{% endif %}>–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ</option>
                        <option value="error" {% if status_filter == 'error' %}selected{% endif %}>–û—à–∏–±–∫–∞</option>
                    </select>
                </div>
                
                <!-- –§–∏–ª—å—Ç—Ä –ø–æ –∞–≤—Ç–æ—Ä—É -->
                <div class="col-md-2">
                    <label for="author" class="form-label">–ê–≤—Ç–æ—Ä</label>
                    <input type="text" 
                           class="form-control" 
                           id="author"
                           name="author" 
                           placeholder="–ò–º—è –∞–≤—Ç–æ—Ä–∞..." 
                           value="{{ author_filter }}">
                </div>
                
                <!-- –§–∏–ª—å—Ç—Ä –ø–æ —Ç–µ–≥—É -->
                <div class="col-md-2">
                    <label for="tag_id" class="form-label">–¢–µ–≥</label>
                    <select class="form-select" id="tag_id" name="tag_id">
                        <option value="">–í—Å–µ</option>
                        {% for tag in tags %}
                        <option value="{{ tag.name }}" {% if tag_filter == tag.name %}selected{% endif %}>{{ tag.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ -->
                <div class="col-md-2">
                    <label for="sort_by" class="form-label">–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ</label>
                    <select class="form-select" id="sort_by" name="sort_by">
                        <option value="created_at" {% if sort_by == 'created_at' %}selected{% endif %}>–î–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è</option>
                        <option value="updated_at" {% if sort_by == 'updated_at' %}selected{% endif %}>–ü–æ—Å–ª–µ–¥–Ω–µ–º—É –∏–∑–º–µ–Ω–µ–Ω–∏—é</option>
                        <option value="title" {% if sort_by == 'title' %}selected{% endif %}>–ù–∞–∑–≤–∞–Ω–∏—é</option>
                        <option value="project" {% if sort_by == 'project' %}selected{% endif %}>–ü—Ä–æ–µ–∫—Ç—É</option>
                        <option value="author" {% if sort_by == 'author' %}selected{% endif %}>–ê–≤—Ç–æ—Ä—É</option>
                        <option value="status" {% if sort_by == 'status' %}selected{% endif %}>–°—Ç–∞—Ç—É—Å—É</option>
                    </select>
                </div>
            </div>
            
            <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ -->
            <input type="hidden" name="page" value="1" id="page_input">
            
            <div class="mt-3">
                <button type="submit" class="btn btn-primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
                {% if search_query or status_filter or author_filter or tag_filter %}
                <a href="/mnt/list" class="btn btn-outline-secondary">–°–±—Ä–æ—Å–∏—Ç—å</a>
                {% endif %}
            </div>
        </div>
    </div>
</form>

<div class="alert alert-info">
    –í—Å–µ–≥–æ –ú–ù–¢: <strong>{{ total }}</strong>
    {% if search_query or status_filter or author_filter or tag_filter %}
    (–Ω–∞–π–¥–µ–Ω–æ –ø–æ —Ñ–∏–ª—å—Ç—Ä–∞–º)
    {% endif %}
    {% if total_pages > 1 %}
    | –°—Ç—Ä–∞–Ω–∏—Ü–∞ <strong>{{ current_page }}</strong> –∏–∑ <strong>{{ total_pages }}</strong>
    {% endif %}
</div>

{% if documents %}
<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>ID</th>
                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th>–ü—Ä–æ–µ–∫—Ç</th>
                <th>–ê–≤—Ç–æ—Ä</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>Confluence</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody>
            {% for doc in documents %}
            <tr>
                <td>{{ doc.id }}</td>
                <td>
                    <div class="d-flex align-items-center gap-2 flex-wrap">
                        <strong>{{ doc.title }}</strong>
                        {% if doc.tags %}
                        <div class="d-flex gap-1 flex-wrap">
                            {% for tag in doc.tags %}
                            <a href="?tag_id={{ tag.name|urlencode }}{% if search_query %}&search={{ search_query|urlencode }}{% endif %}{% if status_filter %}&status={{ status_filter|urlencode }}{% endif %}{% if author_filter %}&author={{ author_filter|urlencode }}{% endif %}{% if sort_by %}&sort_by={{ sort_by|urlencode }}{% endif %}{% if sort_order %}&sort_order={{ sort_order|urlencode }}{% endif %}" 
                               class="badge bg-primary text-decoration-none tag-badge" 
                               style="font-size: 0.75em; padding: 0.35em 0.65em; cursor: pointer; transition: all 0.2s;"
                               onmouseover="this.style.opacity='0.8'; this.style.transform='scale(1.05)'"
                               onmouseout="this.style.opacity='1'; this.style.transform='scale(1)'"
                               title="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ —Ç–µ–≥—É: {{ tag.name }}">
                                {{ tag.name }}
                            </a>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% if doc.last_error %}
                    <br><small class="text-danger" title="–û—à–∏–±–∫–∞: {{ doc.last_error }}">‚ö† {{ doc.last_error[:50] }}{% if doc.last_error|length > 50 %}...{% endif %}</small>
                    {% endif %}
                </td>
                <td>{{ doc.project }}</td>
                <td>{{ doc.author }}</td>
                <td>
                    {% if doc.status == 'published' %}
                        <span class="badge bg-success">‚úì –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ</span>
                        {% if doc.confluence_page_url %}
                            <br><small class="text-muted">
                                –ü–æ—Å–ª–µ–¥–Ω—è—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è: 
                                {% if doc.last_publish_at %}
                                    {{ doc.last_publish_at.strftime('%d.%m.%Y %H:%M') }}
                                {% elif doc.updated_at %}
                                    {{ doc.updated_at.strftime('%d.%m.%Y %H:%M') }} (–ø—Ä–∏–º–µ—Ä–Ω–æ)
                                {% else %}
                                    N/A
                                {% endif %}
                            </small>
                            {# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –Ω–µ–æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è #}
                            {% if doc.last_publish_at and doc.updated_at and doc.updated_at > doc.last_publish_at %}
                                <small class="fw-bold" style="color: #8B0000;">‚ö† –ï—Å—Ç—å –Ω–µ–æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è!</small>
                            {% elif doc.updated_at and not doc.last_publish_at %}
                                <small class="fw-bold" style="color: #8B0000;">‚ö† –í–æ–∑–º–æ–∂–Ω–æ –µ—Å—Ç—å –Ω–µ–æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è</small>
                            {% endif %}
                        {% endif %}
                    {% elif doc.status == 'error' %}
                        <span class="badge bg-danger">‚ö† –û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏</span>
                    {% else %}
                        <span class="badge bg-warning text-dark">üìù –ß–µ—Ä–Ω–æ–≤–∏–∫</span>
                        {% if doc.confluence_page_id %}
                            <br><small class="text-info">‚ö† –†–∞–Ω–µ–µ –±—ã–ª –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω, –Ω–æ –µ—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è</small>
                        {% endif %}
                    {% endif %}
                </td>
                <td>
                    {% if doc.confluence_page_url %}
                        <a href="{{ doc.confluence_page_url }}" target="_blank" class="btn btn-sm btn-link">–û—Ç–∫—Ä—ã—Ç—å</a>
                    {% else %}
                        <span class="text-muted">–ù–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ</span>
                    {% endif %}
                </td>
                <td>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-info" onclick="quickPreview({{ doc.id }})" title="–ë—ã—Å—Ç—Ä—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä">
                            üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä
                        </button>
                        <a href="/mnt/{{ doc.id }}/edit" class="btn btn-sm btn-outline-primary">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                        <form method="post" action="/mnt/{{ doc.id }}/duplicate" style="display: inline;" 
                              onsubmit="return confirm('–°–æ–∑–¥–∞—Ç—å –∫–æ–ø–∏—é —ç—Ç–æ–≥–æ –ú–ù–¢?\\n\\n–ö–æ–ø–∏—è –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞ –∫–∞–∫ —á–µ—Ä–Ω–æ–≤–∏–∫ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º \"{{ doc.title }} (–∫–æ–ø–∏—è)\".\\n\\n–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏ –ª–∏—Å—Ç —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è –Ω–∞—á–Ω—É—Ç—Å—è –∑–∞–Ω–æ–≤–æ.');">
                            <button type="submit" class="btn btn-sm btn-outline-info" title="–°–æ–∑–¥–∞—Ç—å –∫–æ–ø–∏—é –ú–ù–¢">
                                üîÑ –î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å
                            </button>
                        </form>
                        <form method="post" action="/mnt/{{ doc.id }}/delete" style="display: inline;" 
                              onsubmit="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ú–ù–¢?\\n\\n–°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤ Confluence –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞, –Ω–æ –ú–ù–¢ –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤ —Ç–µ—á–µ–Ω–∏–µ 30 –¥–Ω–µ–π –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã.');">
                            <button type="submit" class="btn btn-sm btn-outline-danger" title="–£–¥–∞–ª–∏—Ç—å –ú–ù–¢">
                                ‚ùå –£–¥–∞–ª–∏—Ç—å
                            </button>
                        </form>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
{% if total_pages > 1 %}
<nav aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º">
    <ul class="pagination justify-content-center">
        {% if has_prev %}
        <li class="page-item">
            <a class="page-link" href="?page={{ current_page - 1 }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if author_filter %}&author={{ author_filter }}{% endif %}{% if tag_filter %}&tag_id={{ tag_filter }}{% endif %}{% if sort_by %}&sort_by={{ sort_by }}{% endif %}{% if sort_order %}&sort_order={{ sort_order }}{% endif %}">–ü—Ä–µ–¥—ã–¥—É—â–∞—è</a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <span class="page-link">–ü—Ä–µ–¥—ã–¥—É—â–∞—è</span>
        </li>
        {% endif %}
        
        {% for page_num in range(1, total_pages + 1) %}
            {% if page_num == current_page %}
            <li class="page-item active">
                <span class="page-link">{{ page_num }}</span>
            </li>
            {% elif page_num <= 3 or page_num > total_pages - 3 or (page_num >= current_page - 1 and page_num <= current_page + 1) %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_num }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if author_filter %}&author={{ author_filter }}{% endif %}{% if tag_filter %}&tag_id={{ tag_filter }}{% endif %}{% if sort_by %}&sort_by={{ sort_by }}{% endif %}{% if sort_order %}&sort_order={{ sort_order }}{% endif %}">{{ page_num }}</a>
            </li>
            {% elif page_num == 4 or page_num == total_pages - 3 %}
            <li class="page-item disabled">
                <span class="page-link">...</span>
            </li>
            {% endif %}
        {% endfor %}
        
        {% if has_next %}
        <li class="page-item">
            <a class="page-link" href="?page={{ current_page + 1 }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if author_filter %}&author={{ author_filter }}{% endif %}{% if tag_filter %}&tag_id={{ tag_filter }}{% endif %}{% if sort_by %}&sort_by={{ sort_by }}{% endif %}{% if sort_order %}&sort_order={{ sort_order }}{% endif %}">–°–ª–µ–¥—É—é—â–∞—è</a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <span class="page-link">–°–ª–µ–¥—É—é—â–∞—è</span>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

{% else %}
<div class="alert alert-warning">
    –ú–ù–¢ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. <a href="/mnt/create">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π –ú–ù–¢</a>.
</div>
{% endif %}

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ -->
<div class="modal fade" id="quickPreviewModal" tabindex="-1" aria-labelledby="quickPreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="quickPreviewModalLabel">–ë—ã—Å—Ç—Ä—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –ú–ù–¢</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="quickPreviewContent">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                <a id="editMntLink" href="#" class="btn btn-primary">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
            </div>
        </div>
    </div>
</div>

<script>
// –§—É–Ω–∫—Ü–∏—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ú–ù–¢
function quickPreview(mntId) {
    const modal = new bootstrap.Modal(document.getElementById('quickPreviewModal'));
    const contentDiv = document.getElementById('quickPreviewContent');
    const editLink = document.getElementById('editMntLink');
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    editLink.href = `/mnt/${mntId}/edit`;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
    contentDiv.innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
            <p class="mt-3">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ú–ù–¢...</p>
        </div>
    `;
    
    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    modal.show();
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    fetch(`/mnt/${mntId}/view`)
        .then(response => response.json())
        .then(data => {
            // –§–æ—Ä–º–∏—Ä—É–µ–º HTML –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const html = generatePreviewHTML(data);
            contentDiv.innerHTML = html;
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ú–ù–¢:', error);
            contentDiv.innerHTML = `
                <div class="alert alert-danger">
                    <strong>–û—à–∏–±–∫–∞!</strong> –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ú–ù–¢. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.
                </div>
            `;
        });
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
function generatePreviewHTML(document) {
    const data = document.data_json || {};
    
    let html = `
        <div class="mb-4">
            <h4>${escapeHtml(document.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}</h4>
            <div class="row mt-3">
                <div class="col-md-6">
                    <strong>–ü—Ä–æ–µ–∫—Ç:</strong> ${escapeHtml(document.project || '–ù–µ —É–∫–∞–∑–∞–Ω')}<br>
                    <strong>–ê–≤—Ç–æ—Ä:</strong> ${escapeHtml(document.author || '–ù–µ —É–∫–∞–∑–∞–Ω')}<br>
                    <strong>–°—Ç–∞—Ç—É—Å:</strong> ${getStatusBadge(document.status || 'draft')}
                </div>
                <div class="col-md-6">
                    <strong>–°–æ–∑–¥–∞–Ω:</strong> ${formatDate(document.created_at)}<br>
                    <strong>–û–±–Ω–æ–≤–ª–µ–Ω:</strong> ${formatDate(document.updated_at)}<br>
                    ${document.confluence_page_url ? `<strong>Confluence:</strong> <a href="${escapeHtml(document.confluence_page_url)}" target="_blank" class="btn btn-sm btn-link p-0">–û—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</a>` : ''}
                </div>
            </div>
            ${document.tags && document.tags.length > 0 ? `
                <div class="mt-2">
                    <strong>–¢–µ–≥–∏:</strong>
                    ${document.tags.map(tag => `<span class="badge bg-primary me-1">${escapeHtml(tag.name || tag)}</span>`).join('')}
                </div>
            ` : ''}
        </div>
        <hr>
        <div class="mnt-preview-content" style="max-height: 500px; overflow-y: auto;">
    `;
    
    let hasContent = false;
    
    // –†–∞–∑–¥–µ–ª 1: –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
    if (data.history_changes_table && formatTable(data.history_changes_table).trim()) {
        html += `<h5>1. –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π</h5>${formatTable(data.history_changes_table)}<hr>`;
        hasContent = true;
    }
    
    // –†–∞–∑–¥–µ–ª 2: –õ–∏—Å—Ç —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è
    if (data.approval_list_table && formatTable(data.approval_list_table).trim()) {
        html += `<h5>2. –õ–∏—Å—Ç —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è</h5>${formatTable(data.approval_list_table)}<hr>`;
        hasContent = true;
    }
    
    // –†–∞–∑–¥–µ–ª 3: –°–æ–∫—Ä–∞—â–µ–Ω–∏—è –∏ —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—è
    if ((data.abbreviations_table && formatTable(data.abbreviations_table).trim()) || 
        (data.terminology_table && formatTable(data.terminology_table).trim())) {
        html += `<h5>3. –°–æ–∫—Ä–∞—â–µ–Ω–∏—è –∏ —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—è</h5>`;
        if (data.abbreviations_table && formatTable(data.abbreviations_table).trim()) {
            html += `<h6>3.1 –°–æ–∫—Ä–∞—â–µ–Ω–∏—è</h6>${formatTable(data.abbreviations_table)}`;
        }
        if (data.terminology_table && formatTable(data.terminology_table).trim()) {
            html += `<h6>3.2 –¢–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—è</h6>${formatTable(data.terminology_table)}`;
        }
        html += `<hr>`;
        hasContent = true;
    }
    
    // –†–∞–∑–¥–µ–ª 4: –í–≤–µ–¥–µ–Ω–∏–µ
    if (data.introduction_text && formatText(data.introduction_text).trim()) {
        html += `<h5>4. –í–≤–µ–¥–µ–Ω–∏–µ</h5><div>${formatText(data.introduction_text)}</div><hr>`;
        hasContent = true;
    }
    
    // –†–∞–∑–¥–µ–ª 5: –¶–µ–ª–∏ –∏ –∑–∞–¥–∞—á–∏ –ù–¢
    if ((data.goals_business && formatText(data.goals_business).trim()) || 
        (data.goals_technical && formatText(data.goals_technical).trim()) || 
        (data.tasks_nt && formatText(data.tasks_nt).trim())) {
        html += `<h5>5. –¶–µ–ª–∏ –∏ –∑–∞–¥–∞—á–∏ –ù–¢</h5>`;
        if (data.goals_business && formatText(data.goals_business).trim()) {
            html += `<h6>5.1 –ë–∏–∑–Ω–µ—Å-—Ü–µ–ª–∏</h6><div>${formatList(data.goals_business)}</div>`;
        }
        if (data.goals_technical && formatText(data.goals_technical).trim()) {
            html += `<h6>5.1 –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ü–µ–ª–∏</h6><div>${formatList(data.goals_technical)}</div>`;
        }
        if (data.tasks_nt && formatText(data.tasks_nt).trim()) {
            html += `<h6>5.2 –ó–∞–¥–∞—á–∏ –ù–¢</h6><div>${formatList(data.tasks_nt, true)}</div>`;
        }
        html += `<hr>`;
        hasContent = true;
    }
    
    // –†–∞–∑–¥–µ–ª 6: –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ —Ä–∏—Å–∫–∏ –ù–¢
    if ((data.limitations_list && formatText(data.limitations_list).trim()) || 
        (data.risks_table && formatTable(data.risks_table).trim())) {
        html += `<h5>6. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ —Ä–∏—Å–∫–∏ –ù–¢</h5>`;
        if (data.limitations_list && formatText(data.limitations_list).trim()) {
            html += `<h6>6.1 –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ù–¢</h6><div>${formatList(data.limitations_list, true)}</div>`;
        }
        if (data.risks_table && formatTable(data.risks_table).trim()) {
            html += `<h6>6.2 –†–∏—Å–∫–∏ –ù–¢</h6>${formatTable(data.risks_table)}`;
        }
        html += `<hr>`;
        hasContent = true;
    }
    
    // –†–∞–∑–¥–µ–ª 7: –û–±—ä–µ–∫—Ç –ù–¢
    if ((data.object_general && formatText(data.object_general).trim()) || 
        (data.performance_requirements && formatText(data.performance_requirements).trim()) ||
        (data.component_architecture_text && formatText(data.component_architecture_text).trim()) ||
        (data.information_architecture_text && formatText(data.information_architecture_text).trim())) {
        html += `<h5>7. –û–±—ä–µ–∫—Ç –ù–¢</h5>`;
        if (data.object_general && formatText(data.object_general).trim()) {
            html += `<h6>7.1 –û–±—â–∏–µ —Å–≤–µ–¥–µ–Ω–∏—è</h6><div>${formatText(data.object_general)}</div>`;
        }
        if (data.performance_requirements && formatText(data.performance_requirements).trim()) {
            html += `<h6>7.2 –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</h6><div>${formatList(data.performance_requirements)}</div>`;
        }
        if (data.component_architecture_text && formatText(data.component_architecture_text).trim()) {
            html += `<h6>7.3.1 –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞</h6><div>${formatList(data.component_architecture_text)}</div>`;
        }
        if (data.information_architecture_text && formatText(data.information_architecture_text).trim()) {
            html += `<h6>7.3.2 –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞</h6><div>${formatText(data.information_architecture_text)}</div>`;
        }
        html += `<hr>`;
        hasContent = true;
    }
    
    // –†–∞–∑–¥–µ–ª 8: –¢–µ—Å—Ç–æ–≤—ã–π –∏ –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω—ã–π —Å—Ç–µ–Ω–¥—ã
    if ((data.test_stand_architecture_text && formatText(data.test_stand_architecture_text).trim()) ||
        (data.stand_comparison_table && formatTable(data.stand_comparison_table).trim())) {
        html += `<h5>8. –¢–µ—Å—Ç–æ–≤—ã–π –∏ –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω—ã–π —Å—Ç–µ–Ω–¥—ã</h5>`;
        if (data.test_stand_architecture_text && formatText(data.test_stand_architecture_text).trim()) {
            html += `<h6>8.1 –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å—Ç–µ–Ω–¥–∞</h6><div>${formatText(data.test_stand_architecture_text)}</div>`;
        }
        if (data.stand_comparison_table && formatTable(data.stand_comparison_table).trim()) {
            html += `<h6>8.2 –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π</h6>${formatTable(data.stand_comparison_table)}`;
        }
        html += `<hr>`;
        hasContent = true;
    }
    
    // –†–∞–∑–¥–µ–ª 9: –°—Ç—Ä–∞—Ç–µ–≥–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    if ((data.planned_tests_intro && formatText(data.planned_tests_intro).trim()) ||
        (data.planned_tests_table && formatTable(data.planned_tests_table).trim()) ||
        (data.completion_conditions && formatText(data.completion_conditions).trim())) {
        html += `<h5>9. –°—Ç—Ä–∞—Ç–µ–≥–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h5>`;
        if (data.planned_tests_intro && formatText(data.planned_tests_intro).trim()) {
            html += `<h6>9.1 –û–ø–∏—Å–∞–Ω–∏–µ –ø–ª–∞–Ω–∏—Ä—É–µ–º—ã—Ö —Ç–µ—Å—Ç–æ–≤</h6><div>${formatText(data.planned_tests_intro)}</div>`;
        }
        if (data.planned_tests_table && formatTable(data.planned_tests_table).trim()) {
            html += `${formatTable(data.planned_tests_table)}`;
        }
        if (data.completion_conditions && formatText(data.completion_conditions).trim()) {
            html += `<h6>9.2 –£—Å–ª–æ–≤–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ù–¢</h6><div>${formatList(data.completion_conditions)}</div>`;
        }
        html += `<hr>`;
        hasContent = true;
    }
    
    // –†–∞–∑–¥–µ–ª 10: –ù–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ë–î
    if ((data.database_preparation_text && formatText(data.database_preparation_text).trim()) ||
        (data.database_preparation_table && formatTable(data.database_preparation_table).trim())) {
        html += `<h5>10. –ù–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ë–î</h5>`;
        if (data.database_preparation_text && formatText(data.database_preparation_text).trim()) {
            html += `<div>${formatText(data.database_preparation_text)}</div>`;
        }
        if (data.database_preparation_table && formatTable(data.database_preparation_table).trim()) {
            html += `${formatTable(data.database_preparation_table)}`;
        }
        html += `<hr>`;
        hasContent = true;
    }
    
    // –†–∞–∑–¥–µ–ª 11: –ú–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏
    if ((data.load_modeling_principles && formatText(data.load_modeling_principles).trim()) ||
        (data.load_profiles_intro && formatText(data.load_profiles_intro).trim()) ||
        (data.load_profiles_table && formatTable(data.load_profiles_table).trim()) ||
        (data.use_scenarios_intro && formatText(data.use_scenarios_intro).trim()) ||
        (data.use_scenarios_table && formatTable(data.use_scenarios_table).trim()) ||
        (data.emulators_description && formatText(data.emulators_description).trim())) {
        html += `<h5>11. –ú–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏</h5>`;
        if (data.load_modeling_principles && formatText(data.load_modeling_principles).trim()) {
            html += `<h6>11.1 –û–±—â–∏–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã –º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏</h6><div>${formatText(data.load_modeling_principles)}</div>`;
        }
        if (data.load_profiles_intro && formatText(data.load_profiles_intro).trim()) {
            html += `<h6>11.2 –ü—Ä–æ—Ñ–∏–ª–∏ –Ω–∞–≥—Ä—É–∑–∫–∏</h6><div>${formatText(data.load_profiles_intro)}</div>`;
        }
        if (data.load_profiles_table && formatTable(data.load_profiles_table).trim()) {
            html += `${formatTable(data.load_profiles_table)}`;
        }
        if (data.use_scenarios_intro && formatText(data.use_scenarios_intro).trim()) {
            html += `<h6>11.3 –°—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</h6><div>${formatText(data.use_scenarios_intro)}</div>`;
        }
        if (data.use_scenarios_table && formatTable(data.use_scenarios_table).trim()) {
            html += `${formatTable(data.use_scenarios_table)}`;
        }
        if (data.emulators_description && formatText(data.emulators_description).trim()) {
            html += `<h6>11.4 –û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã —ç–º—É–ª—è—Ç–æ—Ä–æ–≤</h6><div>${formatText(data.emulators_description)}</div>`;
        }
        html += `<hr>`;
        hasContent = true;
    }
    
    // –†–∞–∑–¥–µ–ª 12: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
    if ((data.monitoring_intro && formatText(data.monitoring_intro).trim()) ||
        (data.monitoring_tools_intro && formatText(data.monitoring_tools_intro).trim()) ||
        (data.monitoring_tools_table && formatTable(data.monitoring_tools_table).trim()) ||
        (data.monitoring_tools_note && formatText(data.monitoring_tools_note).trim()) ||
        (data.system_resources_intro && formatText(data.system_resources_intro).trim()) ||
        (data.system_resources_table && formatTable(data.system_resources_table).trim()) ||
        (data.business_metrics_intro && formatText(data.business_metrics_intro).trim()) ||
        (data.business_metrics_table && formatTable(data.business_metrics_table).trim())) {
        html += `<h5>12. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</h5>`;
        if (data.monitoring_intro && formatText(data.monitoring_intro).trim()) {
            html += `<div>${formatText(data.monitoring_intro)}</div>`;
        }
        if (data.monitoring_tools_intro && formatText(data.monitoring_tools_intro).trim()) {
            html += `<h6>12.1 –û–ø–∏—Å–∞–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞</h6><div>${formatText(data.monitoring_tools_intro)}</div>`;
        }
        if (data.monitoring_tools_table && formatTable(data.monitoring_tools_table).trim()) {
            html += `${formatTable(data.monitoring_tools_table)}`;
        }
        if (data.monitoring_tools_note && formatText(data.monitoring_tools_note).trim()) {
            html += `<div>${formatText(data.monitoring_tools_note)}</div>`;
        }
        if ((data.system_resources_intro && formatText(data.system_resources_intro).trim()) ||
            (data.system_resources_table && formatTable(data.system_resources_table).trim())) {
            html += `<h6>12.2.1 –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤</h6>`;
            if (data.system_resources_intro && formatText(data.system_resources_intro).trim()) {
                html += `<div>${formatText(data.system_resources_intro)}</div>`;
            }
            if (data.system_resources_table && formatTable(data.system_resources_table).trim()) {
                html += `${formatTable(data.system_resources_table)}`;
            }
        }
        if ((data.business_metrics_intro && formatText(data.business_metrics_intro).trim()) ||
            (data.business_metrics_table && formatTable(data.business_metrics_table).trim())) {
            html += `<h6>12.2.2 –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –±–∏–∑–Ω–µ—Å-–º–µ—Ç—Ä–∏–∫</h6>`;
            if (data.business_metrics_intro && formatText(data.business_metrics_intro).trim()) {
                html += `<div>${formatText(data.business_metrics_intro)}</div>`;
            }
            if (data.business_metrics_table && formatTable(data.business_metrics_table).trim()) {
                html += `${formatTable(data.business_metrics_table)}`;
            }
        }
        html += `<hr>`;
        hasContent = true;
    }
    
    // –†–∞–∑–¥–µ–ª 13: –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ó–∞–∫–∞–∑—á–∏–∫—É
    if (data.customer_requirements_list && formatText(data.customer_requirements_list).trim()) {
        html += `<h5>13. –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ó–∞–∫–∞–∑—á–∏–∫—É</h5><div>${formatList(data.customer_requirements_list, true)}</div><hr>`;
        hasContent = true;
    }
    
    // –†–∞–∑–¥–µ–ª 14: –ú–∞—Ç–µ—Ä–∏–∞–ª—ã, –ø–æ–¥–ª–µ–∂–∞—â–∏–µ —Å–¥–∞—á–µ
    if ((data.deliverables_intro && formatText(data.deliverables_intro).trim()) ||
        (data.deliverables_table && formatTable(data.deliverables_table).trim()) ||
        (data.deliverables_working_docs_table && formatTable(data.deliverables_working_docs_table).trim())) {
        html += `<h5>14. –ú–∞—Ç–µ—Ä–∏–∞–ª—ã, –ø–æ–¥–ª–µ–∂–∞—â–∏–µ —Å–¥–∞—á–µ</h5>`;
        if (data.deliverables_intro && formatText(data.deliverables_intro).trim()) {
            html += `<div>${formatText(data.deliverables_intro)}</div>`;
        }
        if (data.deliverables_table && formatTable(data.deliverables_table).trim()) {
            html += `${formatTable(data.deliverables_table)}`;
        }
        if (data.deliverables_working_docs_table && formatTable(data.deliverables_working_docs_table).trim()) {
            html += `<h6>–†–∞–±–æ—á–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã (–ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–º –≤–∏–¥–µ):</h6>${formatTable(data.deliverables_working_docs_table)}`;
        }
        html += `<hr>`;
        hasContent = true;
    }
    
    // –†–∞–∑–¥–µ–ª 15: –ö–æ–Ω—Ç–∞–∫—Ç—ã
    if (data.contacts_table && formatTable(data.contacts_table).trim()) {
        html += `<h5>15. –ö–æ–Ω—Ç–∞–∫—Ç—ã</h5>${formatTable(data.contacts_table)}<hr>`;
        hasContent = true;
    }
    
    if (!hasContent) {
        html += `
            <div class="alert alert-warning mt-4 mb-0">
                <strong>‚ö†Ô∏è</strong> –î–∞–Ω–Ω—ã–π –ú–ù–¢ –µ—â–µ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–∑–¥–µ–ª–æ–≤. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã.
            </div>
        `;
    }
    
    html += `</div>`;
    
    return html;
}

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
function formatTable(tableText) {
    if (!tableText || !tableText.trim()) return '';
    
    const lines = tableText.split('\n').filter(line => line.trim());
    if (lines.length === 0) return '';
    
    let html = '<div class="table-responsive"><table class="table table-sm table-bordered">';
    
    for (let i = 0; i < lines.length; i++) {
        const cols = lines[i].split('|').map(col => col.trim());
        if (cols.length === 0) continue;
        
        if (i === 0) {
            // –ó–∞–≥–æ–ª–æ–≤–æ–∫
            html += '<thead><tr>';
            cols.forEach(col => {
                html += `<th>${escapeHtml(col)}</th>`;
            });
            html += '</tr></thead><tbody>';
        } else {
            // –°—Ç—Ä–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö
            html += '<tr>';
            cols.forEach(col => {
                html += `<td>${formatText(col)}</td>`;
            });
            html += '</tr>';
        }
    }
    
    html += '</tbody></table></div>';
    return html;
}

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞
function formatList(listText, ordered = false) {
    if (!listText || !listText.trim()) return '';
    
    const lines = listText.split('\n').filter(line => line.trim());
    if (lines.length === 0) return '';
    
    const tag = ordered ? 'ol' : 'ul';
    let html = `<${tag}>`;
    
    lines.forEach(line => {
        // –£–±–∏—Ä–∞–µ–º –Ω—É–º–µ—Ä–∞—Ü–∏—é –∏–ª–∏ –º–∞—Ä–∫–µ—Ä—ã –µ—Å–ª–∏ –µ—Å—Ç—å
        line = line.replace(/^[\d.]+[\s]*[-‚Ä¢*]?\s*/, '').replace(/^[-‚Ä¢*]\s*/, '');
        if (line.trim()) {
            html += `<li>${escapeHtml(line.trim())}</li>`;
        }
    });
    
    html += `</${tag}>`;
    return html;
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatText(text) {
    if (!text) return '';
    return escapeHtml(text).replace(/\n/g, '<br>');
}

function formatDate(dateStr) {
    if (!dateStr) return 'N/A';
    try {
        const date = new Date(dateStr);
        return date.toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
    } catch {
        return dateStr;
    }
}

function getStatusBadge(status) {
    const badges = {
        'published': '<span class="badge bg-success">‚úì –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ</span>',
        'error': '<span class="badge bg-danger">‚ö† –û—à–∏–±–∫–∞</span>',
        'draft': '<span class="badge bg-warning text-dark">üìù –ß–µ—Ä–Ω–æ–≤–∏–∫</span>'
    };
    return badges[status] || '<span class="badge bg-secondary">' + status + '</span>';
}
</script>

<style>
.mnt-preview-content {
    max-height: 60vh;
    overflow-y: auto;
    padding: 1rem;
}

.mnt-preview-content h5 {
    color: #3b82f6;
    border-bottom: 2px solid #3b82f6;
    padding-bottom: 0.5rem;
    margin-top: 1.5rem;
}

.mnt-preview-content h6 {
    color: #6366f1;
    margin-top: 1rem;
}
</style>

<style>
.tag-badge {
    display: inline-flex;
    align-items: center;
    font-weight: 500;
    border-radius: 4px;
    white-space: nowrap;
}

.tag-badge:hover {
    box-shadow: 0 2px 4px rgba(0,0,0,0.15);
}
</style>
{% endblock %}
