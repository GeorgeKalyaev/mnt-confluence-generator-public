{% extends "base.html" %}

{% block title %}–°–ø–∏—Å–æ–∫ –ú–ù–¢ - –ú–ù–¢ Generator{% endblock %}

{% block content %}
<!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± —É—Å–ø–µ—Ö–µ/–æ—à–∏–±–∫–∞—Ö -->
{% if success_message %}
<div class="alert alert-success alert-dismissible fade show" role="alert">
    {% if success_message == 'created_published' %}
    <strong>‚úì –£—Å–ø–µ—à–Ω–æ!</strong> –ú–ù–¢ —Å–æ–∑–¥–∞–Ω –∏ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω –≤ Confluence.
    {% elif success_message == 'draft_created' %}
    <strong>‚úì –£—Å–ø–µ—à–Ω–æ!</strong> –ú–ù–¢ —Å–æ–∑–¥–∞–Ω –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –∫–∞–∫ —á–µ—Ä–Ω–æ–≤–∏–∫.
    {% elif success_message == 'updated' %}
    <strong>‚úì –£—Å–ø–µ—à–Ω–æ!</strong> –ú–ù–¢ –æ–±–Ω–æ–≤–ª–µ–Ω.
    {% elif success_message == 'updated_published' %}
    <strong>‚úì –£—Å–ø–µ—à–Ω–æ!</strong> –ú–ù–¢ –æ–±–Ω–æ–≤–ª–µ–Ω –∏ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω –≤ Confluence.
    {% elif success_message == 'deleted' %}
    <strong>‚úì –£—Å–ø–µ—à–Ω–æ!</strong> –ú–ù–¢ —É–¥–∞–ª–µ–Ω –∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É. –°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤ Confluence —Ç–∞–∫–∂–µ —É–¥–∞–ª–µ–Ω–∞. –í—ã –º–æ–∂–µ—Ç–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ú–ù–¢ –≤ —Ç–µ—á–µ–Ω–∏–µ 30 –¥–Ω–µ–π –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã.
    {% else %}
    <strong>‚úì –£—Å–ø–µ—à–Ω–æ!</strong> {{ success_message }}
    {% endif %}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}

{% if error_message %}
<div class="alert alert-danger alert-dismissible fade show" role="alert">
    <strong>‚úó –û—à–∏–±–∫–∞!</strong> {{ error_message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>–°–ø–∏—Å–æ–∫ –ú–ù–¢</h1>
    <a href="/mnt/create" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ú–ù–¢</a>
</div>

<!-- –§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫ -->
<form method="get" action="/mnt/list" class="mb-4">
    <div class="card mb-3">
        <div class="card-header">
            <h5 class="mb-0">–§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <!-- –ü–æ–∏—Å–∫ -->
                <div class="col-md-4">
                    <label for="search" class="form-label">–ü–æ–∏—Å–∫</label>
                    <input type="text" 
                           class="form-control" 
                           id="search"
                           name="search" 
                           placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ, –ø—Ä–æ–µ–∫—Ç, –∞–≤—Ç–æ—Ä..." 
                           value="{{ search_query }}">
                </div>
                
                <!-- –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É -->
                <div class="col-md-2">
                    <label for="status" class="form-label">–°—Ç–∞—Ç—É—Å</label>
                    <select class="form-select" id="status" name="status">
                        <option value="">–í—Å–µ</option>
                        <option value="draft" {% if status_filter == 'draft' %}selected{% endif %}>–ß–µ—Ä–Ω–æ–≤–∏–∫</option>
                        <option value="published" {% if status_filter == 'published' %}selected{% endif %}>–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ</option>
                        <option value="error" {% if status_filter == 'error' %}selected{% endif %}>–û—à–∏–±–∫–∞</option>
                    </select>
                </div>
                
                <!-- –§–∏–ª—å—Ç—Ä –ø–æ –∞–≤—Ç–æ—Ä—É -->
                <div class="col-md-2">
                    <label for="author" class="form-label">–ê–≤—Ç–æ—Ä</label>
                    <input type="text" 
                           class="form-control" 
                           id="author"
                           name="author" 
                           placeholder="–ò–º—è –∞–≤—Ç–æ—Ä–∞..." 
                           value="{{ author_filter }}">
                </div>
                
                <!-- –§–∏–ª—å—Ç—Ä –ø–æ —Ç–µ–≥—É -->
                <div class="col-md-2">
                    <label for="tag_id" class="form-label">–¢–µ–≥</label>
                    <select class="form-select" id="tag_id" name="tag_id">
                        <option value="">–í—Å–µ</option>
                        {% for tag in tags %}
                        <option value="{{ tag.name }}" {% if tag_filter == tag.name %}selected{% endif %}>{{ tag.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ -->
                <div class="col-md-2">
                    <label for="sort_by" class="form-label">–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ</label>
                    <select class="form-select" id="sort_by" name="sort_by">
                        <option value="created_at" {% if sort_by == 'created_at' %}selected{% endif %}>–î–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è</option>
                        <option value="updated_at" {% if sort_by == 'updated_at' %}selected{% endif %}>–ü–æ—Å–ª–µ–¥–Ω–µ–º—É –∏–∑–º–µ–Ω–µ–Ω–∏—é</option>
                        <option value="title" {% if sort_by == 'title' %}selected{% endif %}>–ù–∞–∑–≤–∞–Ω–∏—é</option>
                        <option value="project" {% if sort_by == 'project' %}selected{% endif %}>–ü—Ä–æ–µ–∫—Ç—É</option>
                        <option value="author" {% if sort_by == 'author' %}selected{% endif %}>–ê–≤—Ç–æ—Ä—É</option>
                        <option value="status" {% if sort_by == 'status' %}selected{% endif %}>–°—Ç–∞—Ç—É—Å—É</option>
                    </select>
                </div>
                
                <!-- –ü–æ—Ä—è–¥–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ -->
                <div class="col-md-2">
                    <label for="sort_order" class="form-label">–ü–æ—Ä—è–¥–æ–∫</label>
                    <select class="form-select" id="sort_order" name="sort_order">
                        <option value="desc" {% if sort_order == 'desc' %}selected{% endif %}>–ü–æ —É–±—ã–≤–∞–Ω–∏—é</option>
                        <option value="asc" {% if sort_order == 'asc' %}selected{% endif %}>–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</option>
                    </select>
                </div>
            </div>
            
            <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ -->
            <input type="hidden" name="page" value="1" id="page_input">
            
            <div class="mt-3">
                <button type="submit" class="btn btn-primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
                {% if search_query or status_filter or author_filter or tag_filter %}
                <a href="/mnt/list" class="btn btn-outline-secondary">–°–±—Ä–æ—Å–∏—Ç—å</a>
                {% endif %}
            </div>
        </div>
    </div>
</form>

<div class="alert alert-info">
    –í—Å–µ–≥–æ –ú–ù–¢: <strong>{{ total }}</strong>
    {% if search_query or status_filter or author_filter or tag_filter %}
    (–Ω–∞–π–¥–µ–Ω–æ –ø–æ —Ñ–∏–ª—å—Ç—Ä–∞–º)
    {% endif %}
    {% if total_pages > 1 %}
    | –°—Ç—Ä–∞–Ω–∏—Ü–∞ <strong>{{ current_page }}</strong> –∏–∑ <strong>{{ total_pages }}</strong>
    {% endif %}
</div>

{% if documents %}
<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>ID</th>
                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th>–ü—Ä–æ–µ–∫—Ç</th>
                <th>–ê–≤—Ç–æ—Ä</th>
                <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                <th>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>Confluence</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody>
            {% for doc in documents %}
            <tr>
                <td>{{ doc.id }}</td>
                <td>
                    <div class="d-flex align-items-center gap-2 flex-wrap">
                        <strong>{{ doc.title }}</strong>
                        {% if doc.tags %}
                        <div class="d-flex gap-1 flex-wrap">
                            {% for tag in doc.tags %}
                            <a href="?tag_id={{ tag.name|urlencode }}{% if search_query %}&search={{ search_query|urlencode }}{% endif %}{% if status_filter %}&status={{ status_filter|urlencode }}{% endif %}{% if author_filter %}&author={{ author_filter|urlencode }}{% endif %}{% if sort_by %}&sort_by={{ sort_by|urlencode }}{% endif %}{% if sort_order %}&sort_order={{ sort_order|urlencode }}{% endif %}" 
                               class="badge bg-primary text-decoration-none tag-badge" 
                               style="font-size: 0.75em; padding: 0.35em 0.65em; cursor: pointer; transition: all 0.2s;"
                               onmouseover="this.style.opacity='0.8'; this.style.transform='scale(1.05)'"
                               onmouseout="this.style.opacity='1'; this.style.transform='scale(1)'"
                               title="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ —Ç–µ–≥—É: {{ tag.name }}">
                                {{ tag.name }}
                            </a>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% if doc.last_error %}
                    <br><small class="text-danger" title="–û—à–∏–±–∫–∞: {{ doc.last_error }}">‚ö† {{ doc.last_error[:50] }}{% if doc.last_error|length > 50 %}...{% endif %}</small>
                    {% endif %}
                </td>
                <td>{{ doc.project }}</td>
                <td>{{ doc.author }}</td>
                <td>{{ doc.created_at.strftime('%d.%m.%Y %H:%M') if doc.created_at else '-' }}</td>
                <td>{{ doc.updated_at.strftime('%d.%m.%Y %H:%M') if doc.updated_at else '-' }}</td>
                <td>
                    {% if doc.status == 'published' %}
                        <span class="badge bg-success">‚úì –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ</span>
                        {% if doc.confluence_page_url %}
                            <br><small class="text-muted">
                                –ü–æ—Å–ª–µ–¥–Ω—è—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è: 
                                {% if doc.last_publish_at %}
                                    {{ doc.last_publish_at.strftime('%d.%m.%Y %H:%M') }}
                                {% elif doc.updated_at %}
                                    {{ doc.updated_at.strftime('%d.%m.%Y %H:%M') }} (–ø—Ä–∏–º–µ—Ä–Ω–æ)
                                {% else %}
                                    N/A
                                {% endif %}
                            </small>
                            {# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –Ω–µ–æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è #}
                            {% if doc.last_publish_at and doc.updated_at and doc.updated_at > doc.last_publish_at %}
                                <small class="fw-bold" style="color: #8B0000;">‚ö† –ï—Å—Ç—å –Ω–µ–æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è!</small>
                            {% elif doc.updated_at and not doc.last_publish_at %}
                                <small class="fw-bold" style="color: #8B0000;">‚ö† –í–æ–∑–º–æ–∂–Ω–æ –µ—Å—Ç—å –Ω–µ–æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è</small>
                            {% endif %}
                        {% endif %}
                    {% elif doc.status == 'error' %}
                        <span class="badge bg-danger">‚ö† –û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏</span>
                    {% else %}
                        <span class="badge bg-warning text-dark">üìù –ß–µ—Ä–Ω–æ–≤–∏–∫</span>
                        {% if doc.confluence_page_id %}
                            <br><small class="text-info">‚ö† –†–∞–Ω–µ–µ –±—ã–ª –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω, –Ω–æ –µ—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è</small>
                        {% endif %}
                    {% endif %}
                </td>
                <td>
                    {% if doc.confluence_page_url %}
                        <a href="{{ doc.confluence_page_url }}" target="_blank" class="btn btn-sm btn-link">–û—Ç–∫—Ä—ã—Ç—å</a>
                    {% else %}
                        <span class="text-muted">–ù–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ</span>
                    {% endif %}
                </td>
                <td>
                    <div class="btn-group" role="group">
                        <a href="/mnt/{{ doc.id }}/edit" class="btn btn-sm btn-outline-primary">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                        <a href="/mnt/{{ doc.id }}/history" class="btn btn-sm btn-outline-secondary" title="–ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π">üìã</a>
                        <form method="post" action="/mnt/{{ doc.id }}/delete" style="display: inline;" 
                              onsubmit="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ú–ù–¢?\\n\\n–°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤ Confluence –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞, –Ω–æ –ú–ù–¢ –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤ —Ç–µ—á–µ–Ω–∏–µ 30 –¥–Ω–µ–π –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã.');">
                            <button type="submit" class="btn btn-sm btn-outline-danger" title="–£–¥–∞–ª–∏—Ç—å –ú–ù–¢">üóëÔ∏è</button>
                        </form>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
{% if total_pages > 1 %}
<nav aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º">
    <ul class="pagination justify-content-center">
        {% if has_prev %}
        <li class="page-item">
            <a class="page-link" href="?page={{ current_page - 1 }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if author_filter %}&author={{ author_filter }}{% endif %}{% if tag_filter %}&tag_id={{ tag_filter }}{% endif %}{% if sort_by %}&sort_by={{ sort_by }}{% endif %}{% if sort_order %}&sort_order={{ sort_order }}{% endif %}">–ü—Ä–µ–¥—ã–¥—É—â–∞—è</a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <span class="page-link">–ü—Ä–µ–¥—ã–¥—É—â–∞—è</span>
        </li>
        {% endif %}
        
        {% for page_num in range(1, total_pages + 1) %}
            {% if page_num == current_page %}
            <li class="page-item active">
                <span class="page-link">{{ page_num }}</span>
            </li>
            {% elif page_num <= 3 or page_num > total_pages - 3 or (page_num >= current_page - 1 and page_num <= current_page + 1) %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_num }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if author_filter %}&author={{ author_filter }}{% endif %}{% if tag_filter %}&tag_id={{ tag_filter }}{% endif %}{% if sort_by %}&sort_by={{ sort_by }}{% endif %}{% if sort_order %}&sort_order={{ sort_order }}{% endif %}">{{ page_num }}</a>
            </li>
            {% elif page_num == 4 or page_num == total_pages - 3 %}
            <li class="page-item disabled">
                <span class="page-link">...</span>
            </li>
            {% endif %}
        {% endfor %}
        
        {% if has_next %}
        <li class="page-item">
            <a class="page-link" href="?page={{ current_page + 1 }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if author_filter %}&author={{ author_filter }}{% endif %}{% if tag_filter %}&tag_id={{ tag_filter }}{% endif %}{% if sort_by %}&sort_by={{ sort_by }}{% endif %}{% if sort_order %}&sort_order={{ sort_order }}{% endif %}">–°–ª–µ–¥—É—é—â–∞—è</a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <span class="page-link">–°–ª–µ–¥—É—é—â–∞—è</span>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

{% else %}
<div class="alert alert-warning">
    –ú–ù–¢ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. <a href="/mnt/create">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π –ú–ù–¢</a>.
</div>
{% endif %}

<style>
.tag-badge {
    display: inline-flex;
    align-items: center;
    font-weight: 500;
    border-radius: 4px;
    white-space: nowrap;
}

.tag-badge:hover {
    box-shadow: 0 2px 4px rgba(0,0,0,0.15);
}
</style>
{% endblock %}
