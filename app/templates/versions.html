{% extends "base.html" %}

{% block title %}–ò—Å—Ç–æ—Ä–∏—è –≤–µ—Ä—Å–∏–π –ú–ù–¢ - –ú–ù–¢ Generator{% endblock %}

{% block breadcrumbs %}
    <nav aria-label="breadcrumb" class="bg-light border-bottom py-2">
        <div class="container-fluid">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="/">–ì–ª–∞–≤–Ω–∞—è</a></li>
                <li class="breadcrumb-item"><a href="/mnt/list">–°–ø–∏—Å–æ–∫ –ú–ù–¢</a></li>
                <li class="breadcrumb-item"><a href="/mnt/{{ document.id }}/edit">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ú–ù–¢</a></li>
                <li class="breadcrumb-item active">–ò—Å—Ç–æ—Ä–∏—è –≤–µ—Ä—Å–∏–π</li>
            </ol>
        </div>
    </nav>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>–ò—Å—Ç–æ—Ä–∏—è –≤–µ—Ä—Å–∏–π –ú–ù–¢</h1>
        <a href="/mnt/{{ document.id }}/edit" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥ –∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—é</a>
    </div>
    
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ–∫—É–º–µ–Ω—Ç–µ</h5>
        </div>
        <div class="card-body">
            <p><strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> {{ document.title }}</p>
            <p><strong>–ü—Ä–æ–µ–∫—Ç:</strong> {{ document.project }}</p>
            <p><strong>–ê–≤—Ç–æ—Ä:</strong> {{ document.author }}</p>
            <p><strong>–°—Ç–∞—Ç—É—Å:</strong> 
                {% if document.status == 'published' %}
                    <span class="badge bg-success">‚úì –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ</span>
                {% elif document.status == 'error' %}
                    <span class="badge bg-danger">‚ö† –û—à–∏–±–∫–∞</span>
                {% else %}
                    <span class="badge bg-warning text-dark">üìù –ß–µ—Ä–Ω–æ–≤–∏–∫</span>
                {% endif %}
            </p>
        </div>
    </div>
    
    {% if versions %}
    <!-- –§–æ—Ä–º–∞ –¥–ª—è –≤—ã–±–æ—Ä–∞ –¥–≤—É—Ö –≤–µ—Ä—Å–∏–π –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–π</h5>
        </div>
        <div class="card-body">
            <form method="get" action="/mnt/{{ document.id }}/compare" class="row g-3">
                <div class="col-md-5">
                    <label for="version1_id" class="form-label">–í–µ—Ä—Å–∏—è 1 (—Å—Ç–∞—Ä–∞—è):</label>
                    <select class="form-select" id="version1_id" name="version1_id" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–µ—Ä—Å–∏—é...</option>
                        {% for version in all_versions %}
                        <option value="{{ version.id }}">–í–µ—Ä—Å–∏—è {{ version.version_number }} ({{ version.created_at.strftime('%d.%m.%Y %H:%M') if version.created_at else 'N/A' }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-5">
                    <label for="version2_id" class="form-label">–í–µ—Ä—Å–∏—è 2 (–Ω–æ–≤–∞—è):</label>
                    <select class="form-select" id="version2_id" name="version2_id" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–µ—Ä—Å–∏—é...</option>
                        {% for version in all_versions %}
                        <option value="{{ version.id }}">–í–µ—Ä—Å–∏—è {{ version.version_number }} ({{ version.created_at.strftime('%d.%m.%Y %H:%M') if version.created_at else 'N/A' }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">üîç –°—Ä–∞–≤–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">–í–µ—Ä—Å–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–≤—Å–µ–≥–æ: {{ total }})</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th style="width: 10%;">–í–µ—Ä—Å–∏—è</th>
                            <th style="width: 15%;">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                            <th style="width: 15%;">–ê–≤—Ç–æ—Ä</th>
                            <th style="width: 10%;">–°—Ç–∞—Ç—É—Å</th>
                            <th style="width: 20%;">Confluence</th>
                            <th style="width: 30%;">–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for version in versions %}
                        <tr>
                            <td><strong>{{ version.version_number }}</strong></td>
                            <td>{{ version.created_at.strftime('%d.%m.%Y %H:%M') if version.created_at else 'N/A' }}</td>
                            <td>{{ version.created_by or version.author }}</td>
                            <td>
                                {% if version.status == 'published' %}
                                    <span class="badge bg-success">–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ</span>
                                {% elif version.status == 'error' %}
                                    <span class="badge bg-danger">–û—à–∏–±–∫–∞</span>
                                {% else %}
                                    <span class="badge bg-warning text-dark">–ß–µ—Ä–Ω–æ–≤–∏–∫</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if version.confluence_page_url %}
                                    <a href="{{ version.confluence_page_url }}" target="_blank" class="btn btn-sm btn-link p-0">
                                        –û—Ç–∫—Ä—ã—Ç—å –≤ Confluence
                                    </a>
                                {% else %}
                                    <span class="text-muted">‚Äî</span>
                                {% endif %}
                            </td>
                            <td>
                                <button type="button" 
                                        class="btn btn-outline-warning btn-sm" 
                                        onclick="confirmRestore({{ version.id }}, '{{ version.version_number }}')"
                                        title="–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —ç—Ç—É –≤–µ—Ä—Å–∏—é">
                                    ‚Üª –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
    {% if total_pages > 1 %}
    <nav aria-label="–ü–∞–≥–∏–Ω–∞—Ü–∏—è –≤–µ—Ä—Å–∏–π" class="mt-4">
        <ul class="pagination justify-content-center">
            {% if has_prev %}
            <li class="page-item">
                <a class="page-link" href="?page={{ current_page - 1 }}">–ü—Ä–µ–¥—ã–¥—É—â–∞—è</a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <span class="page-link">–ü—Ä–µ–¥—ã–¥—É—â–∞—è</span>
            </li>
            {% endif %}
            
            {% for page_num in range(1, total_pages + 1) %}
                {% if page_num == current_page %}
                <li class="page-item active">
                    <span class="page-link">{{ page_num }}</span>
                </li>
                {% elif page_num <= 3 or page_num > total_pages - 3 or (page_num >= current_page - 1 and page_num <= current_page + 1) %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_num }}">{{ page_num }}</a>
                </li>
                {% elif page_num == 4 or page_num == total_pages - 3 %}
                <li class="page-item disabled">
                    <span class="page-link">...</span>
                </li>
                {% endif %}
            {% endfor %}
            
            {% if has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ current_page + 1 }}">–°–ª–µ–¥—É—é—â–∞—è</a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <span class="page-link">–°–ª–µ–¥—É—é—â–∞—è</span>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
    
    {% else %}
    <div class="alert alert-info">
        <strong>‚ÑπÔ∏è</strong> –ò—Å—Ç–æ—Ä–∏—è –≤–µ—Ä—Å–∏–π –ø—É—Å—Ç–∞. –í–µ—Ä—Å–∏–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–ª–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –ú–ù–¢.
    </div>
    {% endif %}
</div>

<!-- –§–æ—Ä–º–∞ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –≤–µ—Ä—Å–∏–∏ -->
<form id="restoreForm" method="post" action="" style="display: none;">
</form>

<script>
function confirmRestore(versionId, versionNumber) {
    if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–µ—Ä—Å–∏—é ${versionNumber}?\n\n–¢–µ–∫—É—â–∏–µ –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã.`)) {
        const form = document.getElementById('restoreForm');
        form.action = `/mnt/{{ document.id }}/versions/${versionId}/restore`;
        form.submit();
    }
}
</script>
{% endblock %}
