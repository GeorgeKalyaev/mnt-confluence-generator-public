{% extends "base.html" %}

{% block title %}–ò—Å—Ç–æ—Ä–∏—è –≤–µ—Ä—Å–∏–π - {{ document.title }} - –ú–ù–¢ Generator{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1>–ò—Å—Ç–æ—Ä–∏—è –≤–µ—Ä—Å–∏–π –ú–ù–¢</h1>
        <p class="text-muted mb-0">–ü—Ä–æ–µ–∫—Ç: <strong>{{ document.project }}</strong></p>
    </div>
    <div>
        <button id="compare-btn" class="btn btn-primary me-2" style="display: none;" onclick="compareVersions()">
            üîç –°—Ä–∞–≤–Ω–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –≤–µ—Ä—Å–∏–∏
        </button>
        <a href="/mnt/{{ document.id }}/edit" class="btn btn-outline-secondary">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—é</a>
    </div>
</div>

{% if versions %}
<div class="table-responsive">
    <table class="table table-striped">
        <thead>
            <tr>
                <th>–í–µ—Ä—Å–∏—è</th>
                <th>–î–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è</th>
                <th>–ê–≤—Ç–æ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏—è</th>
                <th>–ü—Ä–∏—á–∏–Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody>
            {% for version in versions %}
            <tr>
                <td><strong>v{{ version.version_number }}</strong></td>
                <td>{{ version.created_at.strftime('%d.%m.%Y %H:%M') if version.created_at else '-' }}</td>
                <td>{{ version.changed_by or '-' }}</td>
                <td>{{ version.change_reason or '-' }}</td>
                <td>
                    <div class="btn-group" role="group">
                        <input type="checkbox" class="btn-check version-checkbox" 
                               id="version-{{ version.id }}" 
                               value="{{ version.id }}"
                               data-version="{{ version.version_number }}">
                        <label class="btn btn-sm btn-outline-secondary" for="version-{{ version.id }}">
                            –í—ã–±—Ä–∞—Ç—å –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
                        </label>
                        <a href="/mnt/{{ document.id }}/version/{{ version.id }}/preview" 
                           class="btn btn-sm btn-outline-info"
                           target="_blank">
                            üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä
                        </a>
                        <a href="/mnt/{{ document.id }}/version/{{ version.id }}/restore" 
                           class="btn btn-sm btn-outline-primary"
                           onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —ç—Ç—É –≤–µ—Ä—Å–∏—é? –¢–µ–∫—É—â–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã.')">
                            ‚Üª –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                        </a>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="alert alert-info">
    –ò—Å—Ç–æ—Ä–∏—è –≤–µ—Ä—Å–∏–π –ø—É—Å—Ç–∞. –í–µ—Ä—Å–∏–∏ –±—É–¥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π.
</div>
{% endif %}

<script>
// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—ã–±–æ—Ä–æ–º –≤–µ—Ä—Å–∏–π –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('.version-checkbox');
    const compareBtn = document.getElementById('compare-btn');
    
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const selected = document.querySelectorAll('.version-checkbox:checked');
            if (selected.length === 2) {
                compareBtn.style.display = 'inline-block';
            } else {
                compareBtn.style.display = 'none';
            }
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤—ã–±–æ—Ä –¥–≤—É–º—è –≤–µ—Ä—Å–∏—è–º–∏
            if (selected.length > 2) {
                this.checked = false;
            }
        });
    });
});

function compareVersions() {
    const selected = Array.from(document.querySelectorAll('.version-checkbox:checked'))
        .map(cb => cb.value);
    
    if (selected.length !== 2) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–≤–Ω–æ 2 –≤–µ—Ä—Å–∏–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è');
        return;
    }
    
    const documentId = {{ document.id }};
    window.location.href = `/mnt/${documentId}/versions/compare?v1=${selected[0]}&v2=${selected[1]}`;
}
</script>
{% endblock %}
