"""Шаблоны данных для автозаполнения МНТ на основе тегов"""
from typing import Dict, Any, List, Optional
from app.utils.defaults import *


# Шаблоны данных для разных тегов
TAG_TEMPLATES: Dict[str, Dict[str, Any]] = {
    "Претрейд": {
        "description": "Шаблон для претрейд проектов",
        "data": {
            # Специфичные сокращения для претрейд
            "abbreviations_table": """МНТ|Методика нагрузочного тестирования
Претрейд|Предторговый период
RPS|Число запросов в секунду
SLA|Соглашение об уровне обслуживания
API|Application Programming Interface
REST|Representational State Transfer
JSON|JavaScript Object Notation""",
            
            # Специфичные риски для претрейд
            "risks_table": """Риск|Вероятность возникновения|Влияние
Нестабильность тестового стенда в период претрейд|Средняя|Сроки НТ
Изменение бизнес-логики в период претрейд|Высокая|Объем работ
Невозможность получения репрезентативных данных|Средняя|Качество тестирования""",
            
            # Специфичные цели для претрейд
            "goals_business": """Целями нагрузочного тестирования в период претрейд являются:
• Оценить готовность торговой системы к реальной торговой нагрузке
• Определить предельные возможности системы по обработке торговых операций в период претрейд
• Обеспечить соответствие системы требованиям к производительности согласно SLA для торговых операций
• Минимизировать риски потери торговых данных и снижения качества обслуживания участников торгов
• Подтвердить возможность масштабирования системы для будущего роста нагрузки в период реальной торговли""",
            
            # Специфичные задачи для претрейд
            "tasks_nt": """1. Разработать и согласовать методику нагрузочного тестирования торговой системы в период претрейд.
2. Составить профиль нагрузки на торговую систему на основе прогнозируемой интенсивности торговых операций.
3. Разработать средства НТ для эмуляции торговых операций и подготовить тестовую среду.
4. При необходимости разработать эмуляторы внешних систем, взаимодействующих с торговой системой.
5. Установить и настроить систему мониторинга торговых операций и системных метрик.
6. Проанализировать данные претрейд периода для определения целей тестирования и профиля нагрузки.
7. Провести тесты НТ для различных сценариев торговой нагрузки.
8. Проанализировать проведенные тесты и составить отчёт с рекомендациями для периода реальной торговли.""",
        }
    },
    
    "Микросервис": {
        "description": "Шаблон для микросервисной архитектуры",
        "data": {
            # Специфичные сокращения для микросервисов
            "abbreviations_table": """МНТ|Методика нагрузочного тестирования
API|Application Programming Interface
REST|Representational State Transfer
gRPC|Google Remote Procedure Call
MQ|Message Queue
K8s|Kubernetes
LB|Load Balancer
SLA|Соглашение об уровне обслуживания""",
            
            # Специфичные риски для микросервисов
            "risks_table": """Риск|Вероятность возникновения|Влияние
Нестабильность взаимодействия между микросервисами|Средняя|Качество тестирования
Проблемы с балансировкой нагрузки|Низкая|Производительность
Задержки в цепочке вызовов микросервисов|Высокая|Время отклика
Перегрузка отдельных микросервисов|Средняя|Стабильность системы""",
            
            # Специфичные цели для микросервисов
            "goals_business": """Целями нагрузочного тестирования микросервисной архитектуры являются:
• Оценить готовность микросервисной системы к пиковым нагрузкам
• Определить предельные возможности каждого микросервиса и системы в целом
• Обеспечить соответствие системы требованиям к производительности согласно SLA
• Выявить узкие места в цепочках взаимодействия микросервисов
• Подтвердить эффективность балансировки нагрузки между экземплярами микросервисов
• Оценить масштабируемость отдельных микросервисов""",
        }
    },
    
    "Тестирование": {
        "description": "Общий шаблон для тестирования",
        "data": {
            # Дополнительные сокращения для тестирования
            "abbreviations_table": """МНТ|Методика нагрузочного тестирования
QA|Quality Assurance
SLA|Соглашение об уровне обслуживания
RPS|Число запросов в секунду
VU|Виртуальный пользователь
RT|Response Time
TPS|Transactions Per Second""",
            
            # Дополнительные риски для тестирования
            "risks_table": """Риск|Вероятность возникновения|Влияние
Недостаточность тестовых данных|Средняя|Качество тестирования
Изменение требований в процессе тестирования|Средняя|Сроки НТ
Нестабильность тестовой среды|Низкая|Результаты тестирования""",
        }
    },
}


def get_template_data_for_tags(tags: List[str]) -> Dict[str, Any]:
    """
    Получить данные шаблона на основе списка тегов.
    Если тег не найден, возвращает пустой словарь.
    
    Args:
        tags: Список тегов (например, ["Претрейд", "Микросервис"])
    
    Returns:
        Словарь с данными для автозаполнения, объединенными из всех подходящих шаблонов
    """
    if not tags:
        return {}
    
    result = {}
    
    # Обходим все теги и собираем данные из соответствующих шаблонов
    for tag in tags:
        tag_normalized = tag.strip()
        if tag_normalized in TAG_TEMPLATES:
            template_data = TAG_TEMPLATES[tag_normalized]["data"]
            # Объединяем данные (последний шаблон имеет приоритет)
            for key, value in template_data.items():
                result[key] = value
    
    return result


def get_available_templates() -> Dict[str, Dict[str, Any]]:
    """Получить список всех доступных шаблонов"""
    return {
        tag: {
            "description": template["description"],
            "keys": list(template["data"].keys())
        }
        for tag, template in TAG_TEMPLATES.items()
    }


def apply_template_to_data(data: Dict[str, Any], tags: List[str], overwrite: bool = False) -> Dict[str, Any]:
    """
    Применить шаблон данных к существующим данным.
    
    Args:
        data: Существующие данные МНТ
        tags: Список тегов
        overwrite: Если True, перезаписывает существующие поля. Если False, заполняет только пустые.
    
    Returns:
        Обновленные данные
    """
    template_data = get_template_data_for_tags(tags)
    
    if not template_data:
        return data
    
    result = data.copy()
    
    for key, value in template_data.items():
        if overwrite:
            # Всегда применяем шаблон
            result[key] = value
        else:
            # Применяем только если поле пустое или отсутствует
            current_value = result.get(key, "").strip()
            if not current_value:
                result[key] = value
    
    return result
